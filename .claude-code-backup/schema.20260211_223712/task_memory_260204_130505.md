# Task: å®ç° Memory Storage ç³»ç»Ÿï¼ˆç´¢å¼• + Markdown é•¿æœŸè®°å¿†ï¼‰

**ä»»åŠ¡ID**: task_memory_260204_130505
**åˆ›å»ºæ—¶é—´**: 2026-02-04
**çŠ¶æ€**: å·²å®Œæˆ âœ…
**ç›®æ ‡**: ä¸º Krebs æ·»åŠ ç±»ä¼¼ openclaw-cn-ds çš„ Memory Storage ç³»ç»Ÿï¼Œæ”¯æŒ SQLite ç´¢å¼•ã€å‘é‡æœç´¢ã€Markdown é•¿æœŸè®°å¿†ç®¡ç†

---

## æœ€ç»ˆç›®æ ‡

æ„å»ºä¸€ä¸ªæ¨¡å—åŒ–çš„ Memory Storage ç³»ç»Ÿï¼Œæ ¸å¿ƒèƒ½åŠ›åŒ…æ‹¬ï¼š
1. ğŸ—„ï¸ **SQLite ç´¢å¼•**ï¼šæ–‡ä»¶çº§å“ˆå¸Œæ ¡éªŒï¼Œæ”¯æŒå¢é‡æ›´æ–°
2. ğŸ” **å‘é‡æœç´¢**ï¼šä½¿ç”¨æœ¬åœ° Embedding Providerï¼ˆå¦‚ Ollamaï¼‰
3. ğŸ“ **Markdown é•¿æœŸè®°å¿†**ï¼šè‡ªåŠ¨ç®¡ç† `workspace/memory/` ç›®å½•
4. ğŸ”¨ **æ™ºèƒ½åˆ†å—**ï¼šæŒ‰ token æ•°åˆ†å‰²ï¼Œæ”¯æŒ overlap
5. ğŸ‘€ **å®æ—¶ç›‘å¬**ï¼šä½¿ç”¨ chokidar ç›‘å¬æ–‡ä»¶å˜åŒ–ï¼Œè‡ªåŠ¨æ›´æ–°ç´¢å¼•

---

## æ‹†è§£æ­¥éª¤

### é˜¶æ®µ1ï¼šæ ¸å¿ƒåŸºç¡€è®¾æ–½ âš™ï¸

#### 1.1 å®‰è£…ä¾èµ–
- [ ] å®‰è£… SQLite ç›¸å…³ä¾èµ–ï¼ˆ`better-sqlite3` æˆ– `node:sqlite`ï¼‰
- [ ] å®‰è£…å‘é‡æ‰©å±•ï¼ˆ`sqlite-vec` æˆ–å…¼å®¹æ–¹æ¡ˆï¼‰
- [ ] å®‰è£…æ–‡ä»¶ç›‘å¬åº“ï¼ˆ`chokidar`ï¼‰- âœ… å®æ—¶ç›‘å¬å¿…éœ€
- [ ] å®‰è£… Markdown è§£æåº“ï¼ˆå¦‚éœ€å¢å¼ºï¼‰

#### 1.2 è®¾è®¡æ•°æ®æ¨¡å‹
- [ ] å®šä¹‰ `MemorySchema` æ¥å£ï¼ˆfiles, chunks, fts, embedding_cacheï¼‰
- [ ] å®šä¹‰ `MemoryChunk` ç±»å‹ï¼ˆstartLine, endLine, text, hashï¼‰
- [ ] å®šä¹‰ `MemoryFileEntry` ç±»å‹ï¼ˆpath, hash, mtime, sizeï¼‰
- [ ] å®šä¹‰ `EmbeddingProvider` æ¥å£

#### 1.3 å®ç°å·¥å…·å‡½æ•°
- [ ] `hashText()`: SHA256 å“ˆå¸Œè®¡ç®—
- [ ] `chunkMarkdown()`: æ™ºèƒ½åˆ†å—ï¼ˆæ”¯æŒ token å’Œ overlapï¼‰
- [ ] `listMemoryFiles()`: æ‰«æ workspace/memory/ ç›®å½•
- [ ] `buildFileEntry()`: æ„å»ºæ–‡ä»¶å…ƒä¿¡æ¯

---

### é˜¶æ®µ2ï¼šSQLite ç´¢å¼•å±‚ ğŸ—„ï¸

#### 2.1 å®ç°æ•°æ®åº“æ¶æ„
- [ ] åˆ›å»º `ensureMemoryIndexSchema()` å‡½æ•°
- [ ] å®šä¹‰ files è¡¨ï¼ˆpath, source, hash, mtime, sizeï¼‰
- [ ] å®šä¹‰ chunks è¡¨ï¼ˆid, path, source, start_line, end_line, hash, model, text, embeddingï¼‰
- [ ] å®šä¹‰ embedding_cache è¡¨ï¼ˆprovider, model, hash, embeddingï¼‰
- [ ] åˆ›å»ºå¿…è¦çš„ç´¢å¼•ï¼ˆidx_chunks_path, idx_chunks_sourceï¼‰

#### 2.2 å®ç°å‘é‡æœç´¢
- [ ] é›†æˆ `sqlite-vec` æ‰©å±•
- [ ] å®ç° `searchVector()` å‡½æ•°ï¼ˆä½™å¼¦ç›¸ä¼¼åº¦ï¼‰
- [ ] å®ç° FTS5 å…¨æ–‡æœç´¢ï¼ˆå¯é€‰ï¼‰
- [ ] å®ç°æ··åˆæœç´¢ï¼ˆBM25 + å‘é‡ï¼Œå¯é€‰ï¼‰

---

### é˜¶æ®µ3ï¼šEmbedding Provider ğŸ”Œ

#### 3.1 è®¾è®¡æœ¬åœ° Embedding æ¥å£
- [ ] å®šä¹‰ `ILocalEmbeddingProvider` æ¥å£
- [ ] å®ç° `OllamaEmbeddingProvider`ï¼ˆæ¨èæœ¬åœ°æ–¹æ¡ˆï¼‰
- [ ] å®ç° `OpenAIEmbeddingProvider`ï¼ˆå¤‡ç”¨è¿œç¨‹æ–¹æ¡ˆï¼‰
- [ ] å®ç° Embedding ç¼“å­˜æœºåˆ¶

#### 3.2 æ‰¹å¤„ç†æ”¯æŒ
- [ ] å®ç° `batchEmbed()` å‡½æ•°ï¼ˆæ‰¹é‡ç”Ÿæˆå‘é‡ï¼‰
- [ ] å®ç°å¹¶å‘æ§åˆ¶ï¼ˆé¿å… API é™æµï¼‰
- [ ] å®ç°é”™è¯¯é‡è¯•æœºåˆ¶

---

### é˜¶æ®µ4ï¼šMemory Manager æ ¸å¿ƒé€»è¾‘ ğŸ§ 

#### 4.1 å®ç° MemoryIndexManager
- [ ] æ„é€ å‡½æ•°ï¼šåˆå§‹åŒ– SQLite è¿æ¥ã€Embedding Provider
- [ ] å®ç° `sync()` æ–¹æ³•ï¼šå¢é‡åŒæ­¥å˜æ›´æ–‡ä»¶
- [ ] å®ç° `indexFile()` æ–¹æ³•ï¼šç´¢å¼•å•ä¸ªæ–‡ä»¶ï¼ˆåˆ†å— + embeddingï¼‰
- [ ] å®ç° `reindex()` æ–¹æ³•ï¼šå…¨é‡é‡å»ºç´¢å¼•
- [ ] å®ç°æ–‡ä»¶å“ˆå¸Œæ ¡éªŒï¼šé¿å…é‡å¤ç´¢å¼•

#### 4.2 å®ç°æœç´¢åŠŸèƒ½
- [ ] å®ç° `search()` æ–¹æ³•ï¼šå‘é‡æœç´¢
- [ ] å®ç° `searchKeyword()` æ–¹æ³•ï¼šå…³é”®è¯æœç´¢ï¼ˆå¯é€‰ï¼‰
- [ ] å®ç° `searchHybrid()` æ–¹æ³•ï¼šæ··åˆæœç´¢ï¼ˆå¯é€‰ï¼‰
- [ ] è¿”å›ç»“æœæ ¼å¼ï¼š`{ path, startLine, endLine, score, snippet }`

---

### é˜¶æ®µ5ï¼šå®æ—¶ç›‘å¬ä¸æ–‡ä»¶åŒæ­¥ ğŸ‘€

#### 5.1 æ–‡ä»¶åŒæ­¥é€»è¾‘
- [ ] å®ç° `syncMemoryFiles()` å‡½æ•°
- [ ] æ‰«æ `workspace/memory/` ç›®å½•
- [ ] å¯¹æ¯”æ–‡ä»¶å“ˆå¸Œï¼Œè¯†åˆ«å˜æ›´
- [ ] åˆ é™¤å·²ç§»é™¤æ–‡ä»¶çš„ç´¢å¼•

#### 5.2 å®æ—¶ç›‘å¬ï¼ˆchokidarï¼‰
- [ ] ä½¿ç”¨ `chokidar` ç›‘å¬ `workspace/memory/` ç›®å½•
- [ ] ç›‘å¬äº‹ä»¶ï¼š`add`, `change`, `unlink`
- [ ] å®ç°å»æŠ–åŠ¨é€»è¾‘ï¼ˆdebounce 5ç§’ï¼‰
- [ ] å®ç° `enableWatch()` / `disableWatch()` æ–¹æ³•
- [ ] å®ç° `start()` / `stop()` ç”Ÿå‘½å‘¨æœŸç®¡ç†

---

### é˜¶æ®µ6ï¼šé›†æˆåˆ° Krebs æ¶æ„ ğŸ”—

#### 6.1 æ‰©å±• Storage æ¥å£
- [ ] å®šä¹‰ `IMemoryStorage` æ¥å£
- [ ] æ·»åŠ åˆ° `AgentDeps` ä¾èµ–æ³¨å…¥
- [ ] æ›´æ–° `AgentManager` æ”¯æŒ Memory Storage

#### 6.2 æä¾› CLI/API æ¥å£
- [ ] CLI: `npm run memory:watch` - å¯åŠ¨ç›‘å¬æ¨¡å¼
- [ ] CLI: `npm run memory:reindex` - å…¨é‡é‡å»º
- [ ] API: `GET /memory/search?q=xxx` - æœç´¢
- [ ] API: `POST /memory/sync` - æ‰‹åŠ¨åŒæ­¥

---

### é˜¶æ®µ7ï¼šæµ‹è¯•ä¸æ–‡æ¡£ âœ…

#### 7.1 å•å…ƒæµ‹è¯•
- [ ] æµ‹è¯• `chunkMarkdown()` å‡½æ•°
- [ ] æµ‹è¯• `hashText()` å‡½æ•°
- [ ] æµ‹è¯• `MemoryIndexManager` æ ¸å¿ƒé€»è¾‘
- [ ] æµ‹è¯•æ–‡ä»¶ç›‘å¬åŠŸèƒ½

#### 7.2 é›†æˆæµ‹è¯•
- [ ] æµ‹è¯•å®Œæ•´çš„ç´¢å¼•æµç¨‹
- [ ] æµ‹è¯•æœç´¢åŠŸèƒ½
- [ ] æµ‹è¯•å®æ—¶ç›‘å¬ï¼ˆæ¨¡æ‹Ÿæ–‡ä»¶å˜åŒ–ï¼‰

#### 7.3 æ–‡æ¡£
- [ ] æ›´æ–° `production.md` æ·»åŠ  Memory Storage è¯´æ˜
- [ ] åˆ›å»ºä½¿ç”¨ç¤ºä¾‹æ–‡æ¡£
- [ ] æ›´æ–° README

---

## å½“å‰è¿›åº¦

### å·²å®Œæˆ: æ‰€æœ‰é˜¶æ®µ âœ…

**å·²å®ç°åŠŸèƒ½**ï¼š
1. âœ… æ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼ˆä¾èµ–å®‰è£…ã€ç±»å‹å®šä¹‰ã€å·¥å…·å‡½æ•°ï¼‰
2. âœ… SQLite ç´¢å¼•å±‚æ¶æ„ï¼ˆæ•°æ®åº“è¡¨ã€ç´¢å¼•ã€è¿ç§»æ”¯æŒï¼‰
3. âœ… Embedding Providerï¼ˆOllama æœ¬åœ° + OpenAI è¿œç¨‹å¤‡ç”¨ï¼‰
4. âœ… MemoryIndexManager æ ¸å¿ƒé€»è¾‘ï¼ˆç´¢å¼•ã€æœç´¢ã€åŒæ­¥ï¼‰
5. âœ… å®æ—¶ç›‘å¬ï¼ˆchokidarï¼‰å’Œæ–‡ä»¶åŒæ­¥ï¼ˆdebounce ä¼˜åŒ–ï¼‰
6. âœ… é›†æˆåˆ° Krebs æ¶æ„ï¼ˆæ¥å£å®šä¹‰ã€å¯¼å‡ºï¼‰
7. âœ… æµ‹è¯•æ–‡ä»¶ï¼ˆåŸºç¡€åŠŸèƒ½éªŒè¯ï¼‰
8. âœ… æ–‡æ¡£ï¼ˆproduction.md æ›´æ–° + ä½¿ç”¨æŒ‡å—ï¼‰

**å…³é”®è®¾è®¡å†³ç­–**ï¼š
- âœ… æ•°æ®åº“ï¼šSQLite (better-sqlite3)
- âœ… Embedding Providerï¼šæœ¬åœ° Ollamaï¼ˆnomic-embed-textï¼‰
- âœ… å­˜å‚¨ä½ç½®ï¼š`workspace/memory/` ç›®å½•
- âœ… ç´¢å¼•ç­–ç•¥ï¼š**å®æ—¶ç›‘å¬ï¼ˆchokidarï¼‰** - æ–‡ä»¶å˜åŒ–è‡ªåŠ¨æ›´æ–°ç´¢å¼•ï¼ˆdebounce 5ç§’ï¼‰

**å·²åˆ›å»ºæ–‡ä»¶**ï¼š
- âœ… `src/storage/memory/types.ts` - ç±»å‹å®šä¹‰
- âœ… `src/storage/memory/internal.ts` - å·¥å…·å‡½æ•°
- âœ… `src/storage/memory/schema.ts` - æ•°æ®åº“æ¶æ„
- âœ… `src/storage/memory/embeddings.ts` - Embedding Provider
- âœ… `src/storage/memory/manager.ts` - æ ¸å¿ƒç®¡ç†å™¨
- âœ… `src/storage/memory/index.ts` - æ¨¡å—å…¥å£
- âœ… `test/storage/memory/basic.test.ts` - æµ‹è¯•æ–‡ä»¶
- âœ… `docs/memory-storage-guide.md` - ä½¿ç”¨æŒ‡å—
- âœ… æ›´æ–° `src/storage/interface.ts` - æ·»åŠ  IMemoryStorage
- âœ… æ›´æ–° `src/storage/index.ts` - å¯¼å‡º Memory Storage
- âœ… æ›´æ–° `production.md` - é¡¹ç›®æ–‡æ¡£

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼ˆå¯é€‰æ‰©å±•ï¼‰

### é«˜çº§åŠŸèƒ½
1. **å‘é‡æœç´¢å®ç°**ï¼šé›†æˆ sqlite-vec å®ç°çœŸæ­£çš„å‘é‡ç›¸ä¼¼åº¦æœç´¢
2. **å…¨æ–‡æœç´¢**ï¼šé›†æˆ FTS5 å…¨æ–‡æœç´¢
3. **æ··åˆæœç´¢**ï¼šç»“åˆ BM25 å’Œå‘é‡çš„æ··åˆæœç´¢
4. **ä¼šè¯ç´¢å¼•**ï¼šæ”¯æŒç´¢å¼•ä¼šè¯è®°å½•ï¼ˆä¸ä»…æ˜¯ memory æ–‡ä»¶ï¼‰

### æ€§èƒ½ä¼˜åŒ–
1. **æ‰¹é‡æ“ä½œä¼˜åŒ–**ï¼šæ”¹è¿› Embedding æ‰¹å¤„ç†æ€§èƒ½
2. **å¹¶å‘æ§åˆ¶**ï¼šæ›´ç²¾ç»†çš„å¹¶å‘é™åˆ¶å’Œé”™è¯¯æ¢å¤
3. **ç¼“å­˜ç­–ç•¥**ï¼šä¼˜åŒ– Embedding ç¼“å­˜å¤±æ•ˆç­–ç•¥

### ç”¨æˆ·ä½“éªŒ
1. **CLI å·¥å…·**ï¼šæä¾›å‘½ä»¤è¡Œå·¥å…·ï¼ˆ`npm run memory:sync` ç­‰ï¼‰
2. **å¯è§†åŒ–ç•Œé¢**ï¼šWeb UI æŸ¥çœ‹æœç´¢ç»“æœ
3. **å¯¼å…¥å¯¼å‡º**ï¼šæ”¯æŒå¯¼å…¥å¯¼å‡ºè®°å¿†æ–‡ä»¶

---

## æŠ€æœ¯å‚è€ƒ

### æ ¸å¿ƒå‚è€ƒæ–‡ä»¶ï¼ˆopenclaw-cn-dsï¼‰
- `/Users/zack/Desktop/openclaw-cn-ds/src/memory/memory-schema.ts` - æ•°æ®åº“æ¶æ„
- `/Users/zack/Desktop/openclaw-cn-ds/src/memory/internal.ts` - å·¥å…·å‡½æ•°
- `/Users/zack/Desktop/openclaw-cn-ds/src/memory/manager.ts` - æ ¸å¿ƒç®¡ç†å™¨ï¼ˆåŒ…å« chokidar å®ç°ï¼‰
- `/Users/zack/Desktop/openclaw-cn-ds/src/memory/sync-memory-files.ts` - æ–‡ä»¶åŒæ­¥é€»è¾‘
- `/Users/zack/Desktop/openclaw-cn-ds/src/memory/embeddings.ts` - Embedding Provider

### Krebs ç°æœ‰æ–‡ä»¶
- `/Users/zack/Desktop/Krebs/src/storage/interface.ts` - å­˜å‚¨æ¥å£
- `/Users/zack/Desktop/Krebs/src/storage/markdown/store.ts` - Markdown Store

---

## æ³¨æ„äº‹é¡¹

1. **ä¿æŒæ¨¡å—åŒ–**ï¼šMemory Storage ä½œä¸ºç‹¬ç«‹æ¨¡å—ï¼Œä¸ç ´åç°æœ‰æ¶æ„
2. **æ¥å£é©±åŠ¨**ï¼šå®šä¹‰æ¸…æ™°çš„æ¥å£ï¼ˆ`IMemoryStorage`ï¼‰ï¼Œä¾¿äºæ›¿æ¢å®ç°
3. **å¯é€‰ä¾èµ–**ï¼šEmbedding åŠŸèƒ½å¯é€‰ï¼Œä¸å¼ºåˆ¶ä¾èµ–è¿œç¨‹ API
4. **å‘åå…¼å®¹**ï¼šä¸ç ´åç°æœ‰çš„ `SessionStore` å’Œ `MarkdownStore`
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ‰¹é‡æ“ä½œã€å¹¶å‘æ§åˆ¶ã€ç¼“å­˜æœºåˆ¶
6. **å®æ—¶ç›‘å¬ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨ debounce é¿å…é¢‘ç¹è§¦å‘ç´¢å¼•
   - ç›‘å¬å™¨é”™è¯¯æ¢å¤æœºåˆ¶
   - èµ„æºæ¸…ç†ï¼ˆ`stop()` æ—¶å…³é—­ watcherï¼‰
