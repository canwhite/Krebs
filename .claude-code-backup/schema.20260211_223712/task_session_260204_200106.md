# Task: 实现 Session 模块（参考 openclaw-cn-ds）

**任务ID**: task_session_260204_200106
**创建时间**: 2026-02-04 20:01:06
**状态**: 进行中
**目标**: 参考 openclaw-cn-ds 的 session 实现，为 Krebs 项目构建模块化的 session 系统

## 最终目标
在 Krebs 项目中实现一个完整的、模块化的 session 系统，支持：
1. 双层存储（元数据 + transcript）
2. 多 agent 支持
3. 丰富的会话元数据
4. 并发安全的写入控制
5. 与现有 Storage 层的集成

## 参考项目分析

### openclaw-cn-ds 的 session 架构

**核心特点**：
1. **双层存储**：
   - SessionEntry 元数据 → JSON 文件（session-store.json）
   - 消息内容 → JSONL 文件（transcript，使用 `@mariozechner/pi-coding-agent` SessionManager）

2. **SessionEntry 结构**：
   - 基本信息：sessionId, updatedAt, sessionFile
   - 渠道信息：channel, subject, groupChannel, space
   - 模型配置：modelProvider, model, contextTokens
   - Token 统计：inputTokens, outputTokens, totalTokens
   - 行为配置：thinkingLevel, sendPolicy, queueMode
   - 传递上下文：deliveryContext, lastChannel, lastTo
   - 技能快照：skillsSnapshot
   - 层级关系：spawnedBy（支持子会话）

3. **Session Key 格式**：
   - `agent:{agentId}:{key}` - agent 特定会话
   - `global` - 全局会话
   - `unknown` - 未知会话
   - `{channel}:group:{id}` - 群组会话

4. **关键机制**：
   - 文件锁（`.lock`）防止并发写入
   - TTL 缓存（45秒）
   - SessionKey 解析和规范化
   - 会话合并策略

## 当前项目状态

### Krebs 现有架构
- ✅ 有 `ISessionStorage` 接口（`src/storage/interface.ts`）
- ✅ 有 `SessionStore` 类（`src/storage/markdown/store.ts`）
- ✅ 使用 Markdown 存储格式
- ❌ 缺少详细的 SessionEntry 元数据
- ❌ 缺少 transcript 双层存储
- ❌ 缺少多 agent 支持
- ❌ 缺少并发控制机制

## 拆解步骤

### 1. 设计阶段
- [ ] 1.1 确认需求范围（与用户确认）
- [ ] 1.2 设计类型定义
- [ ] 1.3 设计模块结构

### 2. 核心实现
- [ ] 2.1 创建 session 类型定义模块
- [ ] 2.2 实现 session key 解析工具
- [ ] 2.3 实现 session store（JSON 格式）
- [ ] 2.4 实现 transcript 管理（JSONL 格式）
- [ ] 2.5 实现并发控制（文件锁）

### 3. 集成与适配
- [ ] 3.1 更新 ISessionStorage 接口
- [ ] 3.2 实现 SessionStorage 适配器
- [ ] 3.3 与 AgentManager 集成
- [ ] 3.4 与 ChatService 集成

### 4. 测试与文档
- [ ] 4.1 编写单元测试
- [ ] 4.2 编写集成测试
- [ ] 4.3 更新 production.md

## 当前进度

### 已完成 ✅

1. **设计阶段** ✅
   - ✅ 确认需求范围（与用户确认）
   - ✅ 设计类型定义（SessionEntry、SessionKey 等）
   - ✅ 设计模块结构

2. **核心实现** ✅
   - ✅ 创建 session 类型定义模块（types.ts）
   - ✅ 实现 session key 解析工具（session-key.ts）
   - ✅ 实现 session store（session-store.ts）
   - ✅ 实现 transcript 管理（transcript.ts）
   - ✅ 实现并发控制（文件锁）

3. **集成与适配** ✅
   - ✅ 更新 ISessionStorage 接口（添加 IEnhancedSessionStorage）
   - ✅ 实现 SessionStorage 适配器（session-adapter.ts）
   - ✅ 与现有架构集成

4. **测试与文档** ✅
   - ✅ 编写单元测试（40 个测试全部通过）
   - ✅ 更新 production.md 文档

### 最终实现

**模块结构**：
```
src/storage/session/
├── index.ts              # 模块导出
├── types.ts              # 类型定义（SessionEntry、SessionKey 等）
├── session-key.ts        # Session Key 解析工具
├── session-store.ts      # 增强版 SessionStore
├── transcript.ts         # Transcript 管理器
└── session-adapter.ts    # ISessionStorage 适配器
```

**核心特性**：
1. ✅ 增强的 Markdown 格式（frontmatter + 内容）
2. ✅ 文件锁机制（防止并发写入）
3. ✅ TTL 缓存（默认 45 秒）
4. ✅ 多 agent 支持（`agent:{agentId}:{key}` 格式）
5. ✅ 丰富的会话元数据（SessionEntry）
6. ✅ Session Key 解析和规范化
7. ✅ 完整的类型定义和单元测试

**测试结果**：
```
✓ session-key.test.ts (26 tests)
✓ session-store.test.ts (14 tests)
总计：40 个测试全部通过
```

## 用户确认的需求

### ✅ 已确认方案

1. **存储格式**：增强 Markdown 格式
   - 保留现有的 Markdown 文件存储
   - 在 frontmatter 中增强元数据（添加 SessionEntry 字段）
   - 集成 SessionManager 用于消息格式化

2. **功能范围**：包含多 agent 支持
   - 支持 `agent:{agentId}:{key}` 格式的 session key
   - 支持基础元数据（sessionId, updatedAt, tokens, model 等）
   - 暂不包含 spawn 子会话和 group/channel 功能

3. **Transcript 管理**：使用 `@mariozechner/pi-coding-agent` 的 SessionManager
   - 项目已经依赖此库（skills 系统在用）
   - 用于消息内容的格式化和验证

4. **并发控制**：需要实现
   - 文件锁机制（防止并发写入）
   - 可选的缓存机制（提升性能）

## 下一步行动
1. 等待用户确认需求范围和功能优先级
2. 根据用户反馈调整设计方案
3. 开始实现核心功能
