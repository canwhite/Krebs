# Task: 添加 web_search/web_fetch 工具

**任务ID**: task_web_tools_260205_223021
**创建时间**: 2026-02-05
**状态**: 进行中
**目标**: 类比 openclaw-cn-ds 实现 web_search 和 web_fetch 工具，并集成到整个工具系统

## 最终目标

实现完整的 Web 工具功能，使 Agent 能够：
1. 搜索网络信息（web_search）
2. 抓取网页内容（web_fetch）
3. 与现有工具系统无缝集成
4. 支持 DeepSeek/OpenAI/Anthropic 平台适配

## 拆解步骤

### 1. 研究参考实现
- [ ] 分析 openclaw-cn-ds 的 web-search.ts
- [ ] 分析 openclaw-cn-ds 的 web-fetch.ts
- [ ] 理解工具结构和 API 调用方式

### 2. 实现 web_search 工具
- [ ] 创建 src/agent/tools/web-search.ts
- [ ] 实现 Brave Search API 集成
- [ ] 实现 Perplexity API 集成（可选）
- [ ] 添加缓存支持
- [ ] 添加错误处理

### 3. 实现 web_fetch 工具
- [ ] 创建 src/agent/tools/web-fetch.ts
- [ ] 实现网页内容抓取
- [ ] 添加 Readability 支持（可选）
- [ ] 添加 SSRF 防护
- [ ] 添加超时控制

### 4. 更新工具注册
- [ ] 在 getBuiltinTools() 中添加新工具
- [ ] 更新工具分组（group:web）
- [ ] 更新工具配置文件

### 5. 平台适配器测试
- [ ] 测试 DeepSeek 格式转换
- [ ] 测试 OpenAI 格式转换
- [ ] 测试 Anthropic 格式转换

### 6. 集成测试
- [ ] 创建测试脚本
- [ ] 测试工具策略过滤
- [ ] 测试实际搜索功能
- [ ] 测试错误处理

### 7. 文档更新
- [ ] 更新 TOOLS_SYSTEM.md
- [ ] 添加使用示例
- [ ] 添加 API Key 配置说明

## 当前进度

### 正在进行: 文档更新

已完成 Web 工具的实现和集成，正在更新文档。

## 实施记录

### ✅ 已完成的工作

1. **实现 web_search 工具** (`src/agent/tools/web.ts`)
   - ✅ 支持 Brave Search API
   - ✅ 支持结果缓存（5分钟）
   - ✅ 支持参数：query, count, country, search_lang, freshness
   - ✅ 返回结构化搜索结果

2. **实现 web_fetch 工具** (`src/agent/tools/web.ts`)
   - ✅ 支持网页内容抓取
   - ✅ HTML 到 Markdown/Text 转换
   - ✅ URL 验证和 SSRF 防护
   - ✅ 超时控制（15秒）

3. **集成到工具系统**
   - ✅ 更新 `getBuiltinTools()` 自动注册
   - ✅ 条件注册（需要 API Key）
   - ✅ 导出到 `src/agent/tools/index.ts`

4. **测试验证**
   - ✅ 创建测试脚本 `test/test-web-tools.ts`
   - ✅ 验证工具注册逻辑
   - ✅ 验证平台适配器
   - ✅ 验证 API Key 检查

### 关键特性

- **智能注册**: 只在配置 API Key 时才注册 web 工具
- **缓存机制**: 5分钟缓存，避免重复请求
- **错误处理**: 详细的错误信息和建议
- **平台适配**: 自动转换为 DeepSeek/OpenAI/Anthropic 格式
- **URL 验证**: SSRF 防护，只允许 HTTP/HTTPS

### 使用方法

```bash
# 1. 设置 API Key
export BRAVE_API_KEY='your-api-key'

# 2. Agent 会自动启用 web_search 和 web_fetch 工具

# 3. 测试
npx tsx test/test-web-tools.ts
```

## 下一步行动

1. ✅ 所有功能已完成
2. ⏳ 可选：添加 Perplexity API 支持
3. ⏳ 可选：添加更高级的 HTML 解析（Readability）
4. ⏳ 可选：添加 Firecrawl 集成
