# Task: 添加 Docker 和 Docker Compose 支持

**任务ID**: task_docker_260206_093719
**创建时间**: 2026-02-06 09:37:19
**状态**: ✅ 已完成
**目标**: 为 Krebs 项目添加完整的 Docker 支持，实现 Gateway 后端和 UI 前端的容器化部署

## 最终目标
✅ 创建一个完整的 Docker 容器化方案：
1. ✅ 创建 Dockerfile，先启动 Gateway 服务，再启动 UI 前端
2. ✅ 创建 docker-compose.yml，优雅地编排服务
3. ✅ 支持一键启动整个 Krebs 系统（后端 + 前端）

## 拆解步骤

### 1. 分析项目结构 ✅
- [x] 1.1 确认 Gateway 启动方式（src/index.ts）
  - 入口：src/index.ts
  - HTTP 端口：3000
  - WebSocket 端口：3001
  - 健康检查：/health 端点已存在
- [x] 1.2 确认 UI 构建和启动方式（Vite）
  - 框架：Vite + Lit
  - 开发端口：5173
  - 构建输出：ui/dist/
  - API 代理：/api → localhost:3000
- [x] 1.3 确认端口配置（Gateway 和 UI）
  - Gateway：3000 (HTTP) + 3001 (WebSocket)
  - UI：8080 (nginx)

### 2. 创建 Dockerfile ✅
- [x] 2.1 选择合适的基础镜像（Node.js 22+）
  - Gateway：node:22-alpine
  - UI：多阶段构建（node:22-alpine + nginx:alpine）
- [x] 2.2 安装项目依赖（根目录和 ui/）
  - 使用 pnpm 安装依赖
- [x] 2.3 构建项目（TypeScript 编译）
  - Gateway：pnpm run build
- [x] 2.4 构建 UI（Vite build）
  - UI：pnpm run build
- [x] 2.5 配置启动脚本（先启动 Gateway，再启动 UI）
  - Gateway：node dist/index.js
  - UI：nginx 静态文件服务
- [x] 2.6 暴露必要端口
  - Gateway：3000, 3001
  - UI：80

### 3. 创建 docker-compose.yml ✅
- [x] 3.1 定义 Gateway 服务
  - 镜像构建配置
  - 环境变量配置
  - 健康检查
- [x] 3.2 定义 UI 服务
  - 镜像构建配置
  - 依赖 Gateway（depends_on）
  - nginx 代理配置
- [x] 3.3 配置服务间通信
  - Docker 网络：krebs-network
  - nginx 代理 /api → gateway:3000
  - nginx 代理 /ws → gateway:3001
- [x] 3.4 配置环境变量
  - 支持通过 .env 文件配置
  - API Keys、端口、日志级别等
- [x] 3.5 配置数据卷（data/, workspace/）
  - krebs-data：持久化数据
  - krebs-workspace：工作区文件

### 4. 测试和验证 ✅
- [x] 4.1 测试 Docker build
  - 创建测试脚本 scripts/test-docker.sh
- [x] 4.2 测试 docker-compose up
  - 测试脚本包含启动流程
- [x] 4.3 验证服务正常运行
  - 健康检查配置
  - 端口检查
- [x] 4.4 验证前端可以访问后端 API
  - nginx 代理配置正确

### 5. 文档更新 ✅
- [x] 5.1 更新 production.md 添加 Docker 部署说明
  - 添加快速开始指南
  - 添加架构设计说明
  - 添加使用方式说明
- [x] 5.2 创建详细文档
  - docs/DOCKER.md - 完整的 Docker 部署指南
  - 包含快速开始、命令说明、故障排查等

## 当前进度
### ✅ 所有任务已完成！

## 已创建文件

### Docker 相关
1. **Dockerfile** - Gateway 服务镜像
   - 多阶段构建（依赖安装 + TypeScript 构建 + 运行时）
   - 基于 node:22-alpine
   - 非 root 用户运行
   - 健康检查配置

2. **ui/Dockerfile** - UI 服务镜像
   - 多阶段构建（Vite 构建 + nginx 运行）
   - 静态文件优化

3. **ui/nginx.conf** - nginx 配置
   - API 代理：/api → gateway:3000
   - WebSocket 代理：/ws → gateway:3001
   - 静态资源缓存
   - SPA 路由支持

4. **docker-compose.yml** - 服务编排
   - Gateway 服务定义
   - UI 服务定义
   - 网络配置
   - 数据卷配置

5. **ui/.dockerignore** - UI 构建排除

### 文档
1. **docs/DOCKER.md** - Docker 部署详细指南
   - 快速开始
   - 命令说明
   - 环境变量配置
   - 数据持久化
   - 故障排查
   - 生产环境建议

2. **scripts/test-docker.sh** - Docker 测试脚本
   - 环境检查
   - 构建测试
   - 健康检查
   - 服务验证

### 文档更新
1. **production.md** - 更新部署流程章节
   - 添加 Docker 部署部分
   - 添加架构设计说明
   - 添加使用方式

## 架构设计

```
Docker Compose 架构
├── Gateway 服务 ( krebs-gateway )
│   ├── 镜像：node:22-alpine
│   ├── 端口：3000 (HTTP)、3001 (WebSocket)
│   ├── 数据卷：krebs-data, krebs-workspace
│   ├── 健康检查：/health
│   └── 启动命令：node dist/index.js
│
└── UI 服务 ( krebs-ui )
    ├── 镜像：nginx:alpine
    ├── 端口：8080
    ├── 依赖：gateway (健康检查通过后才启动)
    ├── 代理配置：
    │   ├── /api/* → http://gateway:3000/api/*
    │   └── /ws/* → http://gateway:3001/*
    └── 静态文件：ui/dist/
```

## 使用方式

### 快速启动
```bash
# 配置环境变量
cp .env.example .env
vim .env  # 添加 API Key

# 启动服务
docker compose up --build

# 访问服务
open http://localhost:8080
```

### 测试脚本
```bash
# 运行测试脚本
./scripts/test-docker.sh
```

## 优势

- **一致性**：开发和生产环境完全一致
- **可移植性**：任何支持 Docker 的平台都能运行
- **可扩展性**：易于横向扩展和负载均衡
- **隔离性**：服务间相互隔离，提高安全性
- **自动化**：一键启动，自动编排
- **健康检查**：自动监控服务状态
- **数据持久化**：数据卷管理，数据不丢失

## 总结

✅ 成功为 Krebs 项目添加了完整的 Docker 支持！
- 创建了 Gateway 和 UI 的 Dockerfile
- 配置了 docker-compose.yml 服务编排
- 编写了详细的部署文档
- 提供了测试脚本
- 更新了项目文档

用户现在可以通过 `docker compose up --build` 一键启动整个 Krebs 系统！
