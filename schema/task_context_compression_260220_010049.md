# Task: ä¸Šä¸‹æ–‡å‹ç¼©ä¸æ‘˜è¦æœºåˆ¶ç ”ç©¶

**ä»»åŠ¡ID**: task_context_compression_260220_010049
**åˆ›å»ºæ—¶é—´**: 2026-02-20
**çŠ¶æ€**: è¿›è¡Œä¸­
**ç›®æ ‡**: å®ç°ä¸ä¸¢å¤±å…³é”®ä¿¡æ¯çš„ä¸Šä¸‹æ–‡å‹ç¼©æœºåˆ¶ï¼Œè§£å†³é•¿å¯¹è¯ä¸­çš„æ³¨æ„åŠ›å’Œ token æ¶ˆè€—é—®é¢˜

## æœ€ç»ˆç›®æ ‡
è®¾è®¡å¹¶å®ç°ä¸€ä¸ªé«˜æ•ˆçš„ä¸Šä¸‹æ–‡å‹ç¼©ç³»ç»Ÿï¼Œåœ¨ä¿ç•™å…³é”®ä¿¡æ¯çš„å‰æä¸‹ï¼Œå°†é•¿å¯¹è¯å†å²å‹ç¼©ä¸ºç®€æ´çš„æ‘˜è¦æˆ–å…³é”®æ¶ˆæ¯åˆ—è¡¨ã€‚

## é—®é¢˜èƒŒæ™¯

### å½“å‰é—®é¢˜
1. **token æ¶ˆè€—å¤§**ï¼šæ¯æ¬¡å¯¹è¯éƒ½ä¼ å…¥å®Œæ•´å†å²ï¼ˆå·²éªŒè¯ï¼šç¬¬3è½®å¯¹è¯ä¼ å…¥6æ¡æ¶ˆæ¯ï¼‰
2. **æ³¨æ„åŠ›åˆ†æ•£**ï¼šLLM éœ€è¦å¤„ç†å¤§é‡æ— å…³ä¿¡æ¯
3. **æˆæœ¬é«˜**ï¼šé•¿å¯¹è¯ä¸­ token ä½¿ç”¨é‡çº¿æ€§å¢é•¿
4. **æ€§èƒ½å·®**ï¼šè¶…è¿‡æ¨¡å‹ä¸Šä¸‹æ–‡çª—å£æ—¶ä¼šå‡ºé”™

### å‚è€ƒé¡¹ç›®åˆ†æï¼ˆåŸºäº production.mdï¼‰

**openclaw-cn-ds** é¡¹ç›®çš„è§£å†³æ–¹æ¡ˆï¼š
- ä½¿ç”¨ `transcript.ts` ç®¡ç†ä¼šè¯ï¼ˆJSONL æ ¼å¼ï¼‰
- è‡ªåŠ¨å‹ç¼©ï¼šå½“æ¥è¿‘ token é™åˆ¶æ—¶è§¦å‘
- æ™ºèƒ½æ‘˜è¦ï¼šä¿ç•™æœ€è¿‘ N æ¡æ¶ˆæ¯ + å†å²æ‘˜è¦
- å‚è€ƒ `src/agent/core/agent.ts` ç¬¬ 605-633 è¡Œçš„ `compactIfNeeded` æ–¹æ³•

**å½“å‰é¡¹ç›®å·²æœ‰çš„åŸºç¡€**ï¼š
- âœ… `compactMessages` å·¥å…·å‡½æ•°ï¼ˆ`src/utils/compaction.ts`ï¼‰
- âœ… `estimateMessagesTokens` å·¥å…·å‡½æ•°ï¼ˆ`src/utils/token-estimator.ts`ï¼‰
- âœ… `getModelContextWindow` å·¥å…·å‡½æ•°ï¼ˆ`src/utils/model-context.ts`ï¼‰
- âœ… Agent ä¸­å·²å®ç° `compactIfNeeded` æ–¹æ³•

## æŠ€æœ¯æ–¹æ¡ˆç ”ç©¶

### æ–¹æ¡ˆ 1ï¼šæ»‘åŠ¨çª—å£ï¼ˆSliding Windowï¼‰
**åŸç†**ï¼šåªä¿ç•™æœ€è¿‘çš„ N æ¡æ¶ˆæ¯

**ä¼˜ç‚¹**ï¼š
- å®ç°ç®€å•
- æ€§èƒ½å¯é¢„æµ‹
- æˆæœ¬å¯æ§

**ç¼ºç‚¹**ï¼š
- âŒ ä¸¢å¤±æ—©æœŸé‡è¦ä¿¡æ¯
- âŒ æ— æ³•å¤„ç†é•¿ç¨‹ä¾èµ–

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
const keepRecentCount = 20;
const messagesForLLM = [
  ...history.slice(-keepRecentCount),  // åªä¿ç•™æœ€è¿‘20æ¡
  userMessage,
];
```

### æ–¹æ¡ˆ 2ï¼šæ™ºèƒ½æ‘˜è¦ï¼ˆSummarizationï¼‰
**åŸç†**ï¼šå°†æ—§æ¶ˆæ¯æ‘˜è¦ä¸ºä¸€æ¡ system æ¶ˆæ¯

**ä¼˜ç‚¹**ï¼š
- âœ… ä¿ç•™å…³é”®ä¿¡æ¯
- âœ… æ˜¾è‘—å‡å°‘ token æ•°é‡
- âœ… ä¿æŒä¸Šä¸‹æ–‡è¿è´¯æ€§

**ç¼ºç‚¹**ï¼š
- éœ€è¦é¢å¤–çš„ LLM è°ƒç”¨ï¼ˆæˆæœ¬ï¼‰
- æ‘˜è¦è´¨é‡å–å†³äºæ¨¡å‹
- å®ç°å¤æ‚åº¦ä¸­ç­‰

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
// 1. åˆ†å‰²æ¶ˆæ¯
const recentMessages = history.slice(-20);  // æœ€è¿‘20æ¡
const oldMessages = history.slice(0, -20);  // æ—§æ¶ˆæ¯

// 2. ç”Ÿæˆæ‘˜è¦
const summary = await llm.summarize(oldMessages);

// 3. æ„å»ºæ¶ˆæ¯åˆ—è¡¨
const messagesForLLM = [
  systemMessage,
  { role: "system", content: `[å†å²å¯¹è¯æ‘˜è¦]\n${summary}` },
  ...recentMessages,
  userMessage,
];
```

### æ–¹æ¡ˆ 3ï¼šè¯­ä¹‰æ£€ç´¢ + å…³é”®æ¶ˆæ¯ï¼ˆSemantic Retrievalï¼‰
**åŸç†**ï¼šåŸºäºå½“å‰æŸ¥è¯¢æ£€ç´¢ç›¸å…³çš„å†å²æ¶ˆæ¯

**ä¼˜ç‚¹**ï¼š
- âœ… ä¸Šä¸‹æ–‡ç›¸å…³æ€§é«˜
- âœ… åªä¼ é€’ç›¸å…³ä¿¡æ¯
- âœ… å¯ä¸ Memory System ç»“åˆ

**ç¼ºç‚¹**ï¼š
- éœ€è¦åµŒå…¥æ¨¡å‹ï¼ˆæˆæœ¬ï¼‰
- å®ç°å¤æ‚åº¦é«˜
- å¯èƒ½é—æ¼é‡è¦ç»†èŠ‚

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
// 1. å°†å†å²æ¶ˆæ¯å‘é‡åŒ–
const historyEmbeddings = await embedMessages(history);

// 2. æ£€ç´¢ç›¸å…³æ¶ˆæ¯
const relevantMessages = await retrieveRelevant(
  userMessage,
  historyEmbeddings,
  topK=10
);

// 3. æ„å»ºæ¶ˆæ¯åˆ—è¡¨
const messagesForLLM = [
  systemMessage,
  ...relevantMessages,
  userMessage,
];
```

### æ–¹æ¡ˆ 4ï¼šåˆ†å±‚å‹ç¼©ï¼ˆHybrid Approachï¼‰â­ æ¨è
**åŸç†**ï¼šç»“åˆå¤šç§ç­–ç•¥çš„æ··åˆæ–¹æ¡ˆ

**ç­–ç•¥**ï¼š
1. **System çº§åˆ«**ï¼šé¡¹ç›®ä¿¡æ¯ã€ç”¨æˆ·åå¥½ï¼ˆå¾ˆå°‘å˜åŒ–ï¼‰
2. **Summary çº§åˆ«**ï¼šæ—§å¯¹è¯æ‘˜è¦ï¼ˆå®šæœŸæ›´æ–°ï¼‰
3. **Recent çº§åˆ«**ï¼šæœ€è¿‘ N æ¡å®Œæ•´æ¶ˆæ¯ï¼ˆä¿æŒç»†èŠ‚ï¼‰
4. **Current çº§åˆ«**ï¼šå½“å‰ç”¨æˆ·æ¶ˆæ¯

**ä¼˜ç‚¹**ï¼š
- âœ… å¹³è¡¡æ€§èƒ½å’Œä¿¡æ¯å®Œæ•´æ€§
- âœ… å¯æ ¹æ® token é¢„ç®—åŠ¨æ€è°ƒæ•´
- âœ… å‚è€ƒ openclaw-cn-ds çš„è®¾è®¡

**ä»£ç ç»“æ„**ï¼š
```typescript
const contextWindow = getModelContextWindow(model);
const tokenBudget = contextWindow * 0.8;  // é¢„ç•™ 20%

// åˆ†å±‚æ„å»º
const layers = {
  system: buildSystemPrompt(),         // å›ºå®š
  summary: await summarizeOld(history), // å‹ç¼©
  recent: history.slice(-20),           // å®Œæ•´
  current: userMessage,                 // å®Œæ•´
};

// åŠ¨æ€è°ƒæ•´
const compressed = compactToFitBudget(layers, tokenBudget);
```

## æ‹†è§£æ­¥éª¤

### Phase 1: ç ”ç©¶ä¸è®¾è®¡
- [ ] 1.1 ç ”ç©¶ openclaw-cn-ds çš„å‹ç¼©å®ç°
- [ ] 1.2 åˆ†æå½“å‰ `compactIfNeeded` æ–¹æ³•çš„å®ç°
- [ ] 1.3 è®¾è®¡é€‚åˆ Krebs çš„å‹ç¼©ç­–ç•¥
- [ ] 1.4 å®šä¹‰å‹ç¼©è§¦å‘æ¡ä»¶

### Phase 2: æ ¸å¿ƒå®ç°
- [ ] 2.1 å®ç° `summarizeMessages` æ–¹æ³•ï¼ˆè°ƒç”¨ LLM ç”Ÿæˆæ‘˜è¦ï¼‰
- [ ] 2.2 ä¼˜åŒ– `compactIfNeeded` æ–¹æ³•ï¼ˆæ”¯æŒåˆ†å±‚å‹ç¼©ï¼‰
- [ ] 2.3 å®ç°æ™ºèƒ½ç¼“å­˜æœºåˆ¶ï¼ˆæ‘˜è¦ç¼“å­˜ï¼Œé¿å…é‡å¤ç”Ÿæˆï¼‰
- [ ] 2.4 æ·»åŠ å‹ç¼©å†³ç­–é€»è¾‘ï¼ˆä½•æ—¶è§¦å‘å‹ç¼©ï¼‰

### Phase 3: é›†æˆä¸ä¼˜åŒ–
- [ ] 3.1 é›†æˆåˆ° Agent.process æ–¹æ³•
- [ ] 3.2 æ·»åŠ ç›‘æ§å’Œæ—¥å¿—ï¼ˆå‹ç¼©ç‡ã€token èŠ‚çœï¼‰
- [ ] 3.3 æ€§èƒ½ä¼˜åŒ–ï¼ˆå¼‚æ­¥æ‘˜è¦ã€ç¼“å­˜ï¼‰

### Phase 4: æµ‹è¯•ä¸éªŒè¯
- [ ] 4.1 å•å…ƒæµ‹è¯•ï¼ˆå‹ç¼©é€»è¾‘ï¼‰
- [ ] 4.2 é›†æˆæµ‹è¯•ï¼ˆé•¿å¯¹è¯åœºæ™¯ï¼‰
- [ ] 4.3 éªŒè¯ä¿¡æ¯ä¸ä¸¢å¤±ï¼ˆå…³é”®ä¿¡æ¯ä¿ç•™ï¼‰
- [ ] 4.4 æ€§èƒ½æµ‹è¯•ï¼ˆtoken ä½¿ç”¨é‡å¯¹æ¯”ï¼‰

## ç ”ç©¶æˆæœæ€»ç»“

### openclaw-cn-ds çš„å‹ç¼©ç­–ç•¥

**æ ¸å¿ƒæœºåˆ¶**ï¼š
1. **Compactionï¼ˆå‹ç¼©ï¼‰**ï¼šå°†æ—§å¯¹è¯æ‘˜è¦ä¸ºç´§å‡‘æ¡ç›®ï¼Œä¿ç•™æœ€è¿‘æ¶ˆæ¯
   - æŒä¹…åŒ–åˆ° JSONL å†å²ä¸­
   - è‡ªåŠ¨è§¦å‘ï¼ˆæ¥è¿‘ä¸Šä¸‹æ–‡çª—å£æ—¶ï¼‰
   - æ‰‹åŠ¨è§¦å‘ï¼ˆ`/compact` å‘½ä»¤ï¼‰

2. **Session Pruningï¼ˆä¼šè¯ä¿®å‰ªï¼‰**ï¼šä»…ä¿®å‰ªæ—§çš„å·¥å…·ç»“æœï¼ˆin-memoryï¼‰
   - ä¸ä¿®æ”¹ JSONL å†å²
   - æ¯æ¬¡è¯·æ±‚æ—¶åŠ¨æ€æ‰§è¡Œ
   - å‡å°‘ token ä½†ä¿ç•™æ¶ˆæ¯ç»“æ„

3. **Memory Flushï¼ˆå†…å­˜åˆ·æ–°ï¼‰**ï¼šå‹ç¼©å‰è‡ªåŠ¨ä¿å­˜é‡è¦ä¿¡æ¯åˆ°ç£ç›˜
   - åœ¨å‹ç¼©å‰æ‰§è¡Œ agentic turn
   - ç¡®ä¿å…³é”®ä¿¡æ¯ä¸ä¸¢å¤±

**é…ç½®é€‰é¡¹**ï¼š
```typescript
AgentCompactionConfig {
  mode: AgentCompactionMode;  // å‹ç¼©æ¨¡å¼
  reserveTokensFloor: number;  // æœ€å°ä¿ç•™ token
  memoryFlush: {
    enabled: boolean;
    softThresholdTokens: number;  // è§¦å‘é˜ˆå€¼
    prompt: string;  // å†…å­˜åˆ·æ–°æç¤º
  };
}
```

### å½“å‰ Krebs é¡¹ç›®çš„å®ç°åˆ†æ

**å·²æœ‰çš„åŸºç¡€**ï¼š
- âœ… `compactMessages` å·¥å…·ï¼ˆ`src/utils/compaction.ts`ï¼‰
- âœ… `compactIfNeeded` æ–¹æ³•ï¼ˆ`src/agent/core/agent.ts`ï¼‰
- âœ… Token ä¼°ç®—å·¥å…·
- âœ… æ¨¡å‹ä¸Šä¸‹æ–‡çª—å£æŸ¥è¯¢

**å½“å‰å®ç°çš„é—®é¢˜**ï¼š
1. âš ï¸ `generateSimpleSummary` æ˜¯**ç®€å•æ‘˜è¦**ï¼ˆç»Ÿè®¡æ¶ˆæ¯æ•°ï¼Œæˆªå–å†…å®¹ï¼‰
2. âš ï¸ **æ²¡æœ‰è°ƒç”¨ LLM ç”Ÿæˆæ™ºèƒ½æ‘˜è¦**
3. âš ï¸ å‹ç¼©åªåœ¨ä¿å­˜æ—¶è§¦å‘ï¼Œä¸åœ¨å‘é€ç»™ LLM å‰è§¦å‘
4. âš ï¸ ç¼ºå°‘ç¼“å­˜æœºåˆ¶ï¼ˆæ‘˜è¦ä¼šé‡å¤ç”Ÿæˆï¼‰

### æ¨èæ–¹æ¡ˆï¼šæ™ºèƒ½åˆ†å±‚å‹ç¼©

åŸºäº openclaw-cn-ds çš„è®¾è®¡ï¼Œç»“åˆ Krebs çš„å®é™…æƒ…å†µï¼Œæ¨è**åˆ†å±‚å‹ç¼© + LLM æ‘˜è¦**æ–¹æ¡ˆã€‚

**åˆ†å±‚ç»“æ„**ï¼š
```
Layer 1 (å›ºå®š): System Prompt
  - å·¥å…·åˆ—è¡¨ã€æŠ€èƒ½åˆ—è¡¨ã€è¿è¡Œæ—¶ä¿¡æ¯
  - Token æ•°ï¼šç›¸å¯¹å›ºå®š

Layer 2 (å‹ç¼©): å†å²å¯¹è¯æ‘˜è¦
  - æ—§å¯¹è¯çš„æ™ºèƒ½æ‘˜è¦ï¼ˆç”± LLM ç”Ÿæˆï¼‰
  - ç¼“å­˜æ‘˜è¦ï¼Œå®šæœŸæ›´æ–°
  - Token æ•°ï¼šå¯é…ç½®ï¼ˆé»˜è®¤ 500-1000ï¼‰

Layer 3 (å®Œæ•´): æœ€è¿‘ N æ¡æ¶ˆæ¯
  - ä¿æŒå®Œæ•´çš„å¯¹è¯ç»†èŠ‚
  - å¯é…ç½®æ•°é‡ï¼ˆé»˜è®¤ 10-20 æ¡ï¼‰
  - Token æ•°ï¼šåŠ¨æ€

Layer 4 (å®Œæ•´): å½“å‰ç”¨æˆ·æ¶ˆæ¯
  - å®Œæ•´ä¿ç•™
```

## å½“å‰è¿›åº¦

### æ­£åœ¨è¿›è¡Œ
âœ… ä»»åŠ¡å…¨éƒ¨å®Œæˆ

### å·²å®Œæˆ
- âœ… åˆ›å»ºä»»åŠ¡æ–‡æ¡£
- âœ… åˆ†æé—®é¢˜èƒŒæ™¯
- âœ… åˆ—å‡ºæŠ€æœ¯æ–¹æ¡ˆé€‰é¡¹
- âœ… ç ”ç©¶ openclaw-cn-ds çš„å‹ç¼©å®ç°
- âœ… åˆ†æå½“å‰ Krebs çš„å‹ç¼©å®ç°
- âœ… ç¡®å®šæ¨èæ–¹æ¡ˆï¼ˆæ™ºèƒ½åˆ†å±‚å‹ç¼©ï¼‰
- âœ… å®ç° `summarizeMessages` æ–¹æ³•ï¼ˆè°ƒç”¨ LLMï¼‰
- âœ… å®ç°æ‘˜è¦ç¼“å­˜æœºåˆ¶
- âœ… ä¼˜åŒ– Agent çš„ä¸Šä¸‹æ–‡æ„å»ºé€»è¾‘
- âœ… ç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼ˆ11ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼‰
- âœ… åˆ›å»ºæŠ€æœ¯æ–‡æ¡£
- âœ… æ„å»ºé¡¹ç›®ï¼ˆè§£å†³ç±»å‹é”™è¯¯ï¼‰
- âœ… ä¿®å¤ session-store æµ‹è¯•

## äº¤ä»˜æ¸…å•

### æ–°å¢æ–‡ä»¶
1. âœ… `src/utils/summarization.ts` - æ™ºèƒ½æ‘˜è¦å·¥å…·ï¼ˆ270è¡Œï¼‰
2. âœ… `test/utils/summarization.test.ts` - æ‘˜è¦å•å…ƒæµ‹è¯•ï¼ˆ165è¡Œï¼‰
3. âœ… `test/agent/context-passing.test.ts` - ä¸Šä¸‹æ–‡ä¼ é€’æµ‹è¯•ï¼ˆ198è¡Œï¼‰
4. âœ… `docs/context-compression.md` - æŠ€æœ¯æ–‡æ¡£ï¼ˆ7KBï¼‰

### ä¿®æ”¹æ–‡ä»¶
1. âœ… `src/agent/core/agent.ts` - é›†æˆæ™ºèƒ½å‹ç¼©
   - æ–°å¢ `compressHistoryIfNeeded()` æ–¹æ³•
   - ä¼˜åŒ– `processWithTools()` ä¸Šä¸‹æ–‡æ„å»º
2. âœ… `src/storage/session/session-store.ts` - ä¿®å¤ timestamp é—®é¢˜

### æ„å»ºéªŒè¯
- âœ… TypeScript ç¼–è¯‘é€šè¿‡
- âœ… tsc-alias åˆ«åè§£ææˆåŠŸ
- âœ… ç”Ÿæˆ `dist/utils/summarization.js`
- âœ… æ ¸å¿ƒæµ‹è¯•é€šè¿‡ï¼ˆcontext-passing + summarizationï¼‰

### æµ‹è¯•ç»“æœ
**æ–°æµ‹è¯•ï¼ˆ11ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼‰**ï¼š
- âœ… context-passing.test.ts - 4ä¸ªæµ‹è¯•
- âœ… summarization.test.ts - 7ä¸ªæµ‹è¯•

**ç°æœ‰æµ‹è¯•**ï¼š
- âœ… session-store.test.ts - 14ä¸ªæµ‹è¯•ï¼ˆä¿®å¤åé€šè¿‡ï¼‰
- âš ï¸ å…¶ä»–æµ‹è¯•ï¼ˆtool-status, memory-integrationï¼‰æœ‰å¤±è´¥ï¼Œä¸æœ¬æ¬¡æ›´æ”¹æ— å…³

## å®ç°æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

1. **æ–°å¢ `summarization.ts` æ¨¡å—**ï¼š
   - `summarizeMessages()` - ä½¿ç”¨ LLM ç”Ÿæˆæ™ºèƒ½æ‘˜è¦
   - `SummaryCache` - æ‘˜è¦ç¼“å­˜æœºåˆ¶ï¼ˆé¿å…é‡å¤ç”Ÿæˆï¼‰
   - æ”¯æŒå¯é…ç½®çš„è¯¦ç»†ç¨‹åº¦å’Œå…³æ³¨ç‚¹

2. **æ–°å¢ `compressHistoryIfNeeded()` æ–¹æ³•**ï¼ˆAgent.tsï¼‰ï¼š
   - åˆ†å±‚å‹ç¼©ï¼šæ—§æ¶ˆæ¯æ‘˜è¦ + æœ€è¿‘æ¶ˆæ¯å®Œæ•´ä¿ç•™
   - æ™ºèƒ½è§¦å‘ï¼šæ¶ˆæ¯æ•° > 30 æˆ– token > 8000
   - é™çº§æœºåˆ¶ï¼šæ‘˜è¦å¤±è´¥æ—¶é™çº§åˆ°ç®€å•ä¿®å‰ª

3. **é›†æˆåˆ° Agent.process()**ï¼š
   - åœ¨æ„å»ºä¸Šä¸‹æ–‡å‰è‡ªåŠ¨å‹ç¼©å†å²
   - ä¿æŒä¸ MemorySystem çš„å…¼å®¹æ€§
   - é›¶ä¾µå…¥å¼ä¿®æ”¹

### å‹ç¼©ç­–ç•¥

**è§¦å‘æ¡ä»¶**ï¼ˆå¯é…ç½®ï¼‰ï¼š
- å†å²æ¶ˆæ¯æ•° > 30 æ¡
- æˆ–å†å² token æ•° > 8000

**å‹ç¼©é€»è¾‘**ï¼š
```
æ—§æ¶ˆæ¯ï¼ˆéœ€è¦æ‘˜è¦ï¼‰
    â†“
è°ƒç”¨ LLM ç”Ÿæˆæ™ºèƒ½æ‘˜è¦ï¼ˆ1000 tokensï¼‰
    â†“
æ„å»ºæ‘˜è¦æ¶ˆæ¯
    â†“
[æ‘˜è¦æ¶ˆæ¯] + æœ€è¿‘ 15 æ¡å®Œæ•´æ¶ˆæ¯
    â†“
å‘é€ç»™ LLM
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ˜¾è‘—å‡å°‘ token æ¶ˆè€—ï¼ˆ30æ¡æ¶ˆæ¯ â†’ ~1000 tokensï¼‰
- âœ… ä¿ç•™å…³é”®ä¿¡æ¯ï¼ˆä½¿ç”¨ LLM æ™ºèƒ½æ‘˜è¦ï¼‰
- âœ… ä¿æŒæœ€è¿‘å¯¹è¯çš„å®Œæ•´æ€§
- âœ… ç¼“å­˜æœºåˆ¶ï¼ˆé¿å…é‡å¤ç”Ÿæˆï¼‰
- âœ… é™çº§ä¿æŠ¤ï¼ˆæ‘˜è¦å¤±è´¥æ—¶ä¸å½±å“åŠŸèƒ½ï¼‰

### é…ç½®é€‰é¡¹

```typescript
// Agent å†…éƒ¨é…ç½®
const keepRecentCount = 15;      // ä¿ç•™æœ€è¿‘ 15 æ¡å®Œæ•´æ¶ˆæ¯
const summaryThreshold = 30;     // è¶…è¿‡ 30 æ¡æ¶ˆæ¯æ‰è§¦å‘å‹ç¼©
const maxHistoryTokens = 8000;   // å†å²æ¶ˆæ¯çš„æœ€å¤§ token æ•°

// æ‘˜è¦é€‰é¡¹
{
  maxTokens: 1000,       // æ‘˜è¦æœ€å¤š 1000 tokens
  detail: "balanced",    // concise | balanced | detailed
  focus: "all",          // decisions | actions | all
  includeTimestamps: false
}
```

### æµ‹è¯•è¦†ç›–

**å•å…ƒæµ‹è¯•**ï¼ˆtest/utils/summarization.test.tsï¼‰ï¼š
- âœ… 7ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
- âœ… è¦†ç›– LLM è°ƒç”¨ã€ç¼“å­˜æœºåˆ¶ã€é…ç½®é€‰é¡¹
- âœ… è¦†ç›–é™çº§åœºæ™¯

**é›†æˆæµ‹è¯•**ï¼š
- âœ… ä¸ Agent.process() çš„é›†æˆ
- âœ… ä¸ MemorySystem çš„å…¼å®¹æ€§
- âœ… é•¿å¯¹è¯åœºæ™¯éªŒè¯

### æ€§èƒ½å¯¹æ¯”

**å‹ç¼©å‰**ï¼ˆå‡è®¾ 50 æ¡æ¶ˆæ¯ï¼‰ï¼š
- Token æ•°ï¼š~15000 tokens
- æˆæœ¬ï¼šé«˜
- æ³¨æ„åŠ›ï¼šåˆ†æ•£

**å‹ç¼©å**ï¼š
- Token æ•°ï¼š~2500 tokensï¼ˆæ‘˜è¦ 1000 + æœ€è¿‘ 15 æ¡ 1500ï¼‰
- **èŠ‚çœ 83% tokens** ğŸ‰
- æˆæœ¬ï¼šé™ä½ 83%
- æ³¨æ„åŠ›ï¼šé›†ä¸­åœ¨æœ€è¿‘å¯¹è¯ + å…³é”®å†å²

### ä½¿ç”¨ç¤ºä¾‹

```typescript
// è‡ªåŠ¨è§¦å‘ï¼ˆAgent å†…éƒ¨ï¼‰
// å½“å†å²æ¶ˆæ¯ > 30 æ¡æ—¶ï¼Œè‡ªåŠ¨å‹ç¼©
const result = await agent.process("ç”¨æˆ·æ¶ˆæ¯", sessionId);

// æ‘˜è¦ä¼šè‡ªåŠ¨ç”Ÿæˆå¹¶ç¼“å­˜
// ä¸‹æ¬¡è°ƒç”¨æ—¶ä½¿ç”¨ç¼“å­˜ï¼ˆå¦‚æœæ¶ˆæ¯æœªå˜åŒ–ï¼‰
```

### ä¸‹ä¸€æ­¥ä¼˜åŒ–

1. **å¼‚æ­¥æ‘˜è¦ç”Ÿæˆ**ï¼šåå°é¢„ç”Ÿæˆæ‘˜è¦ï¼ˆé¿å…ç­‰å¾…ï¼‰
2. **å¢é‡æ‘˜è¦**ï¼šåªæ‘˜è¦æ–°å¢çš„æ¶ˆæ¯ï¼ˆæå‡æ•ˆç‡ï¼‰
3. **å¤šçº§ç¼“å­˜**ï¼šå†…å­˜ç¼“å­˜ + ç£ç›˜ç¼“å­˜ï¼ˆæŒä¹…åŒ–ï¼‰
4. **ç”¨æˆ·æ§åˆ¶**ï¼šæ·»åŠ  `/compact` å‘½ä»¤ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
5. **æ‘˜è¦è´¨é‡è¯„ä¼°**ï¼šæ£€æµ‹æ‘˜è¦æ˜¯å¦åŒ…å«å…³é”®ä¿¡æ¯

## æŠ€æœ¯æ–‡æ¡£

### æ–°å¢æ–‡ä»¶
1. `src/utils/summarization.ts` - æ™ºèƒ½æ‘˜è¦å·¥å…·
2. `test/utils/summarization.test.ts` - å•å…ƒæµ‹è¯•

### ä¿®æ”¹æ–‡ä»¶
1. `src/agent/core/agent.ts` - é›†æˆæ™ºèƒ½å‹ç¼©

### API å‚è€ƒ

```typescript
// ç”Ÿæˆæ‘˜è¦
const result = await summarizeMessages(provider, messages, {
  maxTokens: 1000,
  detail: "balanced",
  focus: "all",
});

// æ¸…é™¤ç¼“å­˜
clearAllSummaryCache();
```

## æŠ€æœ¯çº¦æŸ

### Token é™åˆ¶
- Claude 3.5 Sonnet: 200K tokens
- GPT-4: 128K tokens
- DeepSeek: 64K tokens

### æ€§èƒ½è¦æ±‚
- æ‘˜è¦ç”Ÿæˆæ—¶é—´ï¼š< 5 ç§’
- å‹ç¼©å†³ç­–æ—¶é—´ï¼š< 100ms
- å†…å­˜å ç”¨ï¼šæœ€å°åŒ–

### è´¨é‡è¦æ±‚
- **å…³é”®ä¿¡æ¯ä¸ä¸¢å¤±**ï¼šç”¨æˆ·åç§°ã€åå¥½ã€é‡è¦ç»“è®º
- **å¯è¿½æº¯æ€§**ï¼šèƒ½å¤Ÿç†è§£"ä¸ºä»€ä¹ˆå¾—å‡ºè¿™ä¸ªç»“è®º"
- **è‡ªç„¶æ€§**ï¼šå¯¹è¯è¿è´¯ï¼Œä¸çªå…€

## å†³ç­–çŸ©é˜µ

| æ–¹æ¡ˆ | ä¿¡æ¯å®Œæ•´æ€§ | TokenèŠ‚çœ | å®ç°å¤æ‚åº¦ | æ€§èƒ½ | æ¨èåº¦ |
|------|----------|----------|----------|------|--------|
| æ»‘åŠ¨çª—å£ | â­â­ | â­â­â­â­â­ | â­ | â­â­â­â­â­ | âŒ ä¸æ¨è |
| æ™ºèƒ½æ‘˜è¦ | â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­ | âœ… å¯é€‰ |
| è¯­ä¹‰æ£€ç´¢ | â­â­â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­ | âœ… å¯é€‰ |
| **åˆ†å±‚å‹ç¼©** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­â­ **å¼ºçƒˆæ¨è** |

## å‚è€ƒèµ„æº

1. **openclaw-cn-ds**:
   - `src/agent/core/transcript.ts` - ä¼šè¯ç®¡ç†
   - Agent çš„ä¸Šä¸‹æ–‡å‹ç¼©é€»è¾‘

2. **å½“å‰é¡¹ç›®**:
   - `src/utils/compaction.ts` - æ¶ˆæ¯å‹ç¼©å·¥å…·
   - `src/agent/core/agent.ts` - Agent å®ç°
   - `test/agent/agent-context.test.ts` - ä¸Šä¸‹æ–‡æµ‹è¯•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

3. **æœ€ä½³å®è·µ**:
   - Anthropic Context Management Guide
   - OpenAI Long Context Management
