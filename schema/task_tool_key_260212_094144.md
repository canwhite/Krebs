# Task: 工具Key缺失自动跳过机制

**任务ID**: task_tool_key_260212_094144
**创建时间**: 2026-02-12 09:41:44
**状态**: 进行中
**目标**: 当工具缺少API key时自动跳过，只在前端显示状态，直到key补上后可调用

## 最终目标
实现工具的优雅降级机制：
- 工具缺少必要配置（如API key）时，不抛出错误，而是跳过该工具
- 在前端显示工具状态（如需要配置、可用等）
- 当配置补上后，工具自动变为可用状态

## 拆解步骤

### 1. 分析现有工具系统
- [ ] 1.1 阅读工具相关代码，了解当前工具调用机制
- [ ] 1.2 了解工具配置系统（API keys等）
- [ ] 1.3 了解前端如何展示工具状态

### 2. 设计工具状态检查机制
- [ ] 2.1 定义工具状态枚举（available, missing_config, error等）
- [ ] 2.2 实现工具配置验证函数
- [ ] 2.3 设计工具注册时的元数据（需要的配置项）

### 3. 实现工具自动跳过逻辑
- [ ] 3.1 在工具调用前检查配置
- [ ] 3.2 缺少配置时跳过工具，返回状态信息
- [ ] 3.3 确保不影响其他工具的正常执行

### 4. 实现前端状态显示
- [ ] 4.1 定义API接口，返回工具状态
- [ ] 4.2 前端展示工具配置状态
- [ ] 4.3 提供配置提示和引导

### 5. 编写测试
- [ ] 5.1 单元测试：配置检查逻辑
- [ ] 5.2 集成测试：工具调用跳过机制
- [ ] 5.3 前端测试：状态展示

## 当前进度
### 正在进行
已完成实现，准备测试

### 已完成
1. ✅ 分析现有工具系统
   - 工具定义：`src/agent/tools/`
   - API Key 管理：`src/shared/api-keys.ts`
   - 前端 API：`/api/tools/keys`
   - 发现：web_search 工具缺少 key 时会返回错误

2. ✅ 设计工具状态检查机制
   - 创建 `src/agent/tools/status.ts`
   - 定义 `ToolStatus` 枚举
   - 定义 `ToolStatusInfo` 接口
   - 实现 `checkToolStatus()` 函数

3. ✅ 实现工具自动跳过逻辑
   - 更新 `Tool` 接口，添加 `checkConfig` 可选方法
   - 更新 `ToolRegistry`，添加状态检查方法
   - 在 `execute()` 中添加状态检查，自动跳过不可用工具
   - 添加 `getCallableTools()` 方法

4. ✅ 添加 HTTP API 端点
   - 在 `AgentManager` 中添加 `ToolRegistry` 实例
   - 添加 `getToolRegistry()` 方法
   - 更新 `registerTools()` 同时注册到 registry
   - 添加 `/api/tools/status` 端点

5. ✅ 测试编译
   - 修复 TypeScript 类型错误
   - 构建成功

## 下一步行动
1. 编写单元测试
2. 手动测试工具状态API
3. 前端显示工具状态（可选，前端已有基础实现）
