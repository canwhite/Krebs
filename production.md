# Krebs é¡¹ç›®å…¨å±€æ–‡æ¡£

> **ç»´æŠ¤æ—¶é—´**: 2026-02-04
> **æ–‡æ¡£çŠ¶æ€**: æ´»è·ƒç»´æŠ¤ä¸­

---

## é¡¹ç›®å®šä½

**Krebs** æ˜¯ä¸€ä¸ªè½»é‡çº§ã€æ¨¡å—åŒ–çš„ AI Agent æ¡†æ¶ï¼Œä¸“æ³¨äºæä¾›æ¸…æ™°ã€å¯æ‰©å±•çš„æ™ºèƒ½ä½“è¿è¡Œæ—¶ã€‚

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- ğŸ¯ **ç®€æ´æ¶æ„**: æ¸…æ™°çš„æ¨¡å—åˆ†å±‚ï¼Œæ˜“äºç†è§£å’Œæ‰©å±•
- ğŸ”Œ **å¯æ’æ‹”è®¾è®¡**: Provider å±‚æ”¯æŒå¤šç§ AI æ¨¡å‹æä¾›å•†
- ğŸ’¾ **çµæ´»å­˜å‚¨**: Storage å±‚æ”¯æŒå¤šç§å­˜å‚¨å®ç°
- ğŸš¦ **æ™ºèƒ½è°ƒåº¦**: Lane é˜Ÿåˆ—ç³»ç»Ÿå®ç°å¹¶å‘æ§åˆ¶
- ğŸ› ï¸ **æŠ€èƒ½ç³»ç»Ÿ**: å¯æ‰©å±•çš„æŠ€èƒ½æ¡†æ¶

**æŠ€æœ¯æ ˆ**ï¼š
- è¯­è¨€: TypeScript
- è¿è¡Œæ—¶: Node.js (Denoå…¼å®¹)
- ä¸»è¦ä¾èµ–: Anthropic SDK, OpenAI SDK
- æ¶æ„æ¨¡å¼: ä¾èµ–æ³¨å…¥ã€æ¨¡å—åŒ–ã€åˆ†å±‚è®¾è®¡

---

## æ ¸å¿ƒæ¶æ„

### ä¾èµ–å±‚æ¬¡ï¼ˆå·²æ›´æ–°ï¼‰

```
types (åŸºç¡€å±‚ - é›¶ä¾èµ–)
  â†“
shared â† scheduler (ç‹¬ç«‹æ¨¡å—)
  â†“
provider â† storage (ä¸­é—´å±‚)
  â†“
agent (æ ¸å¿ƒå±‚)
  â”œâ”€ core
  â”‚   â”œâ”€ agent.ts (Agent - LLMå¤„ç†)
  â”‚   â”œâ”€ orchestrator.ts (Orchestrator - æŠ€èƒ½è°ƒåº¦)
  â”‚   â””â”€ manager.ts (AgentManager - ä¾èµ–ç®¡ç†)
  â””â”€ skills (æŠ€èƒ½ç³»ç»Ÿ)
  â†“
gateway (æ¥å…¥å±‚)
  â”œâ”€ service/chat-service.ts (ChatService - æœåŠ¡æ¥å£)
  â””â”€ server/ (HTTP/WebSocket)
  â†“
index.ts (ä¸»å…¥å£)
```

### æ¨¡å—è¯´æ˜

| æ¨¡å— | èŒè´£ | ä¾èµ– |
|------|------|------|
| **types** | ç±»å‹å®šä¹‰ | æ—  |
| **shared** | é…ç½®ã€æ—¥å¿— | å¤–éƒ¨åº“ |
| **scheduler** | å¹¶å‘æ§åˆ¶é˜Ÿåˆ— | æ—  |
| **provider** | AI æ¨¡å‹æŠ½è±¡ | types |
| **storage** | æ•°æ®å­˜å‚¨ | types |
| **agent** | æ™ºèƒ½ä½“æ ¸å¿ƒ | provider, storage, scheduler, types |
| **gateway** | HTTP/WebSocket æœåŠ¡ | agent, types |

---

## ç›®å½•ç»“æ„

```
Krebs/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ agent/           # Agent æ ¸å¿ƒå®ç°
â”‚   â”‚   â”œâ”€â”€ core/        # æ ¸å¿ƒ Agent ç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ agent.ts      # Agent ä¸»ç±»
â”‚   â”‚   â”‚   â””â”€â”€ manager.ts    # Agent ç®¡ç†å™¨
â”‚   â”‚   â””â”€â”€ skills/      # æŠ€èƒ½ç³»ç»Ÿ
â”‚   â”‚       â”œâ”€â”€ base.ts       # æŠ€èƒ½åŸºç±»
â”‚   â”‚       â”œâ”€â”€ registry.ts   # æŠ€èƒ½æ³¨å†Œè¡¨
â”‚   â”‚       â””â”€â”€ index.ts      # æŠ€èƒ½å¯¼å‡º
â”‚   â”œâ”€â”€ gateway/         # HTTP/WebSocket æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ server/      # æœåŠ¡å™¨å®ç°
â”‚   â”‚   â””â”€â”€ routes/      # è·¯ç”±å®šä¹‰
â”‚   â”œâ”€â”€ provider/        # AI æ¨¡å‹æŠ½è±¡å±‚
â”‚   â”‚   â”œâ”€â”€ base.ts      # Provider æ¥å£
â”‚   â”‚   â”œâ”€â”€ anthropic.ts # Anthropic å®ç°
â”‚   â”‚   â”œâ”€â”€ openai.ts    # OpenAI å®ç°
â”‚   â”‚   â””â”€â”€ deepseek.ts  # DeepSeek å®ç°
â”‚   â”œâ”€â”€ storage/         # å­˜å‚¨å±‚
â”‚   â”‚   â”œâ”€â”€ session.ts   # ä¼šè¯å­˜å‚¨
â”‚   â”‚   â””â”€â”€ store.ts     # å­˜å‚¨åŸºç±»
â”‚   â”œâ”€â”€ scheduler/       # è°ƒåº¦ç³»ç»Ÿ
â”‚   â”‚   â””â”€â”€ lanes.ts     # Lane é˜Ÿåˆ—ç®¡ç†
â”‚   â”œâ”€â”€ shared/          # å…±äº«å·¥å…·
â”‚   â”‚   â”œâ”€â”€ config.ts    # é…ç½®ç®¡ç†
â”‚   â”‚   â””â”€â”€ logger.ts    # æ—¥å¿—å·¥å…·
â”‚   â”œâ”€â”€ types/           # ç±»å‹å®šä¹‰
â”‚   â”‚   â””â”€â”€ index.ts     # ç»Ÿä¸€å¯¼å‡º
â”‚   â””â”€â”€ index.ts         # ä¸»å…¥å£
â”œâ”€â”€ docs/                # æ–‡æ¡£ç›®å½•
â”‚   â””â”€â”€ architecture-analysis.md  # æ¶æ„åˆ†ææŠ¥å‘Š
â”œâ”€â”€ schema/              # ä»»åŠ¡æ–‡æ¡£ï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰
â”œâ”€â”€ production.md        # æœ¬æ–‡ä»¶
â””â”€â”€ package.json
```

---

## æ ¸å¿ƒè®¾è®¡æ¨¡å¼

### 1. Provider æ¨¡å¼ï¼ˆç­–ç•¥æ¨¡å¼ï¼‰

é€šè¿‡ `LLMProvider` æ¥å£æŠ½è±¡ä¸åŒçš„ AI æ¨¡å‹æä¾›å•†ï¼š

```typescript
export interface LLMProvider {
  readonly name: string;
  chat(messages: Message[], options: ChatCompletionOptions): Promise<ChatCompletionResult>;
  chatStream(messages: Message[], options: ChatCompletionOptions, onChunk: (chunk: string) => void): Promise<ChatCompletionResult>;
  embed(text: string): Promise<EmbeddingResult>;
  embedBatch(texts: string[]): Promise<EmbeddingResult[]>;
}
```

**ä¼˜åŠ¿**ï¼š
- æ¥å£æ˜ç¡®ï¼ŒèŒè´£å•ä¸€
- å¤šä¸ªå®ç°å¯äº’æ¢
- ç¬¦åˆå¼€é—­åŸåˆ™

### 2. ä¾èµ–æ³¨å…¥

é€šè¿‡ `AgentDeps` æ¥å£æ³¨å…¥ä¾èµ–ï¼š

```typescript
export interface AgentDeps {
  provider: LLMProvider;
  storage?: {
    saveSession(sessionId: string, messages: Message[]): Promise<void>;
    loadSession(sessionId: string): Promise<Message[] | null>;
  };
}
```

**ä¼˜åŠ¿**ï¼š
- å­˜å‚¨å±‚å¯é€‰ï¼Œä¾¿äºæµ‹è¯•
- å¯è½»æ¾æ›¿æ¢å­˜å‚¨å®ç°

### 3. Lane è°ƒåº¦ç³»ç»Ÿ

ä½¿ç”¨é˜Ÿåˆ—ç³»ç»Ÿå®ç°å¹¶å‘æ§åˆ¶ï¼š

```typescript
export enum CommandLane {
  Main = "main",
  Cron = "cron",
  Agent = "agent",
  Nested = "nested",
}
```

**ä¼˜åŠ¿**ï¼š
- é˜²æ­¢èµ„æºè€—å°½
- æ”¯æŒä¸åŒ Lane çš„ç‹¬ç«‹å¹¶å‘æ§åˆ¶
- è‡ªåŠ¨ç›‘æ§ä»»åŠ¡ç­‰å¾…æ—¶é—´

---

## å·²çŸ¥æ¶æ„é—®é¢˜

æ ¹æ® `docs/architecture-analysis.md` çš„åˆ†æï¼Œä¹‹å‰å­˜åœ¨çš„é—®é¢˜**å·²å…¨éƒ¨è§£å†³** âœ…ï¼š

### âœ… å·²è§£å†³

1. **Agent èŒè´£è¿‡é‡** âœ… å·²è§£å†³
   - å¼•å…¥äº† Orchestrator å±‚ï¼ŒæŠ€èƒ½è°ƒåº¦å·²ç§»è‡³ `src/agent/core/orchestrator.ts`
   - Agent ç±»ç°åœ¨ä¸“æ³¨äº LLM å¯¹è¯ç®¡ç†

2. **ä½¿ç”¨å…¨å±€å•ä¾‹** âœ… å·²è§£å†³
   - ç§»é™¤äº† `globalSkillRegistry` çš„ä½¿ç”¨
   - é€šè¿‡ AgentManager ç®¡ç† SkillRegistry å®ä¾‹

3. **Gateway ç›´æ¥ä¾èµ– AgentManager** âœ… å·²è§£å†³
   - åˆ›å»ºäº† ChatService æ¥å£å±‚ (`src/gateway/service/chat-service.ts`)
   - Gateway åªä¾èµ– IChatService æ¥å£

4. **Storage åœ¨ Manager ä¸­ç¡¬ç¼–ç ** âœ… å·²è§£å†³
   - åˆ›å»ºäº† ISessionStorage æ¥å£ (`src/storage/interface.ts`)
   - AgentManager é€šè¿‡æ„é€ å‡½æ•°æ¥å—å­˜å‚¨æ¥å£

5. **æŠ€èƒ½ç³»ç»Ÿè€¦åˆåº¦è¾ƒé«˜** âœ… éƒ¨åˆ†è§£å†³
   - SkillContext å·²ç²¾ç®€ï¼ˆåªä¼ é€’å½“å‰æ¶ˆæ¯ï¼‰
   - åç»­å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆæ·»åŠ æŒ‰éœ€è·å–å†å²çš„æ–¹æ³•ï¼‰

### æ–°æ¶æ„è¯„åˆ†ï¼ˆ2026-02-04 æ›´æ–°ï¼‰

| ç»´åº¦ | æ—§è¯„åˆ† | æ–°è¯„åˆ† | æ”¹è¿› |
|------|--------|--------|------|
| **æ¨¡å—åŒ–** | 8/10 | 9/10 | âœ… å¼•å…¥ Orchestrator å±‚ï¼ŒèŒè´£æ›´æ¸…æ™° |
| **å¯æ‰©å±•æ€§** | 7/10 | 9/10 | âœ… Gateway è§£è€¦ï¼Œæ˜“äºæ‰©å±• |
| **å¯æµ‹è¯•æ€§** | 6/10 | 9/10 | âœ… ä¾èµ–æ³¨å…¥ï¼Œæ˜“äº Mock |
| **å¯ç»´æŠ¤æ€§** | 7/10 | 9/10 | âœ… ä»£ç æ¸…æ™°ï¼Œæ¨¡å—è¾¹ç•Œæ˜ç¡® |
| **æ€§èƒ½** | 8/10 | 8/10 | â– æ— å˜åŒ– |
| **å®‰å…¨æ€§** | 7/10 | 8/10 | âœ… æŠ€èƒ½ä¸Šä¸‹æ–‡ç²¾ç®€ |

**ç»¼åˆè¯„åˆ†**: ä» 7.2/10 æå‡è‡³ **8.7/10** ğŸ‰

---

## éƒ¨ç½²æµç¨‹

### å¼€å‘ç¯å¢ƒ

```bash
# å®‰è£…ä¾èµ–
npm install

# è¿è¡Œå¼€å‘æœåŠ¡å™¨
npm run dev

# è¿è¡Œæµ‹è¯•
npm test

# æ„å»ºé¡¹ç›®
npm run build
```

### ç”Ÿäº§ç¯å¢ƒ

```bash
# æ„å»º
npm run build

# å¯åŠ¨æœåŠ¡
npm start
```

### é…ç½®è¯´æ˜

é…ç½®é€šè¿‡ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶ä¼ é€’ï¼Œä¸»è¦é…ç½®é¡¹ï¼š

- `ANTHROPIC_API_KEY`: Anthropic API Key
- `OPENAI_API_KEY`: OpenAI API Key
- `STORAGE_DIR`: ä¼šè¯å­˜å‚¨ç›®å½•
- `HTTP_PORT`: HTTP æœåŠ¡ç«¯å£ï¼ˆé»˜è®¤ 3000ï¼‰
- `WS_PORT`: WebSocket æœåŠ¡ç«¯å£ï¼ˆé»˜è®¤ 3001ï¼‰

---

## å‚è€ƒé¡¹ç›®

**openclaw-cn-ds** (`/Users/zack/Desktop/openclaw-cn-ds`)ï¼š
- å¤§å‹ Agent æ¡†æ¶ï¼ŒåŸºäº p-mono
- å®Œå–„çš„ workspace æ¦‚å¿µï¼ˆAGENTS.md, SOUL.md, TOOLS.mdï¼‰
- æŠ€èƒ½ç³»ç»Ÿä»å¤šä¸ªä½ç½®åŠ è½½ï¼ˆBundled, Managed/local, Workspaceï¼‰
- å®Œæ•´çš„ä¼šè¯ç®¡ç†ï¼ˆJSONLæ ¼å¼ï¼‰
- é«˜åº¦æ¨¡å—åŒ–çš„å·¥å…·ç³»ç»Ÿ

---

## æ”¹è¿›è·¯çº¿å›¾

### ç¬¬ä¸€é˜¶æ®µï¼ˆæ ¸å¿ƒæ¶æ„ï¼‰âœ… å·²å®Œæˆ
- [x] å¼•å…¥ Orchestrator å±‚
- [x] ç§»é™¤å…¨å±€å•ä¾‹
- [x] Gateway æœåŠ¡æŠ½è±¡åŒ–
- [x] Storage æ¥å£åŒ–

### ç¬¬äºŒé˜¶æ®µï¼ˆå·¥ç¨‹ä¼˜åŒ–ï¼‰ğŸš§ è¿›è¡Œä¸­
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- [ ] ç»Ÿä¸€é”™è¯¯å¤„ç†
- [ ] äº‹ä»¶æ€»çº¿é›†æˆ
- [ ] é…ç½®éªŒè¯
- [ ] æ—¥å¿—æ ‡å‡†åŒ–

### ç¬¬ä¸‰é˜¶æ®µï¼ˆåŠŸèƒ½å¢å¼ºï¼‰ğŸ“‹ è®¡åˆ’ä¸­
- [ ] æŠ€èƒ½ç³»ç»Ÿå¢å¼ºï¼ˆæ”¯æŒå¤šä½ç½®åŠ è½½ï¼‰
- [ ] æŠ€èƒ½çƒ­åŠ è½½
- [ ] æ€§èƒ½ç›‘æ§
- [ ] æ–‡æ¡£å®Œå–„

---

**æ–‡æ¡£ç»´æŠ¤**: æœ¬æ–‡æ¡£åº”åœ¨æ¶æ„å˜æ›´æˆ–æ¨¡å—æ–°å¢æ—¶åŒæ­¥æ›´æ–°ã€‚
