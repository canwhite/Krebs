# ä¸Šä¸‹æ–‡å‹ç¼©æœºåˆ¶

## é—®é¢˜åˆ†æ

**æ ¸å¿ƒé—®é¢˜**ï¼šå¦‚ä½•åœ¨ä¿ç•™å…³é”®ä¿¡æ¯çš„å‰æä¸‹ï¼Œå‡å°‘é•¿å¯¹è¯çš„ token æ¶ˆè€—ï¼Ÿ

### é—®é¢˜èƒŒæ™¯

åœ¨é•¿å¯¹è¯åœºæ™¯ä¸­ï¼š
- **Token æ¶ˆè€—å¤§**ï¼šæ¯æ¬¡å¯¹è¯éƒ½ä¼ å…¥å®Œæ•´å†å²ï¼Œçº¿æ€§å¢é•¿
- **æ³¨æ„åŠ›åˆ†æ•£**ï¼šLLM éœ€è¦å¤„ç†å¤§é‡æ— å…³ä¿¡æ¯
- **æˆæœ¬é«˜**ï¼šé•¿å¯¹è¯ä¸­ token ä½¿ç”¨é‡æŒç»­å¢é•¿
- **æ€§èƒ½å·®**ï¼šè¶…è¿‡æ¨¡å‹ä¸Šä¸‹æ–‡çª—å£æ—¶ä¼šå‡ºé”™

### è§£å†³æ–¹æ¡ˆ

é€šè¿‡ç ”ç©¶ **openclaw-cn-ds** é¡¹ç›®ï¼Œè®¾è®¡å¹¶å®ç°äº†**æ™ºèƒ½åˆ†å±‚å‹ç¼©æ–¹æ¡ˆ**ã€‚

---

## æŠ€æœ¯æ–¹æ¡ˆï¼šæ™ºèƒ½åˆ†å±‚å‹ç¼©

### æ ¸å¿ƒæ€æƒ³

å°†å¯¹è¯å†å²åˆ†ä¸º**å››å±‚**ï¼Œæ¯å±‚é‡‡ç”¨ä¸åŒçš„å¤„ç†ç­–ç•¥ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: System Prompt (å›ºå®š)       â”‚
â”‚  - å·¥å…·åˆ—è¡¨ã€æŠ€èƒ½åˆ—è¡¨ã€è¿è¡Œæ—¶ä¿¡æ¯   â”‚
â”‚  - Token æ•°ï¼šç›¸å¯¹å›ºå®šï¼ˆ~2000ï¼‰      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 2: å†å²æ‘˜è¦ (å‹ç¼©)            â”‚
â”‚  - æ—§å¯¹è¯çš„æ™ºèƒ½æ‘˜è¦ï¼ˆLLM ç”Ÿæˆï¼‰     â”‚
â”‚  - Token æ•°ï¼šå¯é…ç½®ï¼ˆ~1000ï¼‰         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 3: æœ€è¿‘æ¶ˆæ¯ (å®Œæ•´)            â”‚
â”‚  - æœ€è¿‘ 15 æ¡å®Œæ•´æ¶ˆæ¯               â”‚
â”‚  - Token æ•°ï¼šåŠ¨æ€ï¼ˆ~1500ï¼‰          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 4: å½“å‰æ¶ˆæ¯ (å®Œæ•´)            â”‚
â”‚  - å½“å‰ç”¨æˆ·æ¶ˆæ¯                     â”‚
â”‚  - Token æ•°ï¼šåŠ¨æ€ï¼ˆ~200ï¼‰           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»è®¡ï¼š~4700 tokensï¼ˆå¯¹æ¯”åŸæ¥çš„ ~15000ï¼‰
èŠ‚çœï¼š68% ğŸ‰
```

### æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | å‹ç¼©å‰ | å‹ç¼©å | èŠ‚çœ |
|------|--------|--------|------|
| **50 æ¡æ¶ˆæ¯** | ~15000 tokens | ~2500 tokens | **83%** ğŸ‰ |
| **100 æ¡æ¶ˆæ¯** | ~30000 tokens | ~3500 tokens | **88%** ğŸ‰ |
| **200 æ¡æ¶ˆæ¯** | ~60000 tokens | ~4500 tokens | **92%** ğŸ‰ |

### å…³é”®ä¼˜åŠ¿

- âœ… **æ˜¾è‘—é™ä½æˆæœ¬**ï¼štoken ä½¿ç”¨é‡å‡å°‘ 80%+
- âœ… **ä¿æŒä¿¡æ¯å®Œæ•´æ€§**ï¼šä½¿ç”¨ LLM æ™ºèƒ½æ‘˜è¦ï¼Œä¿ç•™å…³é”®ä¿¡æ¯
- âœ… **æå‡æ€§èƒ½**ï¼šLLM æ³¨æ„åŠ›é›†ä¸­åœ¨æœ€è¿‘å¯¹è¯ + å…³é”®å†å²
- âœ… **è‡ªåŠ¨ç¼“å­˜**ï¼šé¿å…é‡å¤ç”Ÿæˆæ‘˜è¦ï¼ˆèŠ‚çœæ—¶é—´å’Œæˆæœ¬ï¼‰
- âœ… **é™çº§ä¿æŠ¤**ï¼šæ‘˜è¦å¤±è´¥æ—¶ä¸å½±å“åŠŸèƒ½

---

## æŠ€æœ¯å®ç°

### 1. æ™ºèƒ½æ‘˜è¦æ¨¡å— (`src/utils/summarization.ts`)

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- `summarizeMessages()` - ä½¿ç”¨ LLM ç”Ÿæˆæ™ºèƒ½æ‘˜è¦
- `SummaryCache` - æ‘˜è¦ç¼“å­˜æœºåˆ¶ï¼ˆé¿å…é‡å¤ç”Ÿæˆï¼‰
- å¯é…ç½®çš„è¯¦ç»†ç¨‹åº¦å’Œå…³æ³¨ç‚¹

**API ç¤ºä¾‹**ï¼š

```typescript
import { summarizeMessages } from "@/utils/summarization.js";

const result = await summarizeMessages(provider, oldMessages, {
  maxTokens: 1000,        // æ‘˜è¦æœ€å¤š 1000 tokens
  detail: "balanced",     // concise | balanced | detailed
  focus: "all",           // decisions | actions | all
  includeTimestamps: false,
});

// ç»“æœ
console.log(result.summary);           // æ‘˜è¦æ–‡æœ¬
console.log(result.estimatedTokens);   // ä¼°ç®—çš„ token æ•°
```

**é…ç½®é€‰é¡¹**ï¼š

| é€‰é¡¹ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `maxTokens` | number | æ‘˜è¦çš„æœ€å¤§ token æ•°ï¼ˆé»˜è®¤ 1000ï¼‰ |
| `detail` | string | è¯¦ç»†ç¨‹åº¦ï¼š`concise` \| `balanced` \| `detailed` |
| `focus` | string | å…³æ³¨ç‚¹ï¼š`decisions` \| `actions` \| `all` |
| `includeTimestamps` | boolean | æ˜¯å¦åŒ…å«æ—¶é—´æˆ³ |

### 2. Agent é›†æˆ (`src/agent/core/agent.ts`)

**æ–°å¢æ–¹æ³•**ï¼š`compressHistoryIfNeeded()`

**å‹ç¼©ç­–ç•¥**ï¼š
- **è§¦å‘æ¡ä»¶**ï¼šæ¶ˆæ¯æ•° > 30 æˆ– token > 8000
- **å‹ç¼©é€»è¾‘**ï¼š
  1. åˆ†å‰²ï¼šæ—§æ¶ˆæ¯ï¼ˆéœ€æ‘˜è¦ï¼‰+ æœ€è¿‘æ¶ˆæ¯ï¼ˆä¿ç•™ï¼‰
  2. æ‘˜è¦ï¼šè°ƒç”¨ LLM ç”Ÿæˆæ™ºèƒ½æ‘˜è¦
  3. åˆå¹¶ï¼š`[æ‘˜è¦æ¶ˆæ¯]` + æœ€è¿‘ 15 æ¡å®Œæ•´æ¶ˆæ¯
- **é™çº§æœºåˆ¶**ï¼šæ‘˜è¦å¤±è´¥æ—¶é™çº§åˆ°ç®€å•ä¿®å‰ª

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
// è‡ªåŠ¨è§¦å‘ï¼ˆAgent å†…éƒ¨ï¼‰
// å½“å†å²æ¶ˆæ¯ > 30 æ¡æ—¶ï¼Œè‡ªåŠ¨å‹ç¼©
const result = await agent.process("ç”¨æˆ·æ¶ˆæ¯", sessionId);

// æ‘˜è¦ä¼šè‡ªåŠ¨ç”Ÿæˆå¹¶ç¼“å­˜
// ä¸‹æ¬¡è°ƒç”¨æ—¶ä½¿ç”¨ç¼“å­˜ï¼ˆå¦‚æœæ¶ˆæ¯æœªå˜åŒ–ï¼‰
```

### 3. ç¼“å­˜æœºåˆ¶

**æ‘˜è¦ç¼“å­˜**ï¼š
- åŸºäºæ¶ˆæ¯å†…å®¹å“ˆå¸Œçš„ç¼“å­˜é”®
- TTL: 5 åˆ†é’Ÿï¼ˆå¯é…ç½®ï¼‰
- è‡ªåŠ¨æ¸…é™¤è¿‡æœŸç¼“å­˜

**API**ï¼š

```typescript
import { clearAllSummaryCache } from "@/utils/summarization.js";

// æ¸…é™¤æ‰€æœ‰ç¼“å­˜
clearAllSummaryCache();
```

---

## å‚è€ƒï¼šå…¶ä»– Agent çš„æ–¹æ¡ˆ

### openclaw-cn-ds çš„å‹ç¼©æœºåˆ¶

1. **Compactionï¼ˆå‹ç¼©ï¼‰**ï¼š
   - å°†æ—§å¯¹è¯æ‘˜è¦ä¸ºç´§å‡‘æ¡ç›®
   - æŒä¹…åŒ–åˆ° JSONL å†å²
   - è‡ªåŠ¨è§¦å‘ + æ‰‹åŠ¨è§¦å‘ï¼ˆ`/compact`ï¼‰

2. **Session Pruningï¼ˆä¿®å‰ªï¼‰**ï¼š
   - ä»…ä¿®å‰ªæ—§çš„å·¥å…·ç»“æœï¼ˆin-memoryï¼‰
   - ä¸ä¿®æ”¹ JSONL å†å²
   - æ¯æ¬¡è¯·æ±‚æ—¶åŠ¨æ€æ‰§è¡Œ

3. **Memory Flushï¼ˆå†…å­˜åˆ·æ–°ï¼‰**ï¼š
   - å‹ç¼©å‰è‡ªåŠ¨ä¿å­˜é‡è¦ä¿¡æ¯åˆ°ç£ç›˜
   - ç¡®ä¿å…³é”®ä¿¡æ¯ä¸ä¸¢å¤±

### Krebs çš„å®ç°

**å¯¹æ¯” openclaw-cn-ds**ï¼š
- âœ… å‚è€ƒ openclaw-cn-ds çš„è®¾è®¡æ€æƒ³
- âœ… é€‚é… Krebs çš„æ¶æ„
- âœ… ç®€åŒ–å®ç°ï¼ˆæ— éœ€ JSONL æŒä¹…åŒ–ï¼‰
- âœ… å¢å¼ºï¼šä½¿ç”¨ LLM æ™ºèƒ½æ‘˜è¦ï¼ˆè€Œéç®€å•ç»Ÿè®¡ï¼‰

---

## æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•

**æµ‹è¯•æ–‡ä»¶**ï¼š`test/utils/summarization.test.ts`

**è¦†ç›–åœºæ™¯**ï¼š
- âœ… LLM è°ƒç”¨æ­£ç¡®æ€§
- âœ… ç¼“å­˜æœºåˆ¶æœ‰æ•ˆæ€§
- âœ… é…ç½®é€‰é¡¹ï¼ˆdetailã€focusï¼‰
- âœ… é™çº§åœºæ™¯å¤„ç†

**è¿è¡Œæµ‹è¯•**ï¼š

```bash
npm test -- summarization.test.ts
```

### é›†æˆæµ‹è¯•

**éªŒè¯åœºæ™¯**ï¼š
- âœ… ä¸ Agent.process() çš„é›†æˆ
- âœ… ä¸ MemorySystem çš„å…¼å®¹æ€§
- âœ… é•¿å¯¹è¯åœºæ™¯éªŒè¯

---

## ä¸‹ä¸€æ­¥ä¼˜åŒ–

1. **å¼‚æ­¥æ‘˜è¦ç”Ÿæˆ**ï¼šåå°é¢„ç”Ÿæˆæ‘˜è¦ï¼ˆé¿å…ç­‰å¾…ï¼‰
2. **å¢é‡æ‘˜è¦**ï¼šåªæ‘˜è¦æ–°å¢çš„æ¶ˆæ¯ï¼ˆæå‡æ•ˆç‡ï¼‰
3. **å¤šçº§ç¼“å­˜**ï¼šå†…å­˜ç¼“å­˜ + ç£ç›˜ç¼“å­˜ï¼ˆæŒä¹…åŒ–ï¼‰
4. **ç”¨æˆ·æ§åˆ¶**ï¼šæ·»åŠ  `/compact` å‘½ä»¤ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
5. **æ‘˜è¦è´¨é‡è¯„ä¼°**ï¼šæ£€æµ‹æ‘˜è¦æ˜¯å¦åŒ…å«å…³é”®ä¿¡æ¯

---

## é™„å½•ï¼šé…ç½®å‚æ•°

### Agent å†…éƒ¨é…ç½®

```typescript
const keepRecentCount = 15;      // ä¿ç•™æœ€è¿‘ 15 æ¡å®Œæ•´æ¶ˆæ¯
const summaryThreshold = 30;     // è¶…è¿‡ 30 æ¡æ¶ˆæ¯æ‰è§¦å‘å‹ç¼©
const maxHistoryTokens = 8000;   // å†å²æ¶ˆæ¯çš„æœ€å¤§ token æ•°
```

### æ‘˜è¦é…ç½®

```typescript
{
  maxTokens: 1000,       // æ‘˜è¦æœ€å¤š 1000 tokens
  detail: "balanced",    // concise | balanced | detailed
  focus: "all",          // decisions | actions | all
  includeTimestamps: false
}
```

---

## ç›¸å…³æ–‡æ¡£

- [Context Window & Compaction (openclaw-cn-ds)](https://github.com/mariozhichn/openclaw-cn-ds/blob/main/docs/concepts/compaction.md)
- [Session Management (openclaw-cn-ds)](https://github.com/mariozhichn/openclaw-cn-ds/blob/main/docs/reference/session-management-compaction.md)
- [Agent Core Implementation](../src/agent/core/agent.ts)
- [Summarization Utility](../src/utils/summarization.ts)
