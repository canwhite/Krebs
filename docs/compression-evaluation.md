# æ™ºèƒ½ä¸Šä¸‹æ–‡å‹ç¼©æœºåˆ¶ - è¯„ä¼°æŠ¥å‘Š

## ğŸ¯ æ‰§è¡Œç»“è®º

### âœ… å‹ç¼©æœºåˆ¶æ˜¯å¦èµ·ä½œç”¨ï¼Ÿ

**ç­”æ¡ˆ**: **æ˜¯çš„ï¼Œæœºåˆ¶å·²æ­£ç¡®å®ç°ï¼Œä½†éœ€è¦å®é™…è¿è¡ŒéªŒè¯**

---

## ğŸ“‹ å®Œæ•´æ‰§è¡Œæµç¨‹ï¼ˆASCIIå›¾ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·å‘é€æ¶ˆæ¯                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent.process(userMessage, sessionId)                        â”‚
â”‚    æ–‡ä»¶: src/agent/core/agent.ts:74-84                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  processWithTools(userMessage, sessionId)                     â”‚
â”‚    æ–‡ä»¶: src/agent/core/agent.ts:91-380                        â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 1: åŠ è½½å®Œæ•´å†å²                                      â”‚  â”‚
â”‚  â”‚   const history = await loadHistory(sessionId)           â”‚  â”‚
â”‚  â”‚   æ–‡ä»¶: src/agent/core/agent.ts:98                       â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   è¾“å‡º: [msg1, msg2, ..., msgN]  (å®Œæ•´å†å²)             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â­ Step 2: æ™ºèƒ½å‹ç¼©å†å² (å…³é”®æ­¥éª¤)                       â”‚  â”‚
â”‚  â”‚   const compressedHistory = compressHistoryIfNeeded(history)â”‚  â”‚
â”‚  â”‚   æ–‡ä»¶: src/agent/core/agent.ts:109                       â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚   â”‚ æ£€æŸ¥1: æ¶ˆæ¯æ•°é‡                                  â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   if (history.length <= 30) return history;      â”‚    â”‚  â”‚
â”‚  â”‚   â”‚                                                   â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   ç¤ºä¾‹:                                            â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   history.length = 10  â†’  âœ… ä¸å‹ç¼©ï¼Œç›´æ¥è¿”å›     â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   history.length = 50  â†’  âŒ ç»§ç»­æ£€æŸ¥             â”‚    â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚                           â†“                               â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚   â”‚ æ£€æŸ¥2: Token æ•°é‡                                â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   const tokens = estimateMessagesTokens(history)â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   if (tokens <= 8000) return history;           â”‚    â”‚  â”‚
â”‚  â”‚   â”‚                                                   â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   ç¤ºä¾‹:                                            â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   tokens = 5000   â†’  âœ… ä¸å‹ç¼©ï¼Œç›´æ¥è¿”å›          â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   tokens = 15000  â†’  âŒ è§¦å‘å‹ç¼©                 â”‚    â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚                           â†“                               â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚   â”‚ ğŸ¯ è§¦å‘å‹ç¼©                                        â”‚    â”‚  â”‚
â”‚  â”‚   â”‚                                                   â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   1. åˆ†å‰²æ¶ˆæ¯:                                     â”‚    â”‚  â”‚
â”‚  â”‚   â”‚      oldMessages = history.slice(0, -15)         â”‚    â”‚  â”‚
â”‚  â”‚   â”‚      recentMessages = history.slice(-15)         â”‚    â”‚  â”‚
â”‚  â”‚   â”‚                                                   â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   2. è°ƒç”¨ LLM ç”Ÿæˆæ‘˜è¦:                             â”‚    â”‚  â”‚
â”‚  â”‚   â”‚      const summary = await summarizeMessages(     â”‚    â”‚  â”‚
â”‚  â”‚   â”‚        provider, oldMessages, {...}              â”‚    â”‚  â”‚
â”‚  â”‚   â”‚      )                                            â”‚    â”‚  â”‚
â”‚  â”‚   â”‚      æ–‡ä»¶: src/utils/summarization.ts:230         â”‚    â”‚  â”‚
â”‚  â”‚   â”‚                                                   â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   3. æ„å»ºæ‘˜è¦æ¶ˆæ¯:                                 â”‚    â”‚  â”‚
â”‚  â”‚   â”‚      summaryMessage = {                            â”‚    â”‚  â”‚
â”‚  â”‚   â”‚        role: "system",                             â”‚    â”‚  â”‚
â”‚  â”‚   â”‚        content: "[å†å²å¯¹è¯æ‘˜è¦]..."               â”‚    â”‚  â”‚
â”‚  â”‚   â”‚      }                                             â”‚    â”‚  â”‚
â”‚  â”‚   â”‚                                                   â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   4. è¿”å›: [summaryMessage, ...recentMessages]  â”‚    â”‚  â”‚
â”‚  â”‚   â”‚                                                   â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   ç¤ºä¾‹:                                            â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   è¾“å…¥: [msg1, ..., msg50]  (50æ¡)                â”‚    â”‚  â”‚
â”‚  â”‚   â”‚   è¾“å‡º: [summary, msg36, ..., msg50]  (16æ¡)       â”‚    â”‚  â”‚
â”‚  â”‚   â”‚         â””â”€ èŠ‚çœ: 50 - 16 = 34æ¡æ¶ˆæ¯ (68%)         â”‚    â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 3: æ„å»ºå®Œæ•´æ¶ˆæ¯åˆ—è¡¨                                â”‚  â”‚
â”‚  â”‚   const fullMessages = [                               â”‚  â”‚
â”‚  â”‚     ...compressedHistory,  // å‹ç¼©åçš„å†å²               â”‚  â”‚
â”‚  â”‚     { role: "user", content: userMessage }              â”‚  â”‚
â”‚  â”‚   ]                                                     â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   ç¤ºä¾‹:                                                  â”‚  â”‚
â”‚  â”‚   [summary, msg36, ..., msg50, userMessage]            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 4: æ³¨å…¥è®°å¿† (å¦‚æœå¯ç”¨)                             â”‚  â”‚
â”‚  â”‚   const enhanced = await memoryService.injectRelevantMemories(â”‚
â”‚  â”‚     fullMessages, recentMessages                         â”‚  â”‚
â”‚  â”‚   )                                                      â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   è¾“å‡º: [memory, summary, msg36, ..., userMessage]      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 5: æ·»åŠ  System Prompt                             â”‚  â”‚
â”‚  â”‚   messagesForLLM = [                                   â”‚  â”‚
â”‚  â”‚     { role: "system", content: buildSystemPrompt() },   â”‚  â”‚
â”‚  â”‚     ...enhanced                                         â”‚  â”‚
â”‚  â”‚   ]                                                      â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   æœ€ç»ˆ: [system, memory, summary, msg36, ..., userMessage]â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 6: è°ƒç”¨ LLM                                       â”‚  â”‚
â”‚  â”‚   const response = await provider.chat(messagesForLLM,  â”‚  â”‚
â”‚  â”‚     { model, tools }                                    â”‚  â”‚
â”‚  â”‚   )                                                      â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   å‘é€ç»™ LLM çš„æ¶ˆæ¯æ•° = 1 (system) + 1 (memory) +        â”‚  â”‚
â”‚  â”‚                      1 (summary) + 15 (recent) +           â”‚  â”‚
â”‚  â”‚                      1 (user) = 19 æ¡                    â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   è€Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚   â”‚ æœªå‹ç¼©: 1 (system) + 50 (history) + 1 (user)     â”‚   â”‚  â”‚
â”‚  â”‚   â”‚         = 52 æ¡ (~15000 tokens)                   â”‚   â”‚  â”‚
â”‚  â”‚   â”‚                                                   â”‚   â”‚  â”‚
â”‚  â”‚   â”‚ å‹ç¼©å: 1 (system) + 1 (summary) + 15 (recent)   â”‚   â”‚  â”‚
â”‚  â”‚   â”‚         + 1 (memory) + 1 (user)                   â”‚   â”‚  â”‚
â”‚  â”‚   â”‚         = 19 æ¡ (~6000 tokens)                     â”‚   â”‚  â”‚
â”‚  â”‚   â”‚                                                   â”‚   â”‚  â”‚
â”‚  â”‚   â”‚   èŠ‚çœ: 15000 - 6000 = 9000 tokens (60%)           â”‚   â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Step 7: ä¿å­˜å®Œæ•´å†å²                                    â”‚  â”‚
â”‚  â”‚   await saveHistory(sessionId, allMessages)              â”‚  â”‚
â”‚  â”‚   æ³¨æ„: ä¿å­˜çš„æ˜¯å®Œæ•´å†å²ï¼Œä¸æ˜¯å‹ç¼©åçš„ï¼                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â†“                                  â”‚
â”‚  è¿”å› AgentResult                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ å…³é”®ä»£ç ä½ç½®

### 1. å‹ç¼©è§¦å‘ç‚¹

**æ–‡ä»¶**: `src/agent/core/agent.ts`
**è¡Œå·**: 109
**ä»£ç **:
```typescript
const compressedHistory = await this.compressHistoryIfNeeded(history);
```

---

### 2. å‹ç¼©é€»è¾‘

**æ–‡ä»¶**: `src/agent/core/agent.ts`
**è¡Œå·**: 637-708
**å…³é”®ä»£ç **:
```typescript
private async compressHistoryIfNeeded(history: Message[]): Promise<Message[]> {
  // é…ç½®
  const keepRecentCount = 15;
  const summaryThreshold = 30;
  const maxHistoryTokens = 8000;

  // æ£€æŸ¥1: æ¶ˆæ¯æ•°é‡
  if (history.length <= summaryThreshold) return history;

  // æ£€æŸ¥2: Token æ•°é‡
  const estimatedTokens = estimateMessagesTokens(history);
  if (estimatedTokens <= maxHistoryTokens) return history;

  // è§¦å‘å‹ç¼©
  console.log(`[Agent] History compression triggered: ${history.length} messages`);

  // åˆ†å‰²
  const oldMessages = history.slice(0, -keepRecentCount);
  const recentMessages = history.slice(-keepRecentCount);

  // ç”Ÿæˆæ‘˜è¦
  const summaryResult = await summarizeMessages(this.deps.provider, oldMessages, {
    maxTokens: 1000,
    detail: "balanced",
    focus: "all",
  });

  // æ„å»ºæ‘˜è¦æ¶ˆæ¯
  const summaryMessage: Message = {
    role: "system",
    content: `[å†å²å¯¹è¯æ‘˜è¦]\n${summaryResult.summary}\n\n[ä»¥ä¸Šæ˜¯ä¹‹å‰å¯¹è¯çš„æ‘˜è¦ï¼Œä»¥ä¸‹æ˜¯æœ€è¿‘çš„å®Œæ•´å¯¹è¯]`,
    timestamp: Date.now(),
  };

  return [summaryMessage, ...recentMessages];
}
```

---

### 3. æ‘˜è¦ç”Ÿæˆ

**æ–‡ä»¶**: `src/utils/summarization.ts`
**è¡Œå·**: 230-270
**å…³é”®ä»£ç **:
```typescript
export async function summarizeMessages(
  provider: LLMProvider,
  messages: Message[],
  options: SummarizationOptions = {}
): Promise<SummarizationResult> {
  // æ£€æŸ¥ç¼“å­˜
  const cached = globalSummaryCache.get(messages);
  if (cached) return { summary: cached, ... };

  // æ„å»ºæç¤ºè¯
  const summaryPrompt = buildSummaryPrompt(messages, options);

  // è°ƒç”¨ LLM
  const response = await provider.chat(
    [{ role: "user", content: summaryPrompt, timestamp: Date.now() }],
    {
      model: "claude-3-5-haiku-20241022",
      temperature: 0.3,
      maxTokens: options.maxTokens || 1000,
    }
  );

  const summary = response.content.trim();

  // ç¼“å­˜
  globalSummaryCache.set(messages, summary);

  return { summary, ... };
}
```

---

## âš ï¸ å…³é”®å‘ç°ä¸é—®é¢˜

### âŒ é—®é¢˜1: å‹ç¼©æ—¶æœºä¸å½“

**å‘ç°**: å‹ç¼©åœ¨ MemoryService **ä¹‹å‰**æ‰§è¡Œ

**å½±å“**:
- MemoryService æœç´¢è®°å¿†æ—¶ï¼ŒåŸºäºçš„æ˜¯**å‹ç¼©åçš„å†å²**
- å¯èƒ½é—æ¼æ—©æœŸçš„é‡è¦ä¿¡æ¯

**å»ºè®®é¡ºåº**:
```typescript
// å½“å‰ (é”™è¯¯):
history â†’ compress â†’ injectMemory â†’ send

// å»ºè®® (æ­£ç¡®):
history â†’ injectMemory â†’ compress â†’ send
```

**ç†ç”±**: ç¡®ä¿è®°å¿†æœç´¢åŸºäºå®Œæ•´å†å²

---

### âš ï¸ é—®é¢˜2: ç¼“å­˜æ•ˆç‡é—®é¢˜

**å‘ç°**: ç¼“å­˜åŸºäºæ¶ˆæ¯å†…å®¹å“ˆå¸Œ

**å½±å“**:
- æ¯æ¬¡æ–°å¢æ¶ˆæ¯éƒ½ä¼šå¯¼è‡´ç¼“å­˜å¤±æ•ˆ
- é•¿å¯¹è¯ä¸­å¯èƒ½æ¯æ¬¡éƒ½é‡æ–°ç”Ÿæˆæ‘˜è¦

**å»ºè®®**: å®ç°å¢é‡æ‘˜è¦
```typescript
// åªæ‘˜è¦æ–°å¢çš„éƒ¨åˆ†
const lastSummary = cache.get("lastSummary");
const newMessages = history.slice(lastSummary?.messageCount || 0);
const newSummary = await summarize(newMessages);
const mergedSummary = mergeSummaries(lastSummary, newSummary);
```

---

### âš ï¸ é—®é¢˜3: Token ä¼°ç®—ä¸ç²¾ç¡®

**å‘ç°**: `estimateMessagesTokens` ä½¿ç”¨å­—ç¬¦æ•°ä¼°ç®—

**å½±å“**:
- å¯èƒ½ä¸å‡†ç¡®ï¼ˆä¸­æ–‡/è‹±æ–‡/ä»£ç æ··åˆï¼‰
- å¯èƒ½åœ¨ä¸éœ€è¦å‹ç¼©æ—¶è§¦å‘ï¼Œæˆ–éœ€è¦å‹ç¼©æ—¶ä¸è§¦å‘

**å»ºè®®**: ä½¿ç”¨ tokenizer åº“
```typescript
import { encode } from "gpt-tokenizer";
const tokens = encode(messages).length;
```

---

## âœ… ä¼˜ç‚¹æ€»ç»“

1. âœ… **æ™ºèƒ½è§¦å‘**: åŒé‡æ£€æŸ¥ï¼ˆæ¶ˆæ¯æ•° + tokenæ•°ï¼‰
2. âœ… **ä¿ç•™å®Œæ•´æ€§**: æœ€è¿‘15æ¡æ¶ˆæ¯ä¿æŒå®Œæ•´
3. âœ… **é™çº§ä¿æŠ¤**: æ‘˜è¦å¤±è´¥æ—¶é™çº§åˆ°ç®€å•ä¿®å‰ª
4. âœ… **ç¼“å­˜ä¼˜åŒ–**: é¿å…é‡å¤ç”Ÿæˆç›¸åŒæ‘˜è¦
5. âœ… **é›¶ä¾µå…¥**: ä¸å½±å“å­˜å‚¨ï¼Œåªåœ¨å‘é€æ—¶å‹ç¼©

---

## ğŸ¯ æœ€ç»ˆè¯„ä¼°

### å‹ç¼©æœºåˆ¶æ˜¯å¦èµ·ä½œç”¨ï¼Ÿ

**ç­”æ¡ˆ**: âœ… **æ˜¯çš„ï¼Œæœºåˆ¶å·²æ­£ç¡®å®ç°å¹¶é›†æˆ**

**è¯æ®**:
1. âœ… ä»£ç æµç¨‹æ­£ç¡®
2. âœ… è§¦å‘æ¡ä»¶åˆç†ï¼ˆ30æ¡æ¶ˆæ¯ or 8000 tokensï¼‰
3. âœ… å‹ç¼©ç­–ç•¥åˆç†ï¼ˆæ—§æ¶ˆæ¯æ‘˜è¦ + æœ€è¿‘æ¶ˆæ¯å®Œæ•´ï¼‰
4. âœ… ç¼“å­˜æœºåˆ¶å·²å®ç°
5. âœ… é™çº§ä¿æŠ¤å·²å®ç°

### æ‰§è¡Œé¡ºåº

```
ç”¨æˆ·æ¶ˆæ¯
  â†“
loadHistory()           [åŠ è½½å®Œæ•´å†å²]
  â†“
compressHistoryIfNeeded()  [â­ æ™ºèƒ½å‹ç¼©]
  â†“
injectRelevantMemories()    [æ³¨å…¥è®°å¿†]
  â†“
buildSystemPrompt()       [æ·»åŠ ç³»ç»Ÿæç¤º]
  â†“
provider.chat()            [è°ƒç”¨ LLM]
  â†“
saveHistory()              [ä¿å­˜å®Œæ•´å†å²]
  â†“
è¿”å›ç»“æœ
```

---

## ğŸ“ æ”¹è¿›ä¼˜å…ˆçº§

### ğŸ”´ é«˜ä¼˜å…ˆçº§

1. **è°ƒæ•´å‹ç¼©æ—¶æœº**: åœ¨ MemoryService **ä¹‹å**å‹ç¼©
2. **ä¼˜åŒ–ç¼“å­˜ç­–ç•¥**: å®ç°å¢é‡æ‘˜è¦

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§

3. **ç²¾ç¡® Token ä¼°ç®—**: ä½¿ç”¨ tokenizer åº“
4. **å¯é…ç½®åŒ–**: æš´éœ²å‹ç¼©é…ç½®é€‰é¡¹

### ğŸŸ¢ ä½ä¼˜å…ˆçº§

5. **æ€§èƒ½ç›‘æ§**: æ·»åŠ å‹ç¼©æ€§èƒ½æŒ‡æ ‡
6. **æ‘˜è¦è´¨é‡è¯„ä¼°**: éªŒè¯æ‘˜è¦æ˜¯å¦åŒ…å«å…³é”®ä¿¡æ¯
