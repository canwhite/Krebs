# Krebs å·¥å…·ç³»ç»Ÿå®Œæ•´æŒ‡å—

> ä»é›¶åˆ›å»ºå·¥å…·åˆ°ç³»ç»Ÿé›†æˆçš„å®Œæ•´æµç¨‹

## ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [å·¥å…·å®šä¹‰](#å·¥å…·å®šä¹‰)
3. [å·¥å…·åˆ›å»ºæµç¨‹](#å·¥å…·åˆ›å»ºæµç¨‹)
4. [å·¥å…·åŠ è½½æœºåˆ¶](#å·¥å…·åŠ è½½æœºåˆ¶)
5. [å¹³å°é€‚é…](#å¹³å°é€‚é…)
6. [å®Œæ•´ç¤ºä¾‹](#å®Œæ•´ç¤ºä¾‹)
7. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Krebs å·¥å…·ç³»ç»Ÿ                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  å·¥å…·å®šä¹‰å±‚   â”‚        â”‚  å·¥å…·æ³¨å†Œè¡¨   â”‚             â”‚
â”‚  â”‚  Tool Type   â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Registry    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                  â”‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  å·¥å…·ç­–ç•¥å±‚   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚             â”‚
â”‚  â”‚  Policy      â”‚        â”‚              â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚              â”‚             â”‚
â”‚                                  â”‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚              â”‚             â”‚
â”‚  â”‚  å¹³å°é€‚é…å±‚   â”‚        â”‚              â”‚             â”‚
â”‚  â”‚  Adapters    â”‚        â”‚              â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚              â”‚             â”‚
â”‚                                  â”‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚              â”‚             â”‚
â”‚  â”‚  LLM é›†æˆå±‚   â”‚        â”‚              â”‚             â”‚
â”‚  â”‚  Agent       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµå‘

```
1. å·¥å…·å®šä¹‰ (Tool)
   â†“
2. æ³¨å†Œåˆ°å·¥å…·åˆ—è¡¨ (getBuiltinTools)
   â†“
3. Agent åŠ è½½å·¥å…·
   â†“
4. åº”ç”¨ç­–ç•¥è¿‡æ»¤ (resolveToolPolicy)
   â†“
5. å¹³å°é€‚é… (adaptToolsForDeepSeek)
   â†“
6. ä¼ é€’ç»™ LLM (tools å‚æ•°)
   â†“
7. LLM è°ƒç”¨å·¥å…·
   â†“
8. Agent æ‰§è¡Œ (execute)
   â†“
9. è¿”å›ç»“æœç»™ LLM
```

---

## å·¥å…·å®šä¹‰

### Tool æ¥å£

**æ–‡ä»¶**: `src/agent/tools/types.ts`

```typescript
interface Tool {
  /** å·¥å…·åç§°ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰ */
  name: string;

  /** å·¥å…·æè¿°ï¼ˆLLM ä¼šçœ‹åˆ°è¿™ä¸ªæè¿°ï¼‰ */
  description: string;

  /** å‚æ•° Schema */
  inputSchema: ToolParameterSchema;

  /** æ‰§è¡Œå‡½æ•° */
  execute: (params: Record<string, unknown>) => Promise<ToolResult>;
}
```

### å‚æ•° Schema

```typescript
interface ToolParameterSchema {
  type: "object" | "string" | "number" | "boolean" | "array";
  description?: string;
  properties?: Record<string, ToolParameterSchema>;
  required?: string[];
}
```

### æ‰§è¡Œç»“æœ

```typescript
interface ToolResult {
  /** æ˜¯å¦æˆåŠŸæ‰§è¡Œ */
  success: boolean;

  /** è¿”å›çš„æ•°æ®ï¼ˆæˆåŠŸæ—¶ï¼‰ */
  data?: unknown;

  /** é”™è¯¯ä¿¡æ¯ï¼ˆå¤±è´¥æ—¶ï¼‰ */
  error?: string;

  /** è¾“å‡ºæ–‡æœ¬ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰ */
  output?: string;
}
```

---

## å·¥å…·åˆ›å»ºæµç¨‹

### æ­¥éª¤ 1: å®šä¹‰å·¥å…·ç»“æ„

åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œå¦‚ `src/agent/tools/my-tool.ts`:

```typescript
import { createLogger } from "@/shared/logger.js";
import type { Tool } from "./types.js";

const logger = createLogger("MyTool");

export const myTool: Tool = {
  name: "my_tool",
  description: "å·¥å…·çš„ç®€çŸ­æè¿°ï¼ŒLLM ä¼šæ ¹æ®è¿™ä¸ªæè¿°å†³å®šä½•æ—¶ä½¿ç”¨",
  inputSchema: {
    type: "object",
    properties: {
      param1: {
        type: "string",
        description: "å‚æ•°1çš„æè¿°",
      },
      param2: {
        type: "number",
        description: "å‚æ•°2çš„æè¿°ï¼ˆå¯é€‰ï¼‰",
      },
    },
    required: ["param1"],
  },

  async execute(params): Promise<{ success: boolean; data?: unknown; error?: string }> {
    // 1. æå–å‚æ•°
    const param1 = params.param1 as string;
    const param2 = params.param2 as number | undefined;

    // 2. å‚æ•°éªŒè¯
    if (!param1) {
      return {
        success: false,
        error: "param1 is required",
      };
    }

    try {
      logger.info(`Executing my_tool with param1=${param1}`);

      // 3. æ‰§è¡Œå·¥å…·é€»è¾‘
      const result = await doSomething(param1, param2);

      // 4. è¿”å›æˆåŠŸç»“æœ
      return {
        success: true,
        data: result,
      };
    } catch (error) {
      // 5. è¿”å›å¤±è´¥ç»“æœ
      const errorMessage = error instanceof Error ? error.message : String(error);
      logger.error(`my_tool failed: ${errorMessage}`);

      return {
        success: false,
        error: errorMessage,
      };
    }
  },
};

// è¾…åŠ©å‡½æ•°
async function doSomething(param1: string, param2?: number): Promise<any> {
  // å®ç°å…·ä½“çš„å·¥å…·é€»è¾‘
  return { result: "done" };
}
```

### æ­¥éª¤ 2: æ³¨å†Œå·¥å…·

**æ–‡ä»¶**: `src/agent/tools/builtin.ts`

```typescript
import { myTool } from "./my-tool.js";

export function getBuiltinTools(): Tool[] {
  return [
    bashTool,
    readTool,
    writeTool,
    editTool,
    webSearchTool,
    webFetchTool,
    myTool,  // âœ… æ·»åŠ æ–°å·¥å…·
  ];
}
```

### æ­¥éª¤ 3: å¯¼å‡ºå·¥å…·

**æ–‡ä»¶**: `src/agent/tools/index.ts`

```typescript
// æ–°å·¥å…·
export { myTool } from "./my-tool.js";
```

### æ­¥éª¤ 4: æ›´æ–°å·¥å…·åˆ†ç»„ï¼ˆå¯é€‰ï¼‰

**æ–‡ä»¶**: `src/agent/tools/groups.ts`

```typescript
export const TOOL_GROUPS: Record<string, string[]> = {
  // ... ç°æœ‰åˆ†ç»„

  // æ·»åŠ æ–°åˆ†ç»„
  "group:custom": ["my_tool", "another_tool"],
};
```

### æ­¥éª¤ 5: æµ‹è¯•å·¥å…·

åˆ›å»ºæµ‹è¯•æ–‡ä»¶ `test/test-my-tool.ts`:

```typescript
import { myTool } from "../src/agent/tools/my-tool.js";

async function test() {
  console.log("æµ‹è¯• my_tool:");

  // æµ‹è¯•æˆåŠŸæƒ…å†µ
  const result1 = await myTool.execute({
    param1: "test",
  });
  console.log("ç»“æœ1:", result1);

  // æµ‹è¯•å¤±è´¥æƒ…å†µ
  const result2 = await myTool.execute({
    param1: "",
  });
  console.log("ç»“æœ2:", result2);
}

test();
```

---

## å·¥å…·åŠ è½½æœºåˆ¶

### 1. å·¥å…·æ³¨å†Œæµç¨‹

```
getBuiltinTools() è¢«è°ƒç”¨
  â†“
è¿”å›æ‰€æœ‰å·¥å…·çš„æ•°ç»„
  â†“
Agent è·å–å·¥å…·åˆ—è¡¨
  â†“
å·¥å…·å¯ç”¨äºåç»­å¤„ç†
```

**ä»£ç ä½ç½®**: `src/agent/tools/builtin.ts`

```typescript
export function getBuiltinTools(): Tool[] {
  // è¿”å›æ‰€æœ‰å†…ç½®å·¥å…·
  return [
    bashTool,
    readTool,
    writeTool,
    editTool,
    webSearchTool,
    webFetchTool,
    // ... æ›´å¤šå·¥å…·
  ];
}
```

### 2. Agent åŠ è½½å·¥å…·

**æ–‡ä»¶**: `src/agent/core/agent.ts`

```typescript
export class Agent {
  private deps: {
    tools?: Tool[];  // å·¥å…·åˆ—è¡¨
  };

  constructor(config: AgentConfig, deps: AgentDeps) {
    this.deps = deps;
  }

  private async callLLM(messages: Message[]): Promise<any> {
    // å·¥å…·ä¼šé€šè¿‡ this.deps.tools ä¼ é€’
    return await this.deps.provider.chat(messages, {
      model: this.config.model,
      tools: this.deps.tools,  // âœ… å·¥å…·åœ¨è¿™é‡Œ
    });
  }
}
```

### 3. å·¥å…·ç­–ç•¥è¿‡æ»¤

**æ–‡ä»¶**: `src/agent/core/agent.ts` (é›†æˆç¤ºä¾‹)

```typescript
private async callLLM(messages: Message[]): Promise<any> {
  // 1. è§£æå·¥å…·ç­–ç•¥
  const policy = resolveToolPolicy(
    this.config.toolProfile,    // é…ç½®æ–‡ä»¶: minimal/coding/full
    this.config.toolAllowlist,   // è‡ªå®šä¹‰å…è®¸åˆ—è¡¨
    this.config.toolDenylist     // è‡ªå®šä¹‰ç¦æ­¢åˆ—è¡¨
  );

  // 2. è¿‡æ»¤å·¥å…·
  const filteredTools = filterToolsByPolicy(
    this.deps.tools || [],
    policy
  );

  // 3. è½¬æ¢ä¸ºå¹³å°æ ¼å¼
  const platform = this.inferProvider(this.config.model);
  const adaptedTools = this.adaptTools(filteredTools, platform);

  // 4. è°ƒç”¨ LLM
  return await this.deps.provider.chat(messages, {
    tools: adaptedTools,
  });
}
```

---

## å¹³å°é€‚é…

### ä¸ºä»€ä¹ˆéœ€è¦å¹³å°é€‚é…ï¼Ÿ

ä¸åŒçš„ LLM å¹³å°ä½¿ç”¨ä¸åŒçš„å·¥å…·æ ¼å¼ï¼š

| å¹³å° | å·¥å…·æ ¼å¼ | ç¤ºä¾‹ |
|------|---------|------|
| DeepSeek | OpenAI å…¼å®¹ | `{type: "function", function: {...}}` |
| OpenAI | OpenAI æ ¼å¼ | `{type: "function", function: {...}}` |
| Anthropic | åŸç”Ÿæ ¼å¼ | `{name: "...", input_schema: {...}}` |

### é€‚é…æµç¨‹

```
Krebs Tool (ç»Ÿä¸€æ ¼å¼)
  â†“
Platform Adapter (è½¬æ¢å™¨)
  â†“
Platform Specific Format (å¹³å°ç‰¹å®šæ ¼å¼)
  â†“
LLM API Call
```

### DeepSeek é€‚é…å™¨

**æ–‡ä»¶**: `src/agent/tools/adapters/deepseek.ts`

```typescript
export function adaptToolForDeepSeek(tool: Tool): DeepSeekToolDeclaration {
  return {
    type: "function",
    function: {
      name: tool.name,
      description: tool.description,
      parameters: {
        type: "object",
        properties: convertProperties(tool.inputSchema.properties || {}),
        required: tool.inputSchema.required || [],
      },
    },
  };
}

export function adaptToolsForDeepSeek(tools: Tool[]): DeepSeekToolDeclaration[] {
  return tools.map(adaptToolForDeepSeek);
}
```

### Anthropic é€‚é…å™¨

**æ–‡ä»¶**: `src/agent/tools/adapters/anthropic.ts`

```typescript
export function adaptToolForAnthropic(tool: Tool): AnthropicToolDeclaration {
  return {
    name: tool.name,
    description: tool.description,
    input_schema: {
      type: "object",
      properties: convertProperties(tool.inputSchema.properties || {}),
      required: tool.inputSchema.required || [],
    },
  };
}
```

### ä½¿ç”¨é€‚é…å™¨

```typescript
import { adaptToolsForDeepSeek } from '@/agent/tools/adapters/deepseek.js';
import { adaptToolsForAnthropic } from '@/agent/tools/adapters/anthropic.js';

// DeepSeek
const deepseekTools = adaptToolsForDeepSeek(tools);

// Anthropic
const anthropicTools = adaptToolsForAnthropic(tools);
```

---

## å®Œæ•´ç¤ºä¾‹

### ç¤ºä¾‹ï¼šåˆ›å»ºä¸€ä¸ªç®€å•çš„è®¡ç®—å™¨å·¥å…·

#### 1. å®šä¹‰å·¥å…·

**æ–‡ä»¶**: `src/agent/tools/calculator.ts`

```typescript
import { createLogger } from "@/shared/logger.js";
import type { Tool } from "./types.js";

const logger = createLogger("CalculatorTool");

export const calculatorTool: Tool = {
  name: "calculator",
  description: "Perform basic arithmetic calculations (add, subtract, multiply, divide).",
  inputSchema: {
    type: "object",
    properties: {
      operation: {
        type: "string",
        description: "Operation to perform: add, subtract, multiply, divide",
        enum: ["add", "subtract", "multiply", "divide"],
      },
      a: {
        type: "number",
        description: "First number",
      },
      b: {
        type: "number",
        description: "Second number",
      },
    },
    required: ["operation", "a", "b"],
  },

  async execute(params): Promise<{
    success: boolean;
    data?: { result: number; operation: string };
    error?: string;
  }> {
    const operation = params.operation as string;
    const a = params.a as number;
    const b = params.b as number;

    // å‚æ•°éªŒè¯
    if (!operation || typeof a !== "number" || typeof b !== "number") {
      return {
        success: false,
        error: "Invalid parameters: operation, a, and b are required",
      };
    }

    // æ£€æŸ¥é™¤é›¶
    if (operation === "divide" && b === 0) {
      return {
        success: false,
        error: "Division by zero is not allowed",
      };
    }

    try {
      let result: number;

      switch (operation) {
        case "add":
          result = a + b;
          break;
        case "subtract":
          result = a - b;
          break;
        case "multiply":
          result = a * b;
          break;
        case "divide":
          result = a / b;
          break;
        default:
          return {
            success: false,
            error: `Unknown operation: ${operation}`,
          };
      }

      logger.info(`Calculator: ${a} ${operation} ${b} = ${result}`);

      return {
        success: true,
        data: {
          result,
          operation: `${a} ${operation} ${b} = ${result}`,
        },
      };
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : String(error);
      logger.error(`Calculator error: ${errorMessage}`);

      return {
        success: false,
        error: errorMessage,
      };
    }
  },
};
```

#### 2. æ³¨å†Œå·¥å…·

**æ–‡ä»¶**: `src/agent/tools/builtin.ts`

```typescript
import { calculatorTool } from "./calculator.js";

export function getBuiltinTools(): Tool[] {
  return [
    bashTool,
    readTool,
    writeTool,
    editTool,
    webSearchTool,
    webFetchTool,
    calculatorTool,  // âœ… æ·»åŠ è®¡ç®—å™¨å·¥å…·
  ];
}
```

#### 3. å¯¼å‡ºå·¥å…·

**æ–‡ä»¶**: `src/agent/tools/index.ts`

```typescript
export { calculatorTool } from "./calculator.js";
```

#### 4. æµ‹è¯•å·¥å…·

**æ–‡ä»¶**: `test/test-calculator.ts`

```typescript
import { calculatorTool } from "../src/agent/tools/calculator.js";

async function test() {
  console.log("ğŸ§ª æµ‹è¯•è®¡ç®—å™¨å·¥å…·\n");

  // æµ‹è¯•åŠ æ³•
  const result1 = await calculatorTool.execute({
    operation: "add",
    a: 10,
    b: 5,
  });
  console.log("10 + 5 =", result1.success ? result1.data?.result : result1.error);

  // æµ‹è¯•é™¤æ³•
  const result2 = await calculatorTool.execute({
    operation: "divide",
    a: 20,
    b: 4,
  });
  console.log("20 / 4 =", result2.success ? result2.data?.result : result2.error);

  // æµ‹è¯•é™¤é›¶é”™è¯¯
  const result3 = await calculatorTool.execute({
    operation: "divide",
    a: 10,
    b: 0,
  });
  console.log("10 / 0 =", result3.success ? result3.data?.result : result3.error);
}

test();
```

#### 5. åœ¨ Agent ä¸­ä½¿ç”¨

```typescript
import { getBuiltinTools } from '@/agent/tools/index.js';
import { adaptToolsForDeepSeek } from '@/agent/tools/adapters/deepseek.js';

// Agent é…ç½®
const agent = new Agent({
  toolProfile: 'full',  // å…è®¸æ‰€æœ‰å·¥å…·
}, {
  tools: getBuiltinTools(),  // åŒ…å« calculatorTool
});

// LLM å¯ä»¥è°ƒç”¨è®¡ç®—å™¨
// ç”¨æˆ·: "è®¡ç®— 25 ä¹˜ä»¥ 4"
// Agent: è°ƒç”¨ calculator_tool
// ç»“æœ: 100
```

---

## æœ€ä½³å®è·µ

### 1. å·¥å…·å‘½åè§„èŒƒ

- âœ… ä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿: `web_search`, `read_file`
- âœ… åç§°åº”è¯¥æè¿°åŠŸèƒ½: `calculator`, `web_fetch`
- âŒ é¿å…ç¼©å†™: `ws` (åº”è¯¥æ˜¯ `web_search`)
- âŒ é¿å…å¤§å†™: `WebSearch`

### 2. å‚æ•°è®¾è®¡

```typescript
// âœ… å¥½çš„å‚æ•°è®¾è®¡
inputSchema: {
  type: "object",
  properties: {
    query: {
      type: "string",
      description: "Search query string",
    },
    count: {
      type: "number",
      description: "Number of results (1-10)",
    },
  },
  required: ["query"],
}

// âŒ ä¸å¥½çš„å‚æ•°è®¾è®¡
inputSchema: {
  type: "object",
  properties: {
    q: {  // å¤ªç®€çŸ­
      type: "string",
    },
    n: {  // ä¸æ¸…æ™°
      type: "number",
    },
  },
}
```

### 3. é”™è¯¯å¤„ç†

```typescript
async execute(params) {
  try {
    // 1. å‚æ•°éªŒè¯
    if (!params.requiredParam) {
      return {
        success: false,
        error: "requiredParam is required and must be...",
      };
    }

    // 2. æ‰§è¡Œé€»è¾‘
    const result = await doSomething(params);

    // 3. è¿”å›æˆåŠŸ
    return {
      success: true,
      data: result,
    };
  } catch (error) {
    // 4. è¿”å›å¤±è´¥
    return {
      success: false,
      error: error instanceof Error ? error.message : String(error),
    };
  }
}
```

### 4. æ—¥å¿—è®°å½•

```typescript
import { createLogger } from "@/shared/logger.js";

const logger = createLogger("MyTool");

async execute(params) {
  logger.debug(`Executing my_tool with params:`, params);

  try {
    const result = await doSomething(params);
    logger.info(`my_tool succeeded:`, result);
    return { success: true, data: result };
  } catch (error) {
    logger.error(`my_tool failed:`, error);
    return { success: false, error: error.message };
  }
}
```

### 5. è¶…æ—¶æ§åˆ¶

```typescript
// å¯¹äºç½‘ç»œæ“ä½œ
async execute(params) {
  const timeout = 10000; // 10ç§’

  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), timeout);

  try {
    const response = await fetch(url, {
      signal: controller.signal,
    });
    clearTimeout(timeoutId);
    // ...
  } catch (error) {
    if (error.name === 'AbortError') {
      return {
        success: false,
        error: `Request timeout after ${timeout}ms`,
      };
    }
  }
}
```

### 6. ç¼“å­˜æ”¯æŒ

```typescript
const cache = new Map<string, { data: any; timestamp: number }>();
const CACHE_TTL = 5 * 60 * 1000; // 5åˆ†é’Ÿ

async execute(params) {
  const cacheKey = JSON.stringify(params);

  // æ£€æŸ¥ç¼“å­˜
  const cached = cache.get(cacheKey);
  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
    return {
      success: true,
      data: cached.data,
      cached: true,
    };
  }

  // æ‰§è¡Œé€»è¾‘
  const result = await doSomething(params);

  // å†™å…¥ç¼“å­˜
  cache.set(cacheKey, {
    data: result,
    timestamp: Date.now(),
  });

  return {
    success: true,
    data: result,
  };
}
```

### 7. å®‰å…¨è€ƒè™‘

```typescript
async execute(params) {
  const url = params.url as string;

  // âœ… URL éªŒè¯ï¼ˆSSRF é˜²æŠ¤ï¼‰
  let validUrl: URL;
  try {
    validUrl = new URL(url);
    if (!["http:", "https:"].includes(validUrl.protocol)) {
      throw new Error("Only HTTP and HTTPS are allowed");
    }
  } catch {
    return {
      success: false,
      error: "Invalid URL",
    };
  }

  // âœ… å‘½ä»¤æ³¨å…¥é˜²æŠ¤
  const command = params.command as string;
  // éªŒè¯å‘½ä»¤ï¼Œé¿å… shell æ³¨å…¥

  // âœ… æ–‡ä»¶è·¯å¾„éªŒè¯
  const path = params.path as string;
  // ç¡®ä¿è·¯å¾„åœ¨å…è®¸çš„èŒƒå›´å†…
}
```

---

## å·¥å…·åŠ è½½æ—¶é—´çº¿

### åˆå§‹åŒ–é˜¶æ®µ

```
åº”ç”¨å¯åŠ¨
  â†“
Agent åˆ›å»º
  â†“
getBuiltinTools() è¢«è°ƒç”¨
  â†“
è¿”å›æ‰€æœ‰å·¥å…· (6ä¸ª)
  â†“
å·¥å…·å­˜å‚¨åœ¨ Agent å®ä¾‹ä¸­
```

### è¿è¡Œé˜¶æ®µ

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
  â†“
Agent.process() è¢«è°ƒç”¨
  â†“
è§£æå·¥å…·ç­–ç•¥ (resolveToolPolicy)
  â†“
è¿‡æ»¤å·¥å…· (filterToolsByPolicy)
  â†“
å¹³å°é€‚é… (adaptToolsForDeepSeek)
  â†“
å‘é€åˆ° LLM API
  â†“
LLM å†³å®šæ˜¯å¦è°ƒç”¨å·¥å…·
  â†“
Agent æ‰§è¡Œå·¥å…· (tool.execute())
  â†“
è¿”å›ç»“æœç»™ LLM
  â†“
LLM ç”Ÿæˆæœ€ç»ˆå›å¤
```

---

## è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹å·²æ³¨å†Œçš„å·¥å…·

```typescript
import { getBuiltinTools } from '@/agent/tools/index.js';

const tools = getBuiltinTools();
console.log("å·²æ³¨å†Œçš„å·¥å…·:");
tools.forEach(tool => {
  console.log(`- ${tool.name}: ${tool.description}`);
});
```

### 2. æµ‹è¯•å·¥å…·ç­–ç•¥

```typescript
import { getBuiltinTools, resolveToolPolicy, filterToolsByPolicy } from '@/agent/tools/index.js';

const allTools = getBuiltinTools();
const policy = resolveToolPolicy('coding');
const filtered = filterToolsByPolicy(allTools, policy);

console.log(`è¿‡æ»¤åå·¥å…·æ•°: ${filtered.length}`);
```

### 3. æŸ¥çœ‹å¹³å°é€‚é…ç»“æœ

```typescript
import { getBuiltinTools } from '@/agent/tools/index.js';
import { adaptToolsForDeepSeek } from '@/agent/tools/adapters/deepseek.js';

const tools = getBuiltinTools();
const adapted = adaptToolsForDeepSeek(tools);

console.log("DeepSeek æ ¼å¼:");
console.log(JSON.stringify(adapted, null, 2));
```

### 4. ç›´æ¥æµ‹è¯•å·¥å…·æ‰§è¡Œ

```typescript
import { webSearchTool } from '@/agent/tools/web.js';

const result = await webSearchTool.execute({
  query: "test",
  count: 3,
});

console.log("æ‰§è¡Œç»“æœ:", result);
```

---

## å¸¸è§é—®é¢˜

### Q1: å·¥å…·æ²¡æœ‰å‡ºç°åœ¨åˆ—è¡¨ä¸­ï¼Ÿ

**æ£€æŸ¥æ¸…å•**:
- âœ… å·¥å…·æ˜¯å¦æ·»åŠ åˆ° `getBuiltinTools()`?
- âœ… å·¥å…·æ˜¯å¦å¯¼å‡ºåˆ° `index.ts`?
- âœ… æ˜¯å¦é‡æ–°ç¼–è¯‘äº†é¡¹ç›® (`npm run build`)?

### Q2: LLM ä¸è°ƒç”¨æˆ‘çš„å·¥å…·ï¼Ÿ

**å¯èƒ½åŸå› **:
1. å·¥å…·æè¿°ä¸å¤Ÿæ¸…æ™°
2. å‚æ•°å®šä¹‰ä¸å®Œæ•´
3. å·¥å…·è¢«ç­–ç•¥è¿‡æ»¤æ‰äº†

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// 1. æ”¹è¿›å·¥å…·æè¿°
description: "æ˜ç¡®è¯´æ˜å·¥å…·çš„åŠŸèƒ½å’Œä½¿ç”¨åœºæ™¯"

// 2. æ£€æŸ¥å‚æ•°å®šä¹‰
required: ["param1", "param2"]

// 3. æ£€æŸ¥ç­–ç•¥é…ç½®
const policy = resolveToolPolicy('full'); // å…è®¸æ‰€æœ‰å·¥å…·
```

### Q3: å·¥å…·æ‰§è¡Œå¤±è´¥ä½†ä¸çŸ¥é“åŸå› ï¼Ÿ

**è°ƒè¯•æ–¹æ³•**:
```typescript
async execute(params) {
  // æ·»åŠ è¯¦ç»†æ—¥å¿—
  logger.debug("æ”¶åˆ°å‚æ•°:", params);
  logger.debug("å‚æ•°ç±»å‹:", typeof params.param1);

  try {
    const result = await doSomething(params);
    logger.info("æ‰§è¡ŒæˆåŠŸ:", result);
    return { success: true, data: result };
  } catch (error) {
    logger.error("æ‰§è¡Œå¤±è´¥:", error);
    logger.error("é”™è¯¯å †æ ˆ:", error.stack);
    return {
      success: false,
      error: error.message,
    };
  }
}
```

### Q4: å¦‚ä½•æ”¯æŒå·¥å…·çš„å¯é€‰æ‰§è¡Œï¼Ÿ

```typescript
async execute(params) {
  // æ£€æŸ¥ä¾èµ–
  if (params.requiresAPI && !process.env.API_KEY) {
    return {
      success: false,
      error: "API_KEY environment variable is required for this operation",
    };
  }

  // ç»§ç»­æ‰§è¡Œ...
}
```

---

## ç›¸å…³æ–‡æ¡£

- **å·¥å…·ç³»ç»ŸæŒ‡å—**: `TOOLS_SYSTEM.md`
- **å¹³å°é€‚é…å™¨**: `src/agent/tools/adapters/`
- **ç°æœ‰å·¥å…·ç¤ºä¾‹**: `src/agent/tools/web.ts`
- **å·¥å…·ç±»å‹å®šä¹‰**: `src/agent/tools/types.ts`

---

**æ›´æ–°æ—¶é—´**: 2026-02-05
**ç‰ˆæœ¬**: 1.0
**ç»´æŠ¤è€…**: Krebs Team
