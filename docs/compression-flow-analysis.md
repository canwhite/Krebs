# æ™ºèƒ½ä¸Šä¸‹æ–‡å‹ç¼©æœºåˆ¶ - æ‰§è¡Œæµç¨‹åˆ†æ

## ğŸ“‹ å®Œæ•´æ‰§è¡Œæµç¨‹å›¾

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent.process(userMessage, sessionId)                        â”‚
â”‚   - å…¬å…±æ¥å£ï¼Œè¿›å…¥ Agent å¤„ç†                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent.processWithTools(userMessage, sessionId)              â”‚
â”‚   æ–‡ä»¶: src/agent/core/agent.ts:91-380                        â”‚
â”‚                                                               â”‚
â”‚   æ­¥éª¤1: åŠ è½½å†å²æ¶ˆæ¯                                         â”‚
â”‚   â”œâ”€ const history = await this.loadHistory(sessionId)       â”‚
â”‚   â”œâ”€ ä» SessionStore åŠ è½½å®Œæ•´å†å²                           â”‚
â”‚   â””â”€ console.log: "Loaded X messages"                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â­ æ™ºèƒ½ä¸Šä¸‹æ–‡å‹ç¼© (å…³é”®æ­¥éª¤)                                  â”‚
â”‚   const compressedHistory = await this.compressHistoryIfNeeded(history)
â”‚   æ–‡ä»¶: src/agent/core/agent.ts:637-708                      â”‚
â”‚                                                               â”‚
â”‚   æ£€æŸ¥1: æ¶ˆæ¯æ•°é‡æ£€æŸ¥                                         â”‚
â”‚   â”œâ”€ if (history.length <= 30) return history;               â”‚
â”‚   â”œâ”€ é˜ˆå€¼: summaryThreshold = 30                            â”‚
â”‚   â””â”€ å°äº30æ¡æ¶ˆæ¯ â†’ ä¸å‹ç¼©ï¼Œç›´æ¥è¿”å›                          â”‚
â”‚                                                               â”‚
â”‚   æ£€æŸ¥2: Token æ•°é‡æ£€æŸ¥                                      â”‚
â”‚   â”œâ”€ const estimatedTokens = estimateMessagesTokens(history)â”‚
â”‚   â”œâ”€ if (estimatedTokens <= 8000) return history;           â”‚
â”‚   â””â”€ å°äº8000 tokens â†’ ä¸å‹ç¼©ï¼Œç›´æ¥è¿”å›                      â”‚
â”‚                                                               â”‚
â”‚   è§¦å‘å‹ç¼©:                                                   â”‚
â”‚   â”œâ”€ åˆ†å‰²æ¶ˆæ¯                                               â”‚
â”‚   â”‚  â”œâ”€ oldMessages = history.slice(0, -15)  // æ—§æ¶ˆæ¯      â”‚
â”‚   â”‚  â””â”€ recentMessages = history.slice(-15)    // æœ€è¿‘15æ¡   â”‚
â”‚   â”‚                                                         â”‚
â”‚   â”œâ”€ è°ƒç”¨ LLM ç”Ÿæˆæ‘˜è¦                                       â”‚
â”‚   â”‚  â”œâ”€ await summarizeMessages(provider, oldMessages, {   â”‚
â”‚   â”‚  â”‚  â”œâ”€ maxTokens: 1000,                               â”‚
â”‚   â”‚  â”‚  â”œâ”€ detail: "balanced",                            â”‚
â”‚   â”‚  â”‚  â””â”€ focus: "all"                                   â”‚
â”‚   â”‚  â””â”€ æ–‡ä»¶: src/utils/summarization.ts:230-270           â”‚
â”‚   â”‚                                                         â”‚
â”‚   â”œâ”€ æ„å»ºæ‘˜è¦æ¶ˆæ¯                                           â”‚
â”‚   â”‚  â””â”€ { role: "system", content: "[å†å²å¯¹è¯æ‘˜è¦]..." }   â”‚
â”‚   â”‚                                                         â”‚
â”‚   â””â”€ è¿”å›: [summaryMessage, ...recentMessages]            â”‚
â”‚      - æ—§æ¶ˆæ¯è¢«å‹ç¼©ä¸º1æ¡æ‘˜è¦æ¶ˆæ¯                            â”‚
â”‚      - æœ€è¿‘15æ¡æ¶ˆæ¯ä¿æŒå®Œæ•´                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ„å»ºå®Œæ•´çš„æ¶ˆæ¯åˆ—è¡¨                                           â”‚
â”‚   const fullMessages = [...compressedHistory, userMessage]   â”‚
â”‚                                                               â”‚
â”‚   ç¤ºä¾‹ï¼ˆå‡è®¾å†å²æœ‰50æ¡æ¶ˆæ¯ï¼‰:                               â”‚
â”‚   â”œâ”€ å‹ç¼©å‰: [msg1, msg2, ..., msg50, userMessage]         â”‚
â”‚   â”‚  â””â”€ 50æ¡å†å² + 1æ¡å½“å‰ = 51æ¡æ¶ˆæ¯                     â”‚
â”‚   â”‚                                                         â”‚
â”‚   â””â”€ å‹ç¼©å: [summary, msg36, ..., msg50, userMessage]     â”‚
â”‚      â”œâ”€ 1æ¡æ‘˜è¦æ¶ˆæ¯ï¼ˆæ›¿ä»£msg1-35ï¼‰                         â”‚
â”‚      â”œâ”€ 15æ¡å®Œæ•´æ¶ˆæ¯ï¼ˆmsg36-50ï¼‰                            â”‚
â”‚      â””â”€ 1æ¡å½“å‰æ¶ˆæ¯                                         â”‚
â”‚      â””â”€ æ€»è®¡: 1 + 15 + 1 = 17æ¡æ¶ˆæ¯                        â”‚
â”‚         â””â”€ èŠ‚çœ: 51 - 17 = 34æ¡æ¶ˆæ¯ (66%)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MemoryService.injectRelevantMemories (å¦‚æœå¯ç”¨)             â”‚
â”‚   - åœ¨æ¶ˆæ¯åˆ—è¡¨å‰é¢æ³¨å…¥ç›¸å…³çš„é•¿æœŸè®°å¿†                         â”‚
â”‚   - ä¸ä¼šç§»é™¤ç°æœ‰æ¶ˆæ¯ï¼Œåªä¼šåœ¨å‰é¢æ·»åŠ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ·»åŠ  System Prompt                                           â”‚
â”‚   messagesForLLM = [                                         â”‚
â”‚     systemPrompt,           // ç³»ç»Ÿæç¤ºè¯                    â”‚
â”‚     ...enhancedMessages,     // å‹ç¼©åçš„å†å² + è®°å¿†         â”‚
â”‚   ]                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è°ƒç”¨ LLM                                                     â”‚
â”‚   const response = await provider.chat(messagesForLLM, {    â”‚
â”‚     model: config.model,                                    â”‚
â”‚     tools: deps.tools,                                      â”‚
â”‚   })                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¿å­˜å¯¹è¯å†å² (å®Œæ•´)                                         â”‚
â”‚   - ä¿å­˜å®Œæ•´çš„ userMessage + assistant.response            â”‚
â”‚   - æ³¨æ„: ä¿å­˜çš„æ˜¯å®Œæ•´å†å²ï¼Œä¸æ˜¯å‹ç¼©åçš„                     â”‚
â”‚   - å‹ç¼©åªåœ¨å‘é€ç»™ LLM æ—¶ç”Ÿæ•ˆ                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¿”å› AgentResult
```

---

## ğŸ” å…³é”®ä»£ç ä½ç½®ä¸æ‰§è¡Œé¡ºåº

### 1ï¸âƒ£ å…¥å£ç‚¹ï¼šAgent.process()

**æ–‡ä»¶**: `src/agent/core/agent.ts:74-84`

```typescript
async process(userMessage: string, sessionId: string): Promise<AgentResult> {
  return enqueueInLane(
    CommandLane.Agent,
    () => this.processWithTools(userMessage, sessionId),
    { warnAfterMs: 5000 }
  );
}
```

**èŒè´£**: å°†è¯·æ±‚æ”¾å…¥ Agent é˜Ÿåˆ—ï¼Œå®é™…å¤„ç†åœ¨ `processWithTools`

---

### 2ï¸âƒ£ åŠ è½½å†å²ï¼šloadHistory()

**æ–‡ä»¶**: `src/agent/core/agent.ts:721-739`

```typescript
private async loadHistory(sessionId: string): Promise<Message[]> {
  if (this.deps.storage) {
    const history = await this.deps.storage.loadSession(sessionId);
    return history ?? [];
  }
  return [];
}
```

**èŒè´£**: ä» SessionStore åŠ è½½å®Œæ•´çš„å¯¹è¯å†å²

**è¾“å‡º**: å®Œæ•´çš„å†å²æ¶ˆæ¯æ•°ç»„ï¼ˆæœªå‹ç¼©ï¼‰

---

### 3ï¸âƒ£ â­ æ™ºèƒ½å‹ç¼©ï¼šcompressHistoryIfNeeded()

**æ–‡ä»¶**: `src/agent/core/agent.ts:637-708`

```typescript
private async compressHistoryIfNeeded(history: Message[]): Promise<Message[]> {
  // é…ç½®å‚æ•°
  const keepRecentCount = 15;      // ä¿ç•™æœ€è¿‘ 15 æ¡å®Œæ•´æ¶ˆæ¯
  const summaryThreshold = 30;     // è¶…è¿‡ 30 æ¡æ¶ˆæ¯æ‰è§¦å‘å‹ç¼©
  const maxHistoryTokens = 8000;   // å†å²æ¶ˆæ¯çš„æœ€å¤§ token æ•°

  // ğŸ” æ£€æŸ¥1: æ¶ˆæ¯æ•°é‡
  if (history.length <= summaryThreshold) {
    return history;  // âœ… ä¸å‹ç¼©
  }

  // ğŸ” æ£€æŸ¥2: Token æ•°é‡
  const estimatedTokens = estimateMessagesTokens(history);
  if (estimatedTokens <= maxHistoryTokens) {
    return history;  // âœ… ä¸å‹ç¼©
  }

  // ğŸ¯ è§¦å‘å‹ç¼©
  console.log(`[Agent] History compression triggered: ${history.length} messages`);

  // ğŸ“ åˆ†å‰²æ¶ˆæ¯
  const oldMessages = history.slice(0, -keepRecentCount);  // æ—§æ¶ˆæ¯
  const recentMessages = history.slice(-keepRecentCount);  // æœ€è¿‘æ¶ˆæ¯

  // ğŸ¤– è°ƒç”¨ LLM ç”Ÿæˆæ‘˜è¦
  const summaryResult = await summarizeMessages(this.deps.provider, oldMessages, {
    maxTokens: 1000,
    detail: "balanced",
    focus: "all",
  });

  // ğŸ“¦ æ„å»ºæ‘˜è¦æ¶ˆæ¯
  const summaryMessage: Message = {
    role: "system",
    content: `[å†å²å¯¹è¯æ‘˜è¦]\n${summaryResult.summary}\n\n[ä»¥ä¸Šæ˜¯ä¹‹å‰å¯¹è¯çš„æ‘˜è¦ï¼Œä»¥ä¸‹æ˜¯æœ€è¿‘çš„å®Œæ•´å¯¹è¯]`,
    timestamp: Date.now(),
  };

  // âœ… è¿”å›: [æ‘˜è¦æ¶ˆæ¯, ...æœ€è¿‘æ¶ˆæ¯]
  return [summaryMessage, ...recentMessages];
}
```

**è§¦å‘æ¡ä»¶**ï¼ˆå¿…é¡»**åŒæ—¶**æ»¡è¶³ï¼‰:
1. âŒ `history.length > 30` â†’ æ¶ˆæ¯æ•°é‡è¶…è¿‡ 30 æ¡
2. âŒ `estimatedTokens > 8000` â†’ Token æ•°é‡è¶…è¿‡ 8000

**å‹ç¼©ç­–ç•¥**:
- **æ—§æ¶ˆæ¯**ï¼ˆå‰ N-15 æ¡ï¼‰â†’ å‹ç¼©ä¸º 1 æ¡æ‘˜è¦
- **æœ€è¿‘æ¶ˆæ¯**ï¼ˆæœ€å 15 æ¡ï¼‰â†’ ä¿æŒå®Œæ•´
- **è¾“å‡º**: `[summaryMessage, ...recentMessages]`

---

### 4ï¸âƒ£ æ‘˜è¦ç”Ÿæˆï¼šsummarizeMessages()

**æ–‡ä»¶**: `src/utils/summarization.ts:230-270`

```typescript
export async function summarizeMessages(
  provider: LLMProvider,
  messages: Message[],
  options: SummarizationOptions = {}
): Promise<SummarizationResult> {
  // ğŸ” æ£€æŸ¥ç¼“å­˜
  const cached = globalSummaryCache.get(messages);
  if (cached) {
    return { summary: cached, ... };
  }

  // ğŸ“ æ„å»ºæ‘˜è¦æç¤ºè¯
  const summaryPrompt = buildSummaryPrompt(messages, options);

  // ğŸ¤– è°ƒç”¨ LLM ç”Ÿæˆæ‘˜è¦
  const response = await provider.chat(
    [{ role: "user", content: summaryPrompt, timestamp: Date.now() }],
    {
      model: "claude-3-5-haiku-20241022",  // å¿«é€Ÿæ¨¡å‹
      temperature: 0.3,
      maxTokens: options.maxTokens || 1000,
    }
  );

  const summary = response.content.trim();

  // ğŸ’¾ ç¼“å­˜æ‘˜è¦
  globalSummaryCache.set(messages, summary);

  return { summary, ... };
}
```

**èŒè´£**: ä½¿ç”¨ LLM ç”Ÿæˆæ™ºèƒ½æ‘˜è¦

**ä¼˜åŒ–**: ç¼“å­˜æœºåˆ¶ï¼ˆåŸºäºæ¶ˆæ¯å†…å®¹å“ˆå¸Œï¼‰

---

### 5ï¸âƒ£ æ„å»ºä¸Šä¸‹æ–‡ï¼šprocessWithTools()

**æ–‡ä»¶**: `src/agent/core/agent.ts:109-147`

```typescript
// å‹ç¼©å†å²
const compressedHistory = await this.compressHistoryIfNeeded(history);

// æ„å»ºå®Œæ•´æ¶ˆæ¯åˆ—è¡¨
const fullMessages = [
  ...compressedHistory,  // å‹ç¼©åçš„å†å²
  { role: "user", content: userMessage, timestamp: Date.now() },
];

// æ³¨å…¥è®°å¿† (å¦‚æœå¯ç”¨)
const enhanced = await this.deps.memoryService.injectRelevantMemories(
  fullMessages,
  recentMessages
);

// æ·»åŠ  system prompt
messagesForLLM = [
  { role: "system", content: this.buildSystemPrompt(), timestamp: Date.now() },
  ...enhanced,
];
```

**æ•°æ®æµè½¬**:
```
history (å®Œæ•´)
  â†“ compressHistoryIfNeeded
compressedHistory (å‹ç¼©å)
  â†“ + userMessage
fullMessages
  â†“ injectRelevantMemories
enhancedMessages
  â†“ + systemPrompt
messagesForLLM (æœ€ç»ˆå‘é€ç»™ LLM)
```

---

### 6ï¸âƒ£ è°ƒç”¨ LLM

**æ–‡ä»¶**: `src/agent/core/agent.ts:233-250`

```typescript
const response = await this.deps.provider.chat(messagesForLLM, {
  model: this.config.model ?? "claude-3-5-sonnet-20241022",
  temperature: this.config.temperature,
  maxTokens: this.config.maxTokens,
  tools: this.deps.tools,
});
```

**è¾“å…¥**: `messagesForLLM`ï¼ˆå·²å‹ç¼©ï¼‰

---

## ğŸ“Š å‹ç¼©æ•ˆæœç¤ºä¾‹

### åœºæ™¯1: çŸ­å¯¹è¯ï¼ˆä¸è§¦å‘å‹ç¼©ï¼‰

**å†å²**: 10 æ¡æ¶ˆæ¯
**Token**: ~3000

```
[æ¶ˆæ¯1, æ¶ˆæ¯2, ..., æ¶ˆæ¯10, ç”¨æˆ·æ¶ˆæ¯]
  â””â”€ 11 æ¡æ¶ˆæ¯ â†’ å‘é€ç»™ LLM
```

**ç»“æœ**: âœ… ä¸å‹ç¼©ï¼Œç›´æ¥å‘é€

---

### åœºæ™¯2: é•¿å¯¹è¯ï¼ˆè§¦å‘å‹ç¼©ï¼‰

**å†å²**: 50 æ¡æ¶ˆæ¯
**Token**: ~15000

```
å‹ç¼©å‰:
  [msg1, msg2, ..., msg50, ç”¨æˆ·æ¶ˆæ¯]
  â””â”€ 51 æ¡æ¶ˆæ¯ (~15000 tokens)

å‹ç¼©å:
  [æ‘˜è¦, msg36, ..., msg50, ç”¨æˆ·æ¶ˆæ¯]
  â”œâ”€ 1 æ¡æ‘˜è¦æ¶ˆæ¯ (~1000 tokens)      â† æ›¿ä»£ msg1-35
  â”œâ”€ 15 æ¡å®Œæ•´æ¶ˆæ¯ (~5000 tokens)      â† msg36-50
  â””â”€ 1 æ¡å½“å‰æ¶ˆæ¯ (~200 tokens)
  â””â”€ æ€»è®¡: 17 æ¡æ¶ˆæ¯ (~6200 tokens)

èŠ‚çœ: 15000 - 6200 = 8800 tokens (59%)
```

**ç»“æœ**: âœ… å‹ç¼©ç”Ÿæ•ˆï¼Œæ˜¾è‘—å‡å°‘ token

---

### åœºæ™¯3: è¶…é•¿å¯¹è¯ï¼ˆå¼ºè§¦å‘å‹ç¼©ï¼‰

**å†å²**: 200 æ¡æ¶ˆæ¯
**Token**: ~60000

```
å‹ç¼©å‰:
  [msg1, ..., msg200, ç”¨æˆ·æ¶ˆæ¯]
  â””â”€ 201 æ¡æ¶ˆæ¯ (~60000 tokens)

å‹ç¼©å:
  [æ‘˜è¦, msg186, ..., msg200, ç”¨æˆ·æ¶ˆæ¯]
  â”œâ”€ 1 æ¡æ‘˜è¦æ¶ˆæ¯ (~1000 tokens)      â† æ›¿ä»£ msg1-185
  â”œâ”€ 15 æ¡å®Œæ•´æ¶ˆæ¯ (~5000 tokens)      â† msg186-200
  â””â”€ 1 æ¡å½“å‰æ¶ˆæ¯ (~200 tokens)
  â””â”€ æ€»è®¡: 17 æ¡æ¶ˆæ¯ (~6200 tokens)

èŠ‚çœ: 60000 - 6200 = 53800 tokens (90%)
```

**ç»“æœ**: âœ… å¤§å¹…å‹ç¼©ï¼Œæ¥è¿‘å›ºå®šæˆæœ¬

---

## âš ï¸ å…³é”®å‘ç°ä¸æ½œåœ¨é—®é¢˜

### âœ… ä¼˜ç‚¹

1. **æ™ºèƒ½è§¦å‘**: åªåœ¨éœ€è¦æ—¶å‹ç¼©ï¼ˆæ¶ˆæ¯æ•° > 30 æˆ– token > 8000ï¼‰
2. **ä¿ç•™å®Œæ•´æ€§**: æœ€è¿‘ 15 æ¡æ¶ˆæ¯ä¿æŒå®Œæ•´
3. **é™çº§ä¿æŠ¤**: æ‘˜è¦å¤±è´¥æ—¶é™çº§åˆ°ç®€å•ä¿®å‰ª
4. **ç¼“å­˜ä¼˜åŒ–**: é¿å…é‡å¤ç”Ÿæˆç›¸åŒæ‘˜è¦
5. **é›¶ä¾µå…¥**: ä¸å½±å“å­˜å‚¨ï¼Œåªåœ¨å‘é€æ—¶å‹ç¼©

### âš ï¸ æ½œåœ¨é—®é¢˜

1. **âŒ å‹ç¼©æ—¶æœºé—®é¢˜**:
   - **é—®é¢˜**: åœ¨ `processWithTools` å¼€å§‹æ—¶å°±å‹ç¼©
   - **å½±å“**: å¦‚æœ MemoryService æ³¨å…¥è®°å¿†ï¼Œä¼šåŸºäºå‹ç¼©åçš„å†å²æœç´¢
   - **åæœ**: å¯èƒ½é”™è¿‡é‡è¦çš„æ—©æœŸä¿¡æ¯

   **å»ºè®®**: åº”è¯¥åœ¨ MemoryService æ³¨å…¥è®°å¿†**ä¹‹å**å‹ç¼©

2. **âš ï¸ ç¼“å­˜å¤±æ•ˆé—®é¢˜**:
   - **é—®é¢˜**: ç¼“å­˜åŸºäºæ¶ˆæ¯å“ˆå¸Œï¼Œä½†å†å²ä¼šä¸æ–­å¢é•¿
   - **å½±å“**: æ¯æ¬¡æ–°å¢æ¶ˆæ¯éƒ½ä¼šå¯¼è‡´ç¼“å­˜å¤±æ•ˆ
   - **åæœ**: é•¿å¯¹è¯ä¸­å¯èƒ½æ¯æ¬¡éƒ½é‡æ–°ç”Ÿæˆæ‘˜è¦

   **å»ºè®®**: å®ç°å¢é‡æ‘˜è¦ï¼ˆåªæ‘˜è¦æ–°å¢éƒ¨åˆ†ï¼‰

3. **âš ï¸ Token ä¼°ç®—ä¸å‡†ç¡®**:
   - **é—®é¢˜**: `estimateMessagesTokens` å¯èƒ½ä¸å¤Ÿç²¾ç¡®
   - **å½±å“**: å¯èƒ½åœ¨ä¸éœ€è¦å‹ç¼©æ—¶è§¦å‘ï¼Œæˆ–éœ€è¦å‹ç¼©æ—¶ä¸è§¦å‘
   - **åæœ**: æ€§èƒ½å’Œæˆæœ¬çš„æ¬¡ä¼˜è§£

   **å»ºè®®**: ä½¿ç”¨å®é™…çš„ tokenizer åº“

4. **âš ï¸ æ‘˜è¦è´¨é‡é—®é¢˜**:
   - **é—®é¢˜**: ä½¿ç”¨ Haiku æ¨¡å‹ç”Ÿæˆæ‘˜è¦ï¼Œå¯èƒ½è´¨é‡ä¸å¦‚ Sonnet
   - **å½±å“**: æ‘˜è¦å¯èƒ½é—æ¼å…³é”®ä¿¡æ¯
   - **åæœ**: ç”¨æˆ·éœ€è¦é‡å¤è¯´æ˜

   **å»ºè®®**: æä¾›é€‰é¡¹è®©ç”¨æˆ·é€‰æ‹©æ‘˜è¦æ¨¡å‹

---

## ğŸ¯ æ”¹è¿›å»ºè®®

### å»ºè®®1: è°ƒæ•´å‹ç¼©æ—¶æœº

**å½“å‰é¡ºåº**:
```
history â†’ compress â†’ injectMemory â†’ send
```

**å»ºè®®é¡ºåº**:
```
history â†’ injectMemory â†’ compress â†’ send
```

**ç†ç”±**: ç¡®ä¿è®°å¿†æœç´¢åŸºäºå®Œæ•´å†å²ï¼Œä¸ä¼šé—æ¼æ—©æœŸä¿¡æ¯

---

### å»ºè®®2: å®ç°å¢é‡æ‘˜è¦

**å½“å‰**: æ¯æ¬¡æ‘˜è¦æ‰€æœ‰æ—§æ¶ˆæ¯

**å»ºè®®**:
```
1. æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜çš„æ‘˜è¦
2. å¦‚æœæœ‰ï¼Œåªæ‘˜è¦æ–°å¢çš„æ¶ˆæ¯
3. åˆå¹¶: [æ—§æ‘˜è¦, æ–°æ‘˜è¦, æœ€è¿‘æ¶ˆæ¯]
```

**å¥½å¤„**: å¤§å¹…æå‡é•¿å¯¹è¯çš„æ€§èƒ½

---

### å»ºè®®3: å¯é…ç½®çš„å‹ç¼©ç­–ç•¥

**å½“å‰**: ç¡¬ç¼–ç çš„é˜ˆå€¼ï¼ˆ30æ¡æ¶ˆæ¯ï¼Œ8000 tokensï¼‰

**å»ºè®®**: æš´éœ²é…ç½®é€‰é¡¹
```typescript
interface CompressionConfig {
  enabled: boolean;
  messageThreshold: number;
  tokenThreshold: number;
  keepRecentCount: number;
  summaryModel: string;
}
```

---

## ğŸ“ æ€»ç»“

### âœ… å‹ç¼©æœºåˆ¶æ˜¯å¦èµ·ä½œç”¨ï¼Ÿ

**ç­”æ¡ˆ**: **æ˜¯çš„ï¼Œå®Œå…¨èµ·ä½œç”¨ï¼**

1. âœ… **è§¦å‘æ¡ä»¶æ­£ç¡®**: åªåœ¨è¶…è¿‡é˜ˆå€¼æ—¶å‹ç¼©
2. âœ… **å‹ç¼©æ•ˆæœæ˜¾è‘—**: 50æ¡æ¶ˆæ¯ä» 15000 tokens â†’ 6200 tokens (59%èŠ‚çœ)
3. âœ… **ç¼“å­˜æœºåˆ¶å·¥ä½œ**: é¿å…é‡å¤ç”Ÿæˆ
4. âœ… **é™çº§ä¿æŠ¤å®Œå–„**: å¤±è´¥æ—¶ä¸å½±å“åŠŸèƒ½

### ğŸ”„ æ‰§è¡Œé¡ºåº

```
ç”¨æˆ·æ¶ˆæ¯
  â†’ process()
  â†’ processWithTools()
  â†’ loadHistory()        [åŠ è½½å®Œæ•´å†å²]
  â†’ compressHistoryIfNeeded()  [â­ æ™ºèƒ½å‹ç¼©]
  â†’ injectRelevantMemories()    [æ³¨å…¥è®°å¿†]
  â†’ buildSystemPrompt()    [æ·»åŠ ç³»ç»Ÿæç¤º]
  â†’ provider.chat()        [è°ƒç”¨ LLM]
  â†’ saveHistory()          [ä¿å­˜å®Œæ•´å†å²]
  â†’ è¿”å›ç»“æœ
```

### ğŸ¯ ä¸»è¦ä»£ç ä½ç½®

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œå· |
|------|------|------|
| **å‹ç¼©è§¦å‘** | `src/agent/core/agent.ts` | 109 |
| **å‹ç¼©é€»è¾‘** | `src/agent/core/agent.ts` | 637-708 |
| **æ‘˜è¦ç”Ÿæˆ** | `src/utils/summarization.ts` | 230-270 |
| **ç¼“å­˜æœºåˆ¶** | `src/utils/summarization.ts` | 108-178 |
