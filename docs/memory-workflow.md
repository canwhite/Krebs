# Memory å·¥ä½œæµç¨‹å›¾

> **Krebs Memory ç³»ç»Ÿ** - å®Œæ•´å·¥ä½œæµç¨‹å¯è§†åŒ–
>
> æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ Memory ç³»ç»Ÿåœ¨ Agent å¯¹è¯ä¸­çš„å®Œæ•´å·¥ä½œæµç¨‹

---

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ç”¨æˆ·å‘èµ·å¯¹è¯                                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AgentManager.start()                                 â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åˆ›å»º MemoryService                                                     â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  new MemoryService({                                                  â”‚   â”‚
â”‚  â”‚    dataDir: "./data",           â† Memory å­˜å‚¨ç›®å½•                        â”‚   â”‚
â”‚  â”‚    searchEnabled: true,         â† å¯ç”¨æœç´¢                                â”‚   â”‚
â”‚  â”‚    autoSaveEnabled: true,         â† å¯ç”¨è‡ªåŠ¨ä¿å­˜                            â”‚   â”‚
â”‚  â”‚  })                                                                   â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  await memoryService.start()      â† å¯åŠ¨æ–‡ä»¶ç›‘å¬å’Œç´¢å¼•                    â”‚   â”‚
â”‚  â”‚  â””â”€ å¯åŠ¨ chokidar ç›‘å¬ data/memory/                                     â”‚   â”‚
â”‚  â”‚  â””â”€ åˆå§‹ç´¢å¼•ï¼ˆæ‰«æå¹¶åˆ†å— Markdown æ–‡ä»¶ï¼‰                                â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AgentManager.createAgent()                              â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åˆ›å»º Agent å¹¶æ³¨å…¥ MemoryService                                         â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  const agentDeps = {                                                 â”‚   â”‚
â”‚  â”‚    ...deps,                                                            â”‚   â”‚
â”‚  â”‚    skillsManager,                                                       â”‚   â”‚
â”‚  â”‚    memoryService: this.memoryService,  â† æ³¨å…¥ MemoryService              â”‚   â”‚
â”‚  â”‚  }                                                                    â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  new Agent(agentConfig, agentDeps)                                     â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Agent.process(userMessage, sessionId)                     â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        æ­¥éª¤ 1: è‡ªåŠ¨æ³¨å…¥ç›¸å…³è®°å¿†                        â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  1.1 æå–æœ€è¿‘æ¶ˆæ¯ï¼ˆç”¨äºæœç´¢æŸ¥è¯¢ï¼‰                                   â”‚   â”‚
â”‚  â”‚      recentMessages = history.slice(-5)                                  â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  1.2 è°ƒç”¨ MemoryService.injectRelevantMemories()                        â”‚   â”‚
â”‚  â”‚      enhanced = await memoryService.injectRelevantMemories(              â”‚   â”‚
â”‚  â”‚        [userMessage],                                               â”‚   â”‚
â”‚  â”‚        recentMessages                                                  â”‚   â”‚
â”‚  â”‚      )                                                                 â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  1.3 MemoryService å†…éƒ¨æµç¨‹ï¼š                                          â”‚   â”‚
â”‚  â”‚      â”œâ”€ æå–æœç´¢æŸ¥è¯¢ï¼ˆä»æœ€è¿‘æ¶ˆæ¯ï¼‰                                 â”‚   â”‚
â”‚  â”‚      â”œâ”€ è°ƒç”¨ manager.search()                                         â”‚   â”‚
â”‚  â”‚      â”‚   â”œâ”€ ä¼šè¯é¢„çƒ­ï¼ˆå¦‚é…ç½®ï¼‰                                       â”‚   â”‚
â”‚  â”‚      â”‚   â”œâ”€ è‡ªåŠ¨åŒæ­¥ï¼ˆæ£€æŸ¥ dirty æ ‡å¿—ï¼‰                               â”‚   â”‚
â”‚  â”‚      â”‚   â”œâ”€ ç”ŸæˆæŸ¥è¯¢çš„ embedding                                      â”‚   â”‚
â”‚  â”‚      â”‚   â”œâ”€ å‘é‡æœç´¢ï¼ˆsqlite-vecï¼‰                                     â”‚   â”‚
â”‚  â”‚      â”‚   â”œâ”€ å…¨æ–‡æœç´¢ï¼ˆFTS5ï¼Œå¯é€‰ï¼‰                                   â”‚   â”‚
â”‚  â”‚      â”‚   â”œâ”€ åˆå¹¶ç»“æœï¼ˆæ··åˆæœç´¢ï¼‰                                     â”‚   â”‚
â”‚  â”‚      â”‚   â””â”€ è¿‡æ»¤ä½åˆ†ç»“æœ                                           â”‚   â”‚
â”‚  â”‚      â””â”€ æ„å»ºè®°å¿†ä¸Šä¸‹æ–‡å¹¶æ³¨å…¥                                        â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  1.4 æ„å»ºå¢å¼ºæ¶ˆæ¯åˆ—è¡¨                                              â”‚   â”‚
â”‚  â”‚      messagesForLLM = [                                              â”‚   â”‚
â”‚  â”‚        { role: "system", content: "[ç›¸å…³è®°å¿†]\n..." },  â† è®°å¿†æ³¨å…¥  â”‚   â”‚
â”‚  â”‚        ...history,                                                   â”‚   â”‚
â”‚  â”‚        { role: "user", content: userMessage }                       â”‚   â”‚
â”‚  â”‚      ]                                                                 â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  1.5 é”™è¯¯å¤„ç†ï¼šæ³¨å…¥å¤±è´¥æ—¶é™çº§åˆ°æ™®é€šæµç¨‹                              â”‚   â”‚
â”‚  â”‚      try { enhanced = await ... }                                       â”‚   â”‚
â”‚  â”‚      catch { use normal flow }                                         â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        æ­¥éª¤ 2: å·¥å…·è°ƒç”¨å¾ªç¯                                â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  while (iteration < maxIterations) {                                     â”‚   â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚    â”‚ 2.1 è°ƒç”¨ LLMï¼ˆä½¿ç”¨å¢å¼ºæ¶ˆæ¯ï¼ŒåŒ…å«è®°å¿†ï¼‰                        â”‚  â”‚   â”‚
â”‚  â”‚    â”‚                                                                  â”‚  â”‚   â”‚
â”‚  â”‚    â”‚    response = await provider.chat(messagesForLLM)                   â”‚  â”‚   â”‚
â”‚  â”‚    â”‚                                                                  â”‚  â”‚   â”‚
â”‚  â”‚    â”‚    2.2 æ£€æŸ¥æ˜¯å¦æœ‰ tool_calls                                   â”‚  â”‚   â”‚
â”‚  â”‚    â”‚                                                                  â”‚  â”‚   â”‚
â”‚  â”‚    â”‚    if (response.toolCalls && response.toolCalls.length > 0) {           â”‚  â”‚   â”‚
â”‚  â”‚    â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚   â”‚
â”‚  â”‚    â”‚      â”‚ 2.3 æ‰§è¡Œå·¥å…·ï¼ˆå¹¶è¡Œï¼‰                                       â”‚  â”‚   â”‚   â”‚
â”‚  â”‚    â”‚      â”‚                                                          â”‚  â”‚   â”‚   â”‚
â”‚  â”‚    â”‚      â”‚      toolResults = await Promise.allSettled([               â”‚  â”‚   â”‚   â”‚
â”‚  â”‚    â”‚      â”‚        executeTool(tool) for tool in response.toolCalls â”‚  â”‚   â”‚   â”‚
â”‚  â”‚    â”‚      â”‚      ])                                                        â”‚  â”‚   â”‚
â”‚  â”‚    â”‚      â”‚                                                          â”‚  â”‚   â”‚   â”‚
â”‚  â”‚    â”‚      â”‚      2.4 æ”¶é›†å·¥å…·ç»“æœ                                       â”‚  â”‚   â”‚   â”‚
â”‚  â”‚    â”‚      â”‚      allToolResults.push(...toolResults)                   â”‚  â”‚   â”‚
â”‚  â”‚    â”‚      â”‚                                                          â”‚  â”‚   â”‚   â”‚
â”‚  â”‚    â”‚      â”‚      2.5 å°†å·¥å…·ç»“æœæ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨                         â”‚  â”‚   â”‚   â”‚
â”‚  â”‚    â”‚      â”‚      currentMessages.push(                              â”‚  â”‚   â”‚   â”‚
â”‚  â”‚    â”‚      â”‚        { role: "assistant", toolCalls: [...] },          â”‚  â”‚   â”‚   â”‚
â”‚  â”‚    â”‚      â”‚        { role: "user", toolResult: [...] }              â”‚  â”‚   â”‚   â”‚
â”‚  â”‚    â”‚      â”‚      )                                                 â”‚  â”‚   â”‚   â”‚
â”‚  â”‚    â”‚      â”‚                                                          â”‚  â”‚   â”‚   â”‚
â”‚  â”‚    â”‚      â”‚      2.6 ç»§ç»­å¾ªç¯ï¼Œè®© LLM æ ¹æ®å·¥å…·ç»“æœç”Ÿæˆæœ€ç»ˆå›å¤  â”‚  â”‚   â”‚   â”‚
â”‚  â”‚    â”‚      â”‚      continue                                          â”‚  â”‚   â”‚   â”‚
â”‚  â”‚    â”‚      â”‚                                                          â”‚  â”‚   â”‚   â”‚
â”‚  â”‚    â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚   â”‚
â”‚  â”‚    â”‚                                                                  â”‚  â”‚   â”‚
â”‚  â”‚    â”‚    } else {                                                         â”‚  â”‚   â”‚
â”‚  â”‚    â”‚      // æ²¡æœ‰å·¥å…·è°ƒç”¨ï¼Œè¿™æ˜¯æœ€ç»ˆå›å¤                               â”‚  â”‚   â”‚
â”‚  â”‚    â”‚      break;                                                   â”‚  â”‚   â”‚
â”‚  â”‚    â”‚    }                                                                 â”‚  â”‚   â”‚
â”‚  â”‚    â”‚                                                                  â”‚  â”‚   â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚  }                                                                   â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        æ­¥éª¤ 3: è‡ªåŠ¨ä¿å­˜å¯¹è¯                                â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  3.1 æ”¶é›†æ‰€æœ‰æ¶ˆæ¯ï¼ˆåŒ…æ‹¬ä¸­é—´æ¶ˆæ¯ï¼‰                                   â”‚   â”‚
â”‚  â”‚      messagesToSave = [                                                 â”‚   â”‚
â”‚  â”‚        ...history,                                                        â”‚   â”‚
â”‚  â”‚        ...allMessages,  // åŒ…å« tool_calls å’Œ tool_results              â”‚   â”‚
â”‚  â”‚      ]                                                                  â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  3.2 è‡ªåŠ¨å‹ç¼©ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœéœ€è¦ï¼‰                                     â”‚   â”‚
â”‚  â”‚      compressed = await compactIfNeeded(messagesToSave)                   â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  3.3 ä¿å­˜åˆ° Storage (SessionStore)                                    â”‚   â”‚
â”‚  â”‚      await storage.saveSession(sessionId, compressed)                       â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  3.4 å¼‚æ­¥ä¿å­˜åˆ° Memoryï¼ˆæ¯æ—¥æ—¥å¿—ï¼‰                                   â”‚   â”‚
â”‚  â”‚      setImmediate(async () => {                                        â”‚   â”‚
â”‚  â”‚        await memoryService.saveConversationMemory(messagesToSave)     â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚        // MemoryService å†…éƒ¨æµç¨‹ï¼š                                    â”‚   â”‚
â”‚  â”‚        â”œâ”€ æ ¼å¼åŒ–å¯¹è¯ä¸º Markdown                                       â”‚   â”‚
â”‚  â”‚        â”‚  "## Conversation Log - 2026-02-12T10:00:00"            â”‚   â”‚
â”‚  â”‚        â”œâ”€ è¿½åŠ åˆ° data/memory/2026-02-12.md                          â”‚   â”‚
â”‚  â”‚        â””â”€ è§¦å‘æ–‡ä»¶ç›‘å¬ï¼Œè‡ªåŠ¨æ›´æ–°ç´¢å¼•                              â”‚   â”‚
â”‚  â”‚      })                                                                â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        æ­¥éª¤ 4: è‡ªåŠ¨è§¦å‘åˆ·æ–°                                â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  4.1 ä¼°ç®— token ä½¿ç”¨é‡                                             â”‚   â”‚
â”‚  â”‚      estimatedTokens = estimateTokens(messagesToSave)                      â”‚   â”‚
â”‚  â”‚      // ä¿å®ˆç­–ç•¥ï¼š3 å­—ç¬¦ â‰ˆ 1 token                                   â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  4.2 æ£€æŸ¥æ˜¯å¦æ¥è¿‘è½¯é˜ˆå€¼                                         â”‚   â”‚
â”‚  â”‚      softThreshold = maxTokens - 20000                                 â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  4.3 å¦‚æœæ¥è¿‘é˜ˆå€¼ï¼Œè§¦å‘åˆ·æ–°                                         â”‚   â”‚
â”‚  â”‚      setImmediate(async () => {                                        â”‚   â”‚
â”‚  â”‚        await memoryService.maybeFlushMemory(                           â”‚   â”‚
â”‚  â”‚          estimatedTokens,                                            â”‚   â”‚
â”‚  â”‚          maxTokens                                                   â”‚   â”‚
â”‚  â”‚        )                                                                 â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚        // MemoryService å†…éƒ¨æµç¨‹ï¼š                                    â”‚   â”‚
â”‚  â”‚        â”œâ”€ æ£€æŸ¥å½“å‰ tokens > softThreshold                           â”‚   â”‚
â”‚  â”‚        â”œâ”€ è§¦å‘ç´¢å¼•æ›´æ–°ï¼ˆåŒæ­¥æ–°æ–‡ä»¶ï¼‰                               â”‚   â”‚
â”‚  â”‚        â””â”€ ä¼˜åŒ–æœç´¢æ€§èƒ½                                               â”‚   â”‚
â”‚  â”‚      })                                                                â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                              è¿”å›å“åº”ç»™ç”¨æˆ·
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·çœ‹åˆ°è‡ªåŠ¨ç”Ÿæˆçš„è®°å¿†æ–‡ä»¶                            â”‚
â”‚                                                                              â”‚
â”‚  data/memory/                                                                 â”‚
â”‚  â”œâ”€â”€ MEMORY.md              â† æ ¸å¿ƒé•¿æœŸè®°å¿†ï¼ˆé¡¹ç›®ã€ç”¨æˆ·åå¥½ï¼‰            â”‚
â”‚  â”œâ”€â”€ 2026-02-12.md         â† æ¯æ—¥å¯¹è¯æ—¥å¿—ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰âœ¨        â”‚
â”‚  â”œâ”€â”€ 2026-02-13.md         â† ç¬¬äºŒå¤©å¯¹è¯æ—¥å¿—ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰                  â”‚
â”‚  â””â”€â”€ ...                                                                 â”‚
â”‚                                                                              â”‚
â”‚ æ¯æ—¥æ—¥å¿—å†…å®¹ï¼š                                                                â”‚
â”‚   ---                                                                          â”‚
â”‚   ## Conversation Log - 2026-02-12T15:30:00                                    â”‚
â”‚                                                                              â”‚
â”‚   **USER**: å¸®æˆ‘å®ç° Memory Storage                                         â”‚
â”‚   **AI**: å¥½çš„ï¼Œæˆ‘æ¥å®ç°...                                                  â”‚
â”‚                                                                              â”‚
â”‚   **USER**: å¦‚ä½•è§¦å‘è®°å¿†ä¿å­˜ï¼Ÿ                                                 â”‚
â”‚   **AI**: å¯ä»¥å‚è€ƒ openclaw-cn-ds çš„è®¾è®¡...                                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” è¯¦ç»†æµç¨‹è¯´æ˜

### 1ï¸âƒ£ MemoryService åˆå§‹åŒ–æµç¨‹

```
AgentManager.start()
    â†“
åˆ›å»º MemoryService
    â†“
è®¾ç½®é…ç½®ï¼š
  - dataDir: "./data"
  - searchEnabled: true
  - autoSaveEnabled: true
  - maxSearchResults: 6
  - minScore: 0.35
    â†“
å¯åŠ¨æœåŠ¡ï¼š
  â”œâ”€ åˆ›å»º MemoryIndexManager
  â”œâ”€ åˆå§‹åŒ– SQLite æ•°æ®åº“ï¼ˆ.memory/index.sqliteï¼‰
  â”œâ”€ åŠ è½½ sqlite-vec æ‰©å±•
  â”œâ”€ ç¡®ä¿æ•°æ®åº“æ¶æ„
  â””â”€ å¯åŠ¨æ–‡ä»¶ç›‘å¬ï¼ˆchokidarï¼‰
    â†“
åˆå§‹åŒæ­¥ï¼š
  â”œâ”€ æ‰«æ data/memory/ ç›®å½•
  â”œâ”€ è¯»å–æ‰€æœ‰ .md æ–‡ä»¶
  â”œâ”€ æŒ‰ token æ•°åˆ†å—ï¼ˆ500 tokens/chunk, 50 overlapï¼‰
  â”œâ”€ ä¸ºæ¯ä¸ª chunk ç”Ÿæˆ embeddingï¼ˆOllama/OpenAIï¼‰
  â”œâ”€ å­˜å…¥æ•°æ®åº“ï¼ˆfiles, chunks, chunks_vecï¼‰
  â””â”€ åˆ›å»ºå‘é‡ç´¢å¼•
```

### 2ï¸âƒ£ è‡ªåŠ¨æ³¨å…¥è®°å¿†æµç¨‹

```
Agent.process(userMessage, sessionId)
    â†“
æå–æœ€è¿‘æ¶ˆæ¯ï¼ˆç”¨äºæœç´¢æŸ¥è¯¢ï¼‰
  â”œâ”€ è·å–å†å²æ¶ˆæ¯
  â”œâ”€ åˆ‡ç‰‡å–æœ€è¿‘ 5 æ¡
  â””â”€ æå–ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºæŸ¥è¯¢åŸºç¡€
    â†“
è°ƒç”¨ MemoryService.injectRelevantMemories()
    â†“
MemoryIndexManager.search(query)
    â”œâ”€ ä¼šè¯é¢„çƒ­ï¼ˆå¯é€‰ï¼‰
    â”‚  â””â”€ æ£€æŸ¥ sessionWarm Setï¼Œæœªé¢„çƒ­åˆ™å…ˆåŒæ­¥
    â”œâ”€ è‡ªåŠ¨åŒæ­¥ï¼ˆå¯é€‰ï¼‰
    â”‚  â””â”€ æ£€æŸ¥ dirty æ ‡å¿—ï¼Œæœ‰å˜åŒ–åˆ™åŒæ­¥
    â”œâ”€ ç”ŸæˆæŸ¥è¯¢çš„ embedding
    â”‚  â””â”€ è°ƒç”¨ embeddingProvider.embed(query)
    â”œâ”€ å‘é‡æœç´¢ï¼ˆsqlite-vecï¼‰
    â”‚  â”œâ”€ è®¡ç®— L2 è·ç¦»ï¼šdistance = ||queryVec - chunkVec||Â²
    â”‚  â”œâ”€ è½¬æ¢ä¸ºç›¸ä¼¼åº¦ï¼šscore = 1 / (1 + distance)
    â”‚  â””â”€ æŒ‰åˆ†æ•°æ’åºï¼Œè¿”å› Top-K
    â”œâ”€ å…¨æ–‡æœç´¢ï¼ˆFTS5ï¼Œå¯é€‰ï¼‰
    â”‚  â”œâ”€ ä½¿ç”¨ BM25 ç®—æ³•
    â”‚  â””â”€ è¿”å›å…³é”®è¯åŒ¹é…ç»“æœ
    â”œâ”€ åˆå¹¶ç»“æœï¼ˆæ··åˆæœç´¢ï¼‰
    â”‚  â”œâ”€ å½’ä¸€åŒ–åˆ†æ•°
    â”‚  â””â”€ åŠ æƒå¹³å‡ï¼šfinalScore = vecScore * 0.7 + textScore * 0.3
    â””â”€ è¿‡æ»¤ä½åˆ†ç»“æœï¼ˆminScore: 0.35ï¼‰
    â†“
æ„å»ºè®°å¿†ä¸Šä¸‹æ–‡
  â”œâ”€ æ ¼å¼åŒ–æ¯ä¸ªè®°å¿†ç‰‡æ®µ
  â”‚  â””â”€ [source:line](score)\n{snippet}
  â””â”€ ç”¨ "---" åˆ†éš”
    â†“
æ³¨å…¥åˆ°æ¶ˆæ¯åˆ—è¡¨
  â”œâ”€ åˆ›å»º system message
  â”‚  â””â”€ content: "[ç›¸å…³è®°å¿†]\n{memoryContext}\n[ä»¥ä¸Šæ˜¯ç›¸å…³çš„é•¿æœŸè®°å¿†]"
  â””â”€ æ’å…¥åˆ° messagesForLLM çš„å¼€å¤´
    â†“
é™çº§å¤„ç†
  â””â”€ å¦‚æœæ³¨å…¥å¤±è´¥ï¼Œä½¿ç”¨æ™®é€šæµç¨‹ï¼ˆä¸æ³¨å…¥è®°å¿†ï¼‰
```

### 3ï¸âƒ£ è‡ªåŠ¨ä¿å­˜å¯¹è¯æµç¨‹

```
å¯¹è¯å®Œæˆï¼ˆå·¥å…·è°ƒç”¨å¾ªç¯ç»“æŸï¼‰
    â†“
æ”¶é›†æ‰€æœ‰æ¶ˆæ¯
  â”œâ”€ å†å²æ¶ˆæ¯
  â”œâ”€ ç”¨æˆ·æ¶ˆæ¯
  â”œâ”€ Assistant æ¶ˆæ¯ï¼ˆåŒ…å« tool_callsï¼‰
  â””â”€ å·¥å…·ç»“æœæ¶ˆæ¯
    â†“
ä¿å­˜åˆ° SessionStorage
  â”œâ”€ è°ƒç”¨ storage.saveSession()
  â””â”€ æŒä¹…åŒ–åˆ° data/sessions/{sessionKey}.md
    â†“
å¼‚æ­¥ä¿å­˜åˆ° Memoryï¼ˆä¸é˜»å¡å“åº”ï¼‰
  setImmediate(async () => {
    â†“
    MemoryService.saveConversationMemory(messages)
      â†“
    æ ¼å¼åŒ–å¯¹è¯ä¸º Markdown
      â”œâ”€ æ ‡é¢˜ï¼š"## Conversation Log - {timestamp}"
      â”œâ”€ éå†æ¯æ¡æ¶ˆæ¯
      â”‚  â”œâ”€ **USER**: {content}
      â”‚  â””â”€ **AI**: {content}
      â””â”€ è¿½åŠ åˆ° data/memory/{YYYY-MM-DD}.md
        â†“
    æ–‡ä»¶å˜åŒ–è§¦å‘ chokidar ç›‘å¬
      â†“
    è‡ªåŠ¨æ›´æ–°ç´¢å¼•ï¼ˆ5 ç§’é˜²æŠ–ï¼‰
      â”œâ”€ æ£€æµ‹æ–‡ä»¶å˜åŒ–
      â”œâ”€ æ ‡è®° dirty = true
      â”œâ”€ 5 ç§’åæ‰§è¡Œ sync()
      â””â”€ é‡æ–°åˆ†å—å’Œç´¢å¼•æ–°å†…å®¹
  })
```

### 4ï¸âƒ£ è‡ªåŠ¨è§¦å‘åˆ·æ–°æµç¨‹

```
æ£€æŸ¥ token ä½¿ç”¨é‡
    â†“
ä¼°ç®— tokens
  â”œâ”€ ä¿å®ˆç­–ç•¥ï¼š3 å­—ç¬¦ â‰ˆ 1 token
  â””â”€ ç´¯è®¡æ‰€æœ‰æ¶ˆæ¯çš„å­—ç¬¦æ•°
    â†“
æ£€æŸ¥æ˜¯å¦æ¥è¿‘è½¯é˜ˆå€¼
  â”œâ”€ softThreshold = maxTokens - 20000
  â””â”€ ä¾‹å¦‚ï¼šmaxTokens = 200000ï¼Œåˆ™ softThreshold = 180000
    â†“
å¦‚æœè¶…è¿‡é˜ˆå€¼
  setImmediate(async () => {
    â†“
    MemoryService.maybeFlushMemory(currentTokens, maxTokens)
      â†“
    è§¦å‘ç´¢å¼•æ›´æ–°
      â”œâ”€ è°ƒç”¨ manager.sync()
      â”œâ”€ æ‰«æ memory æ–‡ä»¶
      â”œâ”€ æ£€æµ‹å˜åŒ–ï¼ˆhash å¯¹æ¯”ï¼‰
      â”œâ”€ åªç´¢å¼•å˜æ›´çš„æ–‡ä»¶ï¼ˆå¢é‡æ›´æ–°ï¼‰
      â””â”€ æ¸…ç†å·²åˆ é™¤æ–‡ä»¶çš„ç´¢å¼•
        â†“
    ä¼˜åŒ–æœç´¢æ€§èƒ½
      â””â”€ ç¡®ä¿æ–°å†…å®¹å¯è¢«æœç´¢åˆ°
  })
```

---

## ğŸ“‚ æ–‡ä»¶ç»“æ„

```
data/
â”œâ”€â”€ memory/                      â† Memory å­˜å‚¨ç›®å½•
â”‚   â”œâ”€â”€ .memory/               â† Memory å†…éƒ¨æ•°æ®
â”‚   â”‚   â””â”€â”€ index.sqlite      â† SQLite ç´¢å¼•æ•°æ®åº“
â”‚   â”‚
â”‚   â”œâ”€â”€ MEMORY.md             â† æ ¸å¿ƒé•¿æœŸè®°å¿†
â”‚   â”‚   â””â”€ é¡¹ç›®ç›®æ ‡ã€ç”¨æˆ·åå¥½ã€é‡è¦å†³ç­–
â”‚   â”‚
â”‚   â”œâ”€â”€ 2026-02-12.md        â† æ¯æ—¥å¯¹è¯æ—¥å¿— âœ¨ è‡ªåŠ¨ç”Ÿæˆ
â”‚   â”œâ”€â”€ 2026-02-13.md        â† ç¬¬äºŒå¤©å¯¹è¯æ—¥å¿—
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ sessions/                   â† Session å­˜å‚¨
    â””â”€â”€ user:123.md           â† ä¼šè¯å†å²
```

---

## ğŸ”„ æ–‡ä»¶ç›‘å¬å’Œè‡ªåŠ¨åŒæ­¥

```
chokidar ç›‘å¬ data/memory/
    â”œâ”€ ç›‘å¬æ–‡ä»¶ï¼šMEMORY.md, memory/, *.md
    â”œâ”€ äº‹ä»¶ï¼šadd, change, unlink
    â”‚
    â”œâ”€ é˜²æŠ–æœºåˆ¶
    â”‚  â”œâ”€ ç¨³å®šé˜ˆå€¼ï¼š100msï¼ˆæ–‡ä»¶å†™å…¥å®Œæˆï¼‰
    â”‚  â”œâ”€ è½®è¯¢é—´éš”ï¼š50ms
    â”‚  â””â”€ é˜²æŠ–å»¶è¿Ÿï¼š5000ms
    â”‚
    â”œâ”€ è§¦å‘åŒæ­¥
    â”‚  â”œâ”€ æ ‡è®° dirty = true
    â”‚  â””â”€ 5 ç§’åæ‰§è¡Œ sync()
    â”‚
    â””â”€ å¢é‡æ›´æ–°ç­–ç•¥
        â”œâ”€ åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
        â”œâ”€ è®¡ç®—æ¯ä¸ªæ–‡ä»¶çš„ hashï¼ˆSHA256ï¼‰
        â”œâ”€ å¯¹æ¯”æ•°æ®åº“ä¸­çš„ hash
        â”œâ”€ åªæ›´æ–° hash å˜æ›´çš„æ–‡ä»¶
        â””â”€ æ¸…ç†å·²åˆ é™¤æ–‡ä»¶çš„ç´¢å¼•
```

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### åœºæ™¯ 1ï¼šé¦–æ¬¡å¯¹è¯

```
Day 1 - 09:00
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User: "è®°ä½ï¼šæˆ‘å–œæ¬¢ TypeScript"                          â”‚
â”‚ AI: "å¥½çš„ï¼Œæˆ‘å·²ç»è®°ä½äº†ï¼"                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è‡ªåŠ¨ä¿å­˜åˆ° data/memory/2026-02-12.md
    â†“
Day 1 - 10:00
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User: "æˆ‘çš„æŠ€æœ¯æ ˆåå¥½æ˜¯ä»€ä¹ˆï¼Ÿ"                         â”‚
â”‚                                                          â”‚
â”‚ [Memory è‡ªåŠ¨æœç´¢]                                 â”‚
â”‚ â†’ æ‰¾åˆ°ï¼š"æˆ‘å–œæ¬¢ TypeScript"                           â”‚
â”‚ â†’ æ³¨å…¥åˆ°ä¸Šä¸‹æ–‡                                         â”‚
â”‚                                                          â”‚
â”‚ AI: "æ ¹æ®ä½ ä¹‹å‰å‘Šè¯‰æˆ‘çš„ï¼Œä½ å–œæ¬¢ä½¿ç”¨ TypeScript..."   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åœºæ™¯ 2ï¼šå¯¹è¯æ¥è¿‘ä¸Šä¸‹æ–‡é™åˆ¶

```
å½“å‰ tokens: 175000 / 200000
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User: "ç»§ç»­ä¹‹å‰çš„è®¨è®º..."                            â”‚
â”‚                                                          â”‚
â”‚ [Memory è‡ªåŠ¨æœç´¢]                                 â”‚
â”‚ â†’ æ‰¾åˆ°ç›¸å…³å†å²è®°å¿†                                     â”‚
â”‚ â†’ æ³¨å…¥åˆ°ä¸Šä¸‹æ–‡                                         â”‚
â”‚                                                          â”‚
â”‚ [å¯¹è¯ç»§ç»­...]                                          â”‚
â”‚                                                          â”‚
â”‚ [æ£€æµ‹ tokens > 180000]                             â”‚
â”‚ [è‡ªåŠ¨è§¦å‘ç´¢å¼•åˆ·æ–°]                                      â”‚
â”‚ â†’ é‡æ–°ç´¢å¼• memory æ–‡ä»¶                                  â”‚
â”‚ â†’ ä¼˜åŒ–æœç´¢æ€§èƒ½                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åœºæ™¯ 3ï¼šå¤šå¤©å¯¹è¯

```
data/memory/
â”œâ”€â”€ 2026-02-12.md
â”‚   â””â”€ ç¬¬ä¸€å¤©çš„æ‰€æœ‰å¯¹è¯
â”‚
â”œâ”€â”€ 2026-02-13.md              â† chokidar è‡ªåŠ¨æ£€æµ‹æ–°æ–‡ä»¶
â”‚   â””â”€ ç¬¬äºŒå¤©çš„æ‰€æœ‰å¯¹è¯
â”‚
â””â”€â”€ MEMORY.md
    â””â”€ è·¨å¤©çš„æ ¸å¿ƒè®°å¿†

â†’ æ‰€æœ‰æ–‡ä»¶è‡ªåŠ¨ç´¢å¼•ï¼Œå¯è¢«æœç´¢åˆ°
```

---

## ğŸ”§ é…ç½®é€‰é¡¹

### AgentManager é…ç½®

```typescript
const agentManager = new AgentManager({
  // Memory é…ç½®
  dataDir: "./data",          // Memory æ•°æ®ç›®å½•
  enableMemory: true,          // å¯ç”¨/ç¦ç”¨ Memoryï¼ˆé»˜è®¤ trueï¼‰

  // å…¶ä»–é…ç½®...
}, deps);
```

### MemoryService å†…éƒ¨é…ç½®

```typescript
new MemoryService({
  dataDir: "./data",
  searchEnabled: true,         // å¯ç”¨æœç´¢ï¼ˆé»˜è®¤ trueï¼‰
  autoSaveEnabled: true,       // å¯ç”¨è‡ªåŠ¨ä¿å­˜ï¼ˆé»˜è®¤ trueï¼‰
  maxSearchResults: 6,         // æœ€å¤§æœç´¢ç»“æœæ•°ï¼ˆé»˜è®¤ 6ï¼‰
  minScore: 0.35,            // æœ€ä½ç›¸å…³æ€§åˆ†æ•°ï¼ˆé»˜è®¤ 0.35ï¼‰
})
```

### MemoryIndexManager é«˜çº§é…ç½®

```typescript
new MemoryIndexManager({
  dbPath: "./memory.db",
  workspaceDir: "./workspace",
  embeddingProvider: new OllamaEmbeddingProvider(),
  chunkConfig: {
    tokens: 500,    // æ¯ chunk çº¦ 500 tokens
    overlap: 50,     // chunk ä¹‹é—´é‡å  50 tokens
  },
  config: {
    // åŒæ­¥é…ç½®
    sync: {
      onSearch: true,              // æœç´¢å‰è‡ªåŠ¨åŒæ­¥
      onSessionStart: true,         // ä¼šè¯å¯åŠ¨æ—¶é¢„çƒ­
      watch: true,                  // ç›‘æ§æ–‡ä»¶å˜åŒ–
      watchDebounceMs: 5000,        // é˜²æŠ–æ—¶é—´ï¼ˆ5ç§’ï¼‰
      intervalMinutes: 30,          // å®šæœŸåŒæ­¥ï¼ˆ30åˆ†é’Ÿï¼‰
    },
    // æŸ¥è¯¢é…ç½®
    query: {
      maxResults: 5,                // æœ€å¤§ç»“æœæ•°
      minScore: 0.5,                // æœ€ä½åˆ†æ•°
      hybrid: {
        enabled: true,              // å¯ç”¨æ··åˆæœç´¢
        vectorWeight: 0.7,          // å‘é‡æœç´¢æƒé‡
        textWeight: 0.3,            // å…³é”®è¯æœç´¢æƒé‡
      },
      highlight: {
        enabled: true,              // å¯ç”¨é«˜äº®
        prefix: "**",                // é«˜äº®å‰ç¼€
        suffix: "**",                // é«˜äº®åç¼€
        maxLength: 200,             // æœ€å¤§ç‰‡æ®µé•¿åº¦
      },
    },
  },
})
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. å¢é‡ç´¢å¼•

```
æ–‡ä»¶çº§åˆ«å“ˆå¸Œæ ¡éªŒï¼š
â”œâ”€ è®¡ç®—æ–‡ä»¶å†…å®¹çš„ SHA256
â”œâ”€ å¯¹æ¯”æ•°æ®åº“ä¸­çš„ hash
â”œâ”€ åªæ›´æ–° hash å˜æ›´çš„æ–‡ä»¶
â””â”€ è·³è¿‡æœªå˜æ›´çš„æ–‡ä»¶

æ€§èƒ½æå‡ï¼š
- é¦–æ¬¡ç´¢å¼•ï¼š100% æ–‡ä»¶éœ€è¦å¤„ç†
- åç»­æ›´æ–°ï¼šä»…å¤„ç†å˜æ›´æ–‡ä»¶ï¼ˆé€šå¸¸ < 10%ï¼‰
```

### 2. Embedding ç¼“å­˜

```
embedding_cache è¡¨ï¼š
â”œâ”€ provider (ollama/openai)
â”œâ”€ model (nomic-embed-text)
â”œâ”€ hash (SHA256 of text)
â”œâ”€ embedding (JSON vector)
â””â”€ updated_at (timestamp)

ç¼“å­˜ç­–ç•¥ï¼š
- ç›¸åŒå†…å®¹çš„ embedding ç›´æ¥ä»ç¼“å­˜è¯»å–
- é¿å…é‡å¤è°ƒç”¨ embedding API
- æ˜¾è‘—æå‡ç´¢å¼•é€Ÿåº¦
```

### 3. å¹¶å‘æ§åˆ¶

```
syncInProgress æ ‡å¿—ï¼š
â”œâ”€ é˜²æ­¢å¹¶å‘åŒæ­¥
â”œâ”€ é¿å…é‡å¤ç´¢å¼•
â””â”€ ä¿è¯æ•°æ®ä¸€è‡´æ€§

æ‰§è¡Œæµç¨‹ï¼š
if (syncInProgress) {
  return; // è·³è¿‡
}
syncInProgress = true;
try {
  await sync();
} finally {
  syncInProgress = false;
}
```

### 4. ä¼šè¯é¢„çƒ­ç¼“å­˜

```
sessionWarm Setï¼š
â”œâ”€ è®°å½•å·²é¢„çƒ­çš„ä¼šè¯ ID
â”œâ”€ é¿å…é‡å¤é¢„çƒ­
â””â”€ æå‡å“åº”é€Ÿåº¦

æµç¨‹ï¼š
if (sessionKey && sessionWarm.has(sessionKey)) {
  return; // å·²é¢„çƒ­ï¼Œè·³è¿‡
}
await sync({ reason: "session-start" });
sessionWarm.add(sessionKey);
```

---

## ğŸš¨ é”™è¯¯å¤„ç†

### 1. è®°å¿†æ³¨å…¥å¤±è´¥

```
try {
  enhanced = await memoryService.injectRelevantMemories(...);
} catch (error) {
  console.warn("[Agent] Memory injection failed:", error);
  // é™çº§åˆ°æ™®é€šæµç¨‹
  enhanced = [userMessage];
}
```

### 2. ä¿å­˜/åˆ·æ–°å¼‚æ­¥

```
setImmediate(async () => {
  try {
    await memoryService.saveConversationMemory(...);
  } catch (error) {
    console.error("[Agent] Failed to save conversation:", error);
    // ä¸é˜»å¡ä¸»æµç¨‹
  }
});
```

### 3. å‘é‡æœç´¢é™çº§

```
try {
  results = await searchVector(query);
} catch (error) {
  console.warn("Vector search failed:", error);
  // é™çº§åˆ°å…³é”®è¯æœç´¢æˆ–è¿”å›ç©ºç»“æœ
  results = await searchKeyword(query) ?? [];
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Memory Storage ä½¿ç”¨æŒ‡å—](./memory-storage-guide.md)
- [Memory ç³»ç»ŸæŒ‡å—](./memory-guide.md)
- [Memory å®ç°æŠ¥å‘Š](./memory-implementation-report.md)
- [Memory è§¦å‘æœºåˆ¶](./memory-trigger-mechanism.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-02-13
**ç»´æŠ¤è€…**: Claude Code
